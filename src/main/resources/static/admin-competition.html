<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理员-比赛管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#4080FF',
            success: '#00B42A',
            warning: '#FF7D00',
            danger: '#F53F3F',
            dark: '#1D2129',
            light: '#F2F3F5'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'card': '0 4px 20px rgba(0, 0, 0, 0.08)',
            'card-hover': '0 8px 30px rgba(0, 0, 0, 0.12)',
            'button': '0 2px 5px rgba(22, 93, 255, 0.3)',
            'button-hover': '0 4px 12px rgba(22, 93, 255, 0.4)',
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .sidebar-icon {
        @apply relative flex items-center justify-center h-12 w-12 mt-2 mb-2 mx-auto shadow-lg
        bg-white dark:bg-dark text-primary hover:bg-primary hover:text-white
        rounded-xl hover:rounded-2xl transition-all duration-300 ease-linear
        cursor-pointer;
      }
      .sidebar-tooltip {
        @apply absolute w-auto p-2 m-2 min-w-max left-14 rounded-md shadow-md
        text-white bg-primary text-xs font-bold
        transition-all duration-100 scale-0 origin-left;
      }
      .btn-primary {
        @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 shadow-button hover:shadow-button-hover transform hover:-translate-y-0.5;
      }
      .btn-secondary {
        @apply bg-light hover:bg-light/80 text-dark font-medium py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5;
      }
      .btn-danger {
        @apply bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5;
      }
      .btn-success {
        @apply bg-success hover:bg-success/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5;
      }
      .input-field {
        @apply w-full px-4 py-2.5 mt-2 text-dark bg-white border border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all duration-200;
      }
      .search-input {
        @apply pl-12;
      }
      .table-row {
        @apply hover:bg-light/50 transition-all duration-200;
      }
      .pagination-btn {
        @apply relative inline-flex items-center px-4 py-2 border text-sm font-medium;
      }
      .pagination-btn-active {
        @apply bg-primary text-white border-primary;
      }
      .pagination-btn-inactive {
        @apply bg-white text-gray-500 border-gray-300 hover:bg-gray-50;
      }
      .card {
        @apply bg-white rounded-xl shadow-card hover:shadow-card-hover transition-all duration-300 overflow-hidden;
      }
      .toast {
        @apply fixed top-4 right-4 max-w-xs w-full rounded-lg shadow-lg overflow-hidden transform transition-all duration-300 ease-in-out z-50 px-4 py-3 flex items-center;
      }
      .toast-success {
        @apply bg-white border-l-4 border-success;
      }
      .toast-error {
        @apply bg-white border-l-4 border-danger;
      }
      .toast-info {
        @apply bg-white border-l-4 border-primary;
      }
      .search-icon {
        @apply absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg;
      }
      .status-upcoming {
        @apply bg-blue-100 text-blue-800;
      }
      .status-ongoing {
        @apply bg-green-100 text-green-800;
      }
      .status-ended {
        @apply bg-gray-100 text-gray-800;
      }
      .datetime-input {
        @apply block w-full px-4 py-2.5 text-dark bg-white border border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all duration-200;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-inter text-dark antialiased">
<div class="flex h-screen overflow-hidden">
  <!-- Sidebar -->
  <div class="hidden md:flex flex-col w-16 bg-white shadow-lg">
    <div class="flex-1 flex flex-col pt-5 pb-4 overflow-y-auto">
      <div class="flex items-center justify-center h-16">
        <i class="fa fa-shield text-primary text-2xl"></i>
      </div>
      <nav class="mt-5 flex-1 px-2 space-y-1">
        <a href="admin-user.html" class="sidebar-icon group cursor-pointer">
          <i class="fa fa-users text-xl"></i>
          <span class="sidebar-tooltip group-hover:scale-100">用户管理</span>
        </a>
        <a href="admin-problem.html" class="sidebar-icon group cursor-pointer">
          <i class="fa fa-question-circle text-xl"></i>
          <span class="sidebar-tooltip group-hover:scale-100">题目管理</span>
        </a>
        <a href="admin-competition.html" class="sidebar-icon group cursor-pointer bg-primary text-white">
          <i class="fa fa-trophy text-xl"></i>
          <span class="sidebar-tooltip group-hover:scale-100">比赛管理</span>
        </a>
      </nav>
    </div>
  </div>

  <!-- Main content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Top navbar -->
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <button type="button" class="md:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-500 hover:text-primary hover:bg-gray-100 focus:outline-none transition-colors duration-200">
              <i class="fa fa-bars"></i>
            </button>
            <h1 class="ml-3 text-xl font-semibold">Vnollx在线评测系统 - 管理后台</h1>
          </div>
          <div class="flex items-center">
            <div class="ml-3 relative">
              <div>
                <button type="button" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                  <i class="fa fa-user-circle text-primary text-xl mr-2"></i>
                  <span class="font-medium">管理员</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Page content -->
    <main class="flex-1 overflow-y-auto bg-gray-50 p-6">
      <div class="max-w-7xl mx-auto">
        <!-- Page header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between md:space-x-6 lg:px-8 mb-8">
          <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
              比赛列表
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              管理系统中的所有比赛
            </p>
          </div>

          <div class="mt-4 flex md:mt-0 md:ml-4 space-x-3">
            <button id="add-competition-btn" class="btn-primary flex items-center">
              <i class="fa fa-plus mr-2"></i> 新建比赛
            </button>
            <button id="add-problem-to-competition-btn" class="btn-success flex items-center">
              <i class="fa fa-plus-circle mr-2"></i> 添加题目至比赛
            </button>
          </div>
        </div>

        <!-- Competition table -->
        <div class="mt-8 card">
          <div class="px-4 py-5 sm:p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between md:space-x-6">
              <div class="flex items-center mb-4 md:mb-0">
                <div class="relative w-full md:w-64">
                                    <span class="search-icon">
                                        <i class="fa fa-search"></i>
                                    </span>
                  <input type="text" id="search-input" placeholder="搜索比赛..." class="input-field search-input w-full">
                </div>
              </div>
              <div class="flex space-x-2">
                <button id="refresh-btn" class="btn-secondary flex items-center">
                  <i class="fa fa-refresh mr-2"></i> 刷新
                </button>
              </div>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  比赛编号
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  比赛标题
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  开始时间
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  结束时间
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  状态
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  是否需要密码
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  操作
                </th>
              </tr>
              </thead>
              <tbody id="competition-table-body" class="bg-white divide-y divide-gray-200">
              <!-- Competition rows will be dynamically inserted here -->
              </tbody>
            </table>
          </div>

          <div class="px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
              <div>
                <p class="text-sm text-gray-700">
                  显示 <span class="font-medium" id="showing-range-start">0</span> - <span class="font-medium" id="showing-range-end">0</span> 条，共 <span class="font-medium" id="total-count">0</span> 条记录
                </p>
              </div>
              <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination" id="pagination">
                  <!-- Pagination buttons will be dynamically inserted here -->
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Add/Edit Competition Modal -->
<div id="competition-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden transform transition-all scale-95 opacity-0" id="modal-content">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 id="modal-title" class="text-lg font-medium text-gray-900">新建比赛</h3>
    </div>
    <div class="px-6 py-4 overflow-y-auto max-h-[calc(90vh-120px)]">
      <form id="competition-form">
        <input type="hidden" id="competition-id">
        <div class="mb-4">
          <label for="competition-title" class="block text-sm font-medium text-gray-700">比赛标题 <span class="text-danger">*</span></label>
          <input type="text" id="competition-title" class="input-field" required>
        </div>

        <div class="mb-4">
          <label for="competition-description" class="block text-sm font-medium text-gray-700">比赛描述 <span class="text-danger">*</span></label>
          <textarea id="competition-description" rows="6" class="input-field" required></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label for="competition-begin-time" class="block text-sm font-medium text-gray-700">开始时间 <span class="text-danger">*</span></label>
            <input type="datetime-local" id="competition-begin-time" class="datetime-input" required>
          </div>
          <div>
            <label for="competition-end-time" class="block text-sm font-medium text-gray-700">结束时间 <span class="text-danger">*</span></label>
            <input type="datetime-local" id="competition-end-time" class="datetime-input" required>
          </div>
        </div>

        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="competition-need-password" class="mt-1 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
            <span class="ml-2 text-sm text-gray-700">需要密码</span>
          </label>
        </div>

        <div class="mb-4 hidden" id="password-field">
          <label for="competition-password" class="block text-sm font-medium text-gray-700">比赛密码 <span class="text-danger">*</span></label>
          <input type="text" id="competition-password" class="input-field">
        </div>

        <!-- 题目管理区域 -->
        <div class="mb-4" id="problem-management-section" style="display: none;">
          <label class="block text-sm font-medium text-gray-700 mb-2">比赛题目管理</label>
          <div class="border border-gray-300 rounded-lg p-4">
            <div class="flex justify-between items-center mb-3">
              <div class="flex items-center space-x-3">
                <h4 class="text-sm font-medium text-gray-900">已添加的题目</h4>
                <span id="selected-problems-count" class="text-xs text-gray-500">已选择 0 个题目</span>
              </div>
              <div class="flex space-x-2">
                <button type="button" id="batch-delete-problems-btn" class="btn-danger text-xs py-1 px-2" disabled>
                  <i class="fa fa-trash mr-1"></i> 批量删除
                </button>
                <button type="button" id="add-problem-to-edit-btn" class="btn-primary text-xs py-1 px-2">
                  <i class="fa fa-plus mr-1"></i> 添加题目
                </button>
              </div>
            </div>
            <div id="competition-problems-list" class="space-y-2 max-h-40 overflow-y-auto">
              <!-- 比赛题目列表将通过JS动态加载 -->
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
      <button id="cancel-modal" class="btn-secondary">取消</button>
      <button id="save-competition" class="btn-primary">保存</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl max-w-md w-full overflow-hidden transform transition-all scale-95 opacity-0" id="delete-modal-content">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">确认删除</h3>
    </div>
    <div class="px-6 py-4">
      <p class="text-sm text-gray-700">
        你确定要删除比赛 <span id="delete-title" class="font-medium"></span> 吗？此操作无法撤销，将同时删除相关的所有数据。
      </p>
    </div>
    <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
      <button id="cancel-delete" class="btn-secondary">取消</button>
      <button id="confirm-delete" class="btn-danger">删除</button>
    </div>
  </div>
</div>

<!-- Delete Problems Confirmation Modal -->
<div id="delete-problems-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl max-w-lg w-full overflow-hidden transform transition-all scale-95 opacity-0" id="delete-problems-modal-content">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">确认删除题目</h3>
    </div>
    <div class="px-6 py-4">
      <div class="flex items-center mb-4">
        <div class="flex-shrink-0">
          <i class="fa fa-exclamation-triangle text-warning text-2xl"></i>
        </div>
        <div class="ml-3">
          <h4 class="text-sm font-medium text-gray-900">确定要删除以下题目吗？</h4>
          <p class="text-sm text-gray-500 mt-1">此操作无法撤销，题目将从比赛中永久移除。</p>
        </div>
      </div>
      <div id="problems-to-delete-list" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
        <!-- 要删除的题目列表 -->
      </div>
    </div>
    <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
      <button id="cancel-delete-problems" class="btn-secondary">取消</button>
      <button id="confirm-delete-problems" class="btn-danger">确认删除</button>
    </div>
  </div>
</div>
<div id="add-problem-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden transform transition-all scale-95 opacity-0" id="add-problem-modal-content">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">添加题目至比赛</h3>
    </div>
    <div class="px-6 py-4 overflow-y-auto max-h-[calc(90vh-120px)]">
      <form id="add-problem-form">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">选择比赛 <span class="text-danger">*</span></label>
          <div class="relative">
            <div id="competition-dropdown" class="input-field cursor-pointer flex items-center justify-between" onclick="toggleCompetitionDropdown()">
              <span id="competition-selected-text">-- 请选择比赛 --</span>
              <i class="fa fa-chevron-down text-gray-400 transition-transform duration-200" id="competition-dropdown-icon"></i>
            </div>
            <div id="competition-dropdown-menu" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-60 overflow-y-auto">
              <!-- 比赛选项将通过JS动态加载 -->
            </div>
            <input type="hidden" id="competition-select" required>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">选择题目 <span class="text-danger">*</span></label>
          <div class="border border-gray-300 rounded-lg p-4 max-h-80 overflow-y-auto">
            <div class="mb-3">
              <input type="text" id="problem-search" placeholder="搜索题目..." class="input-field w-full">
            </div>
            <div id="problem-list" class="space-y-2">
              <!-- 题目列表将通过JS动态加载 -->
            </div>
          </div>
          <div class="mt-2 text-sm text-gray-500">
            已选择 <span id="selected-count">0</span> 个题目
          </div>
        </div>
      </form>
    </div>
    <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
      <button id="cancel-add-problem" class="btn-secondary">取消</button>
      <button id="confirm-add-problem" class="btn-success">批量添加</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

<script>
  // DOM elements
  const competitionTableBody = document.getElementById('competition-table-body');
  const addCompetitionBtn = document.getElementById('add-competition-btn');
  const competitionModal = document.getElementById('competition-modal');
  const modalContent = document.getElementById('modal-content');
  const deleteModal = document.getElementById('delete-modal');
  const deleteModalContent = document.getElementById('delete-modal-content');
  const cancelModal = document.getElementById('cancel-modal');
  const saveCompetitionBtn = document.getElementById('save-competition');
  const competitionForm = document.getElementById('competition-form');
  const modalTitle = document.getElementById('modal-title');
  const cancelDelete = document.getElementById('cancel-delete');
  const confirmDelete = document.getElementById('confirm-delete');
  const deleteTitle = document.getElementById('delete-title');
  const searchInput = document.getElementById('search-input');
  const refreshBtn = document.getElementById('refresh-btn');
  const toastContainer = document.getElementById('toast-container');
  const showingRangeStart = document.getElementById('showing-range-start');
  const showingRangeEnd = document.getElementById('showing-range-end');
  const totalCount = document.getElementById('total-count');
  const pagination = document.getElementById('pagination');
  const needPasswordCheckbox = document.getElementById('competition-need-password');
  const passwordField = document.getElementById('password-field');
  const passwordInput = document.getElementById('competition-password');
  const addProblemToCompetitionBtn = document.getElementById('add-problem-to-competition-btn');
  const addProblemModal = document.getElementById('add-problem-modal');
  const addProblemModalContent = document.getElementById('add-problem-modal-content');
  const cancelAddProblem = document.getElementById('cancel-add-problem');
  const confirmAddProblem = document.getElementById('confirm-add-problem');
  const addProblemForm = document.getElementById('add-problem-form');
  const problemIdInput = document.getElementById('problem-id');
  const competitionSelect = document.getElementById('competition-select');
  const competitionDropdown = document.getElementById('competition-dropdown');
  const competitionSelectedText = document.getElementById('competition-selected-text');
  const competitionDropdownMenu = document.getElementById('competition-dropdown-menu');
  const competitionDropdownIcon = document.getElementById('competition-dropdown-icon');
  const problemSearchInput = document.getElementById('problem-search');
  const problemList = document.getElementById('problem-list');
  const selectedCountSpan = document.getElementById('selected-count');
  const problemManagementSection = document.getElementById('problem-management-section');
  const competitionProblemsList = document.getElementById('competition-problems-list');
  const addProblemToEditBtn = document.getElementById('add-problem-to-edit-btn');
  const selectedProblemsCount = document.getElementById('selected-problems-count');
  const batchDeleteProblemsBtn = document.getElementById('batch-delete-problems-btn');
  const deleteProblemsModal = document.getElementById('delete-problems-modal');
  const deleteProblemsModalContent = document.getElementById('delete-problems-modal-content');
  const cancelDeleteProblems = document.getElementById('cancel-delete-problems');
  const confirmDeleteProblems = document.getElementById('confirm-delete-problems');
  const problemsToDeleteList = document.getElementById('problems-to-delete-list');
  // Pagination variables
  let currentPage = 1;
  const pageSize = 10; // Number of items per page
  let totalCompetitions = 0;
  let currentCompetitionId = null;
  let currentKeyword = '';
  let competitions = [];
  let allProblems = [];
  let selectedProblems = new Set();
  let competitionProblems = [];
  let selectedCompetitionProblems = new Set();

  // Initialize the page
  document.addEventListener('DOMContentLoaded', () => {
    fetchCompetitionCount().then(() => {
      fetchCompetitions();
    });

    // Event listeners
    addCompetitionBtn.addEventListener('click', openAddCompetitionModal);
    cancelModal.addEventListener('click', closeCompetitionModal);
    saveCompetitionBtn.addEventListener('click', saveCompetition);
    cancelDelete.addEventListener('click', closeDeleteModal);
    confirmDelete.addEventListener('click', deleteCompetition);
    refreshBtn.addEventListener('click', () => {
      currentPage = 1;
      currentKeyword = '';
      searchInput.value = '';
      fetchCompetitions();
      fetchCompetitionCount();
    });
    // 添加题目至比赛按钮点击事件
    addProblemToCompetitionBtn.addEventListener('click', openAddProblemModal);
    cancelAddProblem.addEventListener('click', closeAddProblemModal);
    confirmAddProblem.addEventListener('click', addProblemToCompetition);
    
    // 编辑比赛中的添加题目按钮
    addProblemToEditBtn.addEventListener('click', openAddProblemModalForEdit);
    
    // 批量删除题目按钮
    batchDeleteProblemsBtn.addEventListener('click', openBatchDeleteProblemsModal);
    cancelDeleteProblems.addEventListener('click', closeDeleteProblemsModal);

    // 点击外部关闭比赛下拉框
    document.addEventListener('click', (e) => {
      if (!competitionDropdown.contains(e.target)) {
        closeCompetitionDropdown();
      }
    });

    // Need password checkbox
    needPasswordCheckbox.addEventListener('change', (e) => {
      if (e.target.checked) {
        passwordField.classList.remove('hidden');
        passwordInput.required = true;
      } else {
        passwordField.classList.add('hidden');
        passwordInput.required = false;
      }
    });

    // Debounce search input
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentKeyword = searchInput.value.trim();
        currentPage = 1;
        fetchCompetitions();
        fetchCompetitionCount();
      }, 500);
    });

    // Problem search input
    let problemSearchTimeout;
    problemSearchInput.addEventListener('input', () => {
      clearTimeout(problemSearchTimeout);
      problemSearchTimeout = setTimeout(() => {
        filterProblems();
      }, 300);
    });
  });

  // Show toast notification
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type} opacity-0 transform translate-x-full transition-all duration-300`;

    let iconClass = '';
    switch(type) {
      case 'success':
        iconClass = 'fa-check-circle text-success';
        break;
      case 'error':
        iconClass = 'fa-exclamation-circle text-danger';
        break;
      case 'info':
        iconClass = 'fa-info-circle text-primary';
        break;
      default:
        iconClass = 'fa-check-circle text-success';
    }

    toast.innerHTML = `
            <i class="fa ${iconClass} mr-3 text-xl"></i>
            <p class="text-sm text-gray-800">${message}</p>
        `;

    toastContainer.appendChild(toast);

    // Animate in
    setTimeout(() => {
      toast.classList.remove('opacity-0', 'translate-x-full');
    }, 10);

    // Remove after 3 seconds
    setTimeout(() => {
      toast.classList.add('opacity-0', 'translate-x-full');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 3000);
  }

  // Fetch competitions from API
  function fetchCompetitions() {
    // Show loading state
    competitionTableBody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-12 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
                    <p class="mt-2 text-sm text-gray-500">加载比赛数据中...</p>
                </td>
            </tr>
        `;

    const params = new URLSearchParams({
      pageNum: currentPage ,
      pageSize: pageSize,
      keyword: currentKeyword
    });

    fetch(`/admin/competition/list?${params.toString()}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                competitions = data.data;
                renderCompetitions(competitions);
                updateShowingRange();
                renderPagination();
              } else {
                showToast('获取比赛列表失败: ' + (data.msg || '未知错误'), 'error');
              }
            })
            .catch(error => {
              console.error('Error fetching competitions:', error);
              showToast('网络错误，请重试', 'error');
            });
  }

  // Fetch total competition count
  function fetchCompetitionCount() {
    return new Promise((resolve, reject) => {
      const params = new URLSearchParams({
        keyword: currentKeyword
      });

      fetch(`/admin/competition/count?${params.toString()}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
              .then(response => response.json())
              .then(data => {
                if (data.code === 200) {
                  totalCompetitions = data.data;
                  totalCount.textContent = totalCompetitions;
                  renderPagination();
                  updateShowingRange();
                  resolve();
                } else {
                  showToast(data.msg || '获取比赛总数失败', 'error');
                  reject(data.msg || '获取比赛总数失败');
                }
              })
              .catch(error => {
                showToast('网络错误，请重试', 'error');
                reject('网络错误，请重试');
              });
    });
  }

  // Update showing range text
  function updateShowingRange() {
    if (totalCompetitions === 0) {
      showingRangeStart.textContent = '0';
      showingRangeEnd.textContent = '0';
      return;
    }
    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, totalCompetitions);
    showingRangeStart.textContent = start;
    showingRangeEnd.textContent = end;
  }

  // Render pagination buttons
  function renderPagination() {
    if (totalCompetitions <= pageSize) {
      pagination.innerHTML = '';
      return;
    }

    const totalPages = Math.ceil(totalCompetitions / pageSize);
    let paginationHTML = '';

    // Previous button
    paginationHTML += `
            <button onclick="changePage(${currentPage - 1})"
                ${currentPage === 1 ? 'disabled' : ''}
                class="pagination-btn pagination-btn-inactive rounded-l-md">
                <i class="fa fa-chevron-left text-xs"></i>
            </button>
        `;

    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
      paginationHTML += `
                <button onclick="changePage(1)"
                    class="pagination-btn pagination-btn-inactive">
                    1
                </button>
                ${startPage > 2 ? '<span class="px-2 py-2">...</span>' : ''}
            `;
    }

    for (let i = startPage; i <= endPage; i++) {
      paginationHTML += `
                <button onclick="changePage(${i})"
                    ${i === currentPage ? 'class="pagination-btn pagination-btn-active"' : 'class="pagination-btn pagination-btn-inactive"'}>
                    ${i}
                </button>
            `;
    }

    if (endPage < totalPages) {
      paginationHTML += `
                ${endPage < totalPages - 1 ? '<span class="px-2 py-2">...</span>' : ''}
                <button onclick="changePage(${totalPages})"
                    class="pagination-btn pagination-btn-inactive">
                    ${totalPages}
                </button>
            `;
    }

    // Next button
    paginationHTML += `
            <button onclick="changePage(${currentPage + 1})"
                ${currentPage === totalPages ? 'disabled' : ''}
                class="pagination-btn pagination-btn-inactive rounded-r-md">
                <i class="fa fa-chevron-right text-xs"></i>
            </button>
        `;

    pagination.innerHTML = paginationHTML;
  }

  // Change page function
  async function changePage(newPage) {
    try {
      const totalPages = Math.ceil(totalCompetitions / pageSize);

      if (newPage < 1 || newPage > totalPages) return;

      currentPage = newPage;
      await fetchCompetitions();
      renderPagination();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (error) {
      showToast(error, 'error');
    }
  }

  // Render competitions in the table
  function renderCompetitions(competitions) {
    if (competitions.length === 0) {
      competitionTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center">
                        <i class="fa fa-search text-gray-300 text-4xl mb-3"></i>
                        <p class="text-sm text-gray-500">未找到比赛记录</p>
                    </td>
                </tr>
            `;
      return;
    }

    competitionTableBody.innerHTML = competitions.map(competition => {
      const now = new Date();
      const beginTime = new Date(competition.beginTime);
      const endTime = new Date(competition.endTime);

      let status = '';
      let statusClass = '';

      if (now < beginTime) {
        status = '未开始';
        statusClass = 'status-upcoming';
      } else if (now >= beginTime && now <= endTime) {
        status = '进行中';
        statusClass = 'status-ongoing';
      } else {
        status = '已结束';
        statusClass = 'status-ended';
      }

      return `
                <tr class="table-row">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${competition.id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${competition.title}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDateTime(competition.beginTime)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDateTime(competition.endTime)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${competition.needPassword ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">
                            ${competition.needPassword ? '需要密码' : '无需密码'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-primary hover:text-primary/80 mr-3 edit-competition transition-colors duration-200" data-id="${competition.id}">
                            <i class="fa fa-pencil mr-1"></i> 编辑
                        </button>
                        <button class="text-danger hover:text-danger/80 delete-competition transition-colors duration-200" data-id="${competition.id}" data-title="${competition.title}">
                            <i class="fa fa-trash mr-1"></i> 删除
                        </button>
                    </td>
                </tr>
            `;
    }).join('');

    // Add event listeners
    document.querySelectorAll('.edit-competition').forEach(btn => {
      btn.addEventListener('click', () => {
        const competitionId = parseInt(btn.getAttribute('data-id'));
        openEditCompetitionModal(competitionId);
      });
    });

    document.querySelectorAll('.delete-competition').forEach(btn => {
      btn.addEventListener('click', () => {
        const competitionId = parseInt(btn.getAttribute('data-id'));
        const competitionTitle = btn.getAttribute('data-title');
        openDeleteModal(competitionId, competitionTitle);
      });
    });
  }

  // Format datetime for display
  function formatDateTime(datetimeStr) {
    if (!datetimeStr) return '';

    // 处理ISO格式（2025-07-26T09:23:00.000Z）或数据库格式（2025-07-26 18:05:00）
    const date = new Date(datetimeStr);

    // 如果解析失败，尝试手动处理
    if (isNaN(date.getTime())) {
      // 尝试处理数据库格式（2025-07-26 18:05:00）
      const [datePart, timePart] = datetimeStr.split(' ');
      if (datePart && timePart) {
        return datetimeStr; // 已经是正确格式，直接返回
      }
      return '无效时间';
    }

    // 格式化为 YYYY-MM-DD HH:mm:ss
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
  }

  // Open add competition modal
  function openAddCompetitionModal() {
    modalTitle.textContent = '新建比赛';
    competitionForm.reset();
    document.getElementById('competition-id').value = '';
    passwordField.classList.add('hidden');
    passwordInput.required = false;

    // 隐藏题目管理区域
    problemManagementSection.style.display = 'none';

    // Set default times (now and 2 hours later)
    const now = new Date();
    const later = new Date(now.getTime() + 2 * 60 * 60 * 1000);

    document.getElementById('competition-begin-time').value = formatDateTimeForInput(now);
    document.getElementById('competition-end-time').value = formatDateTimeForInput(later);

    competitionModal.classList.remove('hidden');

    // Animate modal in
    setTimeout(() => {
      modalContent.classList.remove('scale-95', 'opacity-0');
      modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);

    document.getElementById('competition-title').focus();
  }

  // Format datetime for input[type=datetime-local]
  function formatDateTimeForInput(datetimeStr) {
    if (!datetimeStr) return '';



    // 处理ISO格式
    const date = new Date(datetimeStr);
    if (isNaN(date.getTime())) return '';

    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');

    return `${year}-${month}-${day}T${hours}:${minutes}`;
  }

  // Open edit competition modal
  function openEditCompetitionModal(competitionId) {
    const competition = competitions.find(c => c.id === competitionId);
    if (!competition) return;

    currentCompetitionId = competitionId;
    modalTitle.textContent = '编辑比赛';
    document.getElementById('competition-id').value = competition.id;
    document.getElementById('competition-title').value = competition.title;
    document.getElementById('competition-description').value = competition.description;
    document.getElementById('competition-begin-time').value = formatDateTimeForInput(competition.beginTime);
    document.getElementById('competition-end-time').value = formatDateTimeForInput(competition.endTime);
    document.getElementById('competition-need-password').checked = competition.needPassword;

    if (competition.needPassword) {
      passwordField.classList.remove('hidden');
      document.getElementById('competition-password').value = competition.password;
      passwordInput.required = true;
    } else {
      passwordField.classList.add('hidden');
      passwordInput.required = false;
    }

    // 显示题目管理区域并加载比赛题目
    problemManagementSection.style.display = 'block';
    selectedCompetitionProblems.clear();
    updateSelectedCompetitionProblemsCount();
    fetchCompetitionProblems(competitionId);

    competitionModal.classList.remove('hidden');

    // Animate modal in
    setTimeout(() => {
      modalContent.classList.remove('scale-95', 'opacity-0');
      modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
  }

  // Close competition modal
  function closeCompetitionModal() {
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');

    // Hide modal after animation
    setTimeout(() => {
      competitionModal.classList.add('hidden');
      currentCompetitionId = null;
    }, 300);
  }

  // Open delete modal
  function openDeleteModal(competitionId, competitionTitle) {
    currentCompetitionId = competitionId;
    deleteTitle.textContent = competitionTitle;
    deleteModal.classList.remove('hidden');

    // Animate modal in
    setTimeout(() => {
      deleteModalContent.classList.remove('scale-95', 'opacity-0');
      deleteModalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
  }

  // Close delete modal
  function closeDeleteModal() {
    deleteModalContent.classList.remove('scale-100', 'opacity-100');
    deleteModalContent.classList.add('scale-95', 'opacity-0');

    // Hide modal after animation
    setTimeout(() => {
      deleteModal.classList.add('hidden');
      currentCompetitionId = null;
    }, 300);
  }

  // Save competition (add or edit)
  function saveCompetition() {
    const id = document.getElementById('competition-id').value;
    const title = document.getElementById('competition-title').value.trim();
    const description = document.getElementById('competition-description').value.trim();
    const beginTimeInput = document.getElementById('competition-begin-time').value;
    const endTimeInput = document.getElementById('competition-end-time').value;

    // 将datetime-local格式(YYYY-MM-DDTHH:mm)转换为数据库格式(YYYY-MM-DD HH:mm:ss)
    const beginTime = beginTimeInput ? beginTimeInput.replace('T', ' ') + ':00' : null;
    const endTime = endTimeInput ? endTimeInput.replace('T', ' ') + ':00' : null;
    const needPassword = document.getElementById('competition-need-password').checked;
    const password = document.getElementById('competition-password').value;

    // Basic validation
    if (!title) {
      showToast('请输入比赛标题', 'error');
      return;
    }
    if (!description) {
      showToast('请输入比赛描述', 'error');
      return;
    }
    if (!beginTime) {
      showToast('请选择开始时间', 'error');
      return;
    }
    if (!endTime) {
      showToast('请选择结束时间', 'error');
      return;
    }
    if (new Date(beginTime) >= new Date(endTime)) {
      showToast('结束时间必须晚于开始时间', 'error');
      return;
    }
    if (needPassword && !password) {
      showToast('请输入比赛密码', 'error');
      return;
    }

    const competitionData = {
      id: id || null,
      title,
      description,
      beginTime: beginTime,
      endTime: endTime,
      needPassword,
      password: needPassword ? password : null
    };

    const url = id ? '/admin/competition/update' : '/admin/competition/create';
    const method = id ? 'PUT' : 'POST';

    fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify(competitionData)
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                showToast(id ? '比赛更新成功' : '比赛创建成功', 'success');
                closeCompetitionModal();

                // Refresh data
                currentPage = 1;
                fetchCompetitions();
                fetchCompetitionCount();
              } else {
                showToast(data.msg || '操作失败', 'error');
              }
            })
            .catch(error => {
              console.error('Error saving competition:', error);
              showToast('网络错误，请重试', 'error');
            });
  }

  // Delete competition
  function deleteCompetition() {
    if (!currentCompetitionId) return;

    fetch(`/admin/competition/delete/${currentCompetitionId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                showToast('比赛删除成功', 'success');
                closeDeleteModal();

                // Check if we need to go back a page
                if (competitions.length === 1 && currentPage > 1) {
                  currentPage--;
                }

                fetchCompetitions();
                fetchCompetitionCount();
              } else {
                showToast(data.msg || '删除失败', 'error');
              }
            })
            .catch(error => {
              console.error('Error deleting competition:', error);
              showToast('网络错误，请重试', 'error');
            });
  }
  // 打开添加题目至比赛模态框
  function openAddProblemModal() {
    // 清空表单
    addProblemForm.reset();
    selectedProblems.clear();
    selectedCountSpan.textContent = '0';
    
    // 重置比赛选择
    competitionSelect.value = '';
    competitionSelectedText.textContent = '-- 请选择比赛 --';
    closeCompetitionDropdown();

    // 加载比赛列表和题目列表
    Promise.all([
      fetchCompetitionsForSelect(),
      fetchAllProblems()
    ]).then(() => {
      addProblemModal.classList.remove('hidden');

      // 动画效果
      setTimeout(() => {
        addProblemModalContent.classList.remove('scale-95', 'opacity-0');
        addProblemModalContent.classList.add('scale-100', 'opacity-100');
      }, 10);

      competitionDropdown.focus();
    }).catch(error => {
      showToast('加载数据失败: ' + error, 'error');
    });
  }

  // 关闭添加题目至比赛模态框
  function closeAddProblemModal() {
    addProblemModalContent.classList.remove('scale-100', 'opacity-100');
    addProblemModalContent.classList.add('scale-95', 'opacity-0');

    setTimeout(() => {
      addProblemModal.classList.add('hidden');
      // 重置比赛选择框状态
      closeCompetitionDropdown();
    }, 300);
  }

  // 获取比赛列表用于选择
  function fetchCompetitionsForSelect() {
    return new Promise((resolve, reject) => {
      fetch('/admin/competition/list?pageNum=1&pageSize=1000', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
              .then(response => response.json())
              .then(data => {
                if (data.code === 200) {
                  // 清空现有选项
                  competitionDropdownMenu.innerHTML = '';

                  // 添加比赛选项
                  data.data.forEach(competition => {
                    const option = document.createElement('div');
                    option.className = 'px-4 py-3 hover:bg-gray-100 cursor-pointer transition-colors duration-200 border-b border-gray-100 last:border-b-0';
                    option.innerHTML = `
                      <div class="text-sm font-medium text-gray-900">${competition.id} - ${competition.title}</div>
                      <div class="text-xs text-gray-500 mt-1">${competition.description ? competition.description.substring(0, 50) + '...' : '暂无描述'}</div>
                    `;
                    option.onclick = () => selectCompetition(competition.id, `${competition.id} - ${competition.title}`);
                    competitionDropdownMenu.appendChild(option);
                  });
                  resolve();
                } else {
                  reject(data.msg || '获取比赛列表失败');
                }
              })
              .catch(error => {
                reject('网络错误: ' + error);
              });
    });
  }

  // 获取所有题目
  function fetchAllProblems() {
    return new Promise((resolve, reject) => {
      fetch('/admin/competition/problems', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
              .then(response => response.json())
              .then(data => {
                if (data.code === 200) {
                  allProblems = data.data;
                  renderProblems();
                  resolve();
                } else {
                  reject(data.msg || '获取题目列表失败');
                }
              })
              .catch(error => {
                reject('网络错误: ' + error);
              });
    });
  }

  // 渲染题目列表
  function renderProblems(problems = allProblems) {
    if (problems.length === 0) {
      problemList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无题目</div>';
      return;
    }

    problemList.innerHTML = problems.map(problem => {
      const isSelected = selectedProblems.has(problem.id.toString());
      return `
        <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
          <input type="checkbox" 
                 id="problem-${problem.id}" 
                 value="${problem.id}" 
                 ${isSelected ? 'checked' : ''}
                 class="problem-checkbox h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
          <label for="problem-${problem.id}" class="ml-3 flex-1 cursor-pointer">
            <div class="text-sm font-medium text-gray-900">${problem.id} - ${problem.title}</div>
            <div class="text-xs text-gray-500">难度: ${problem.difficulty || '未知'}</div>
          </label>
        </div>
      `;
    }).join('');

    // 添加复选框事件监听器
    document.querySelectorAll('.problem-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const problemId = e.target.value;
        if (e.target.checked) {
          selectedProblems.add(problemId);
        } else {
          selectedProblems.delete(problemId);
        }
        updateSelectedCount();
      });
    });
  }

  // 过滤题目
  function filterProblems() {
    const searchTerm = problemSearchInput.value.toLowerCase().trim();
    if (!searchTerm) {
      renderProblems();
      return;
    }

    const filteredProblems = allProblems.filter(problem => 
      problem.title.toLowerCase().includes(searchTerm) ||
      problem.id.toString().includes(searchTerm)
    );
    renderProblems(filteredProblems);
  }

  // 更新已选择题目数量
  function updateSelectedCount() {
    selectedCountSpan.textContent = selectedProblems.size;
  }

  // 添加题目至比赛
  function addProblemToCompetition() {
    const competitionId = competitionSelect.value;

    // 验证输入
    if (!competitionId) {
      showToast('请选择比赛', 'error');
      return;
    }
    if (selectedProblems.size === 0) {
      showToast('请至少选择一个题目', 'error');
      return;
    }

    // 发送批量添加请求
    fetch('/admin/competition/add/problems/batch', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({
        cid: competitionId,
        pids: Array.from(selectedProblems)
      })
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                showToast(`成功添加 ${selectedProblems.size} 个题目`, 'success');
                closeAddProblemModal();
              } else {
                showToast(data.msg || '添加题目失败', 'error');
              }
            })
            .catch(error => {
              console.error('Error adding problems to competition:', error);
              showToast('网络错误，请重试', 'error');
            });
  }

  // 获取比赛题目列表
  function fetchCompetitionProblems(competitionId) {
    fetch(`/admin/competition/${competitionId}/problems`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                competitionProblems = data.data;
                renderCompetitionProblems();
              } else {
                showToast(data.msg || '获取比赛题目失败', 'error');
              }
            })
            .catch(error => {
              console.error('Error fetching competition problems:', error);
              showToast('网络错误，请重试', 'error');
            });
  }

  // 渲染比赛题目列表
  function renderCompetitionProblems() {
    if (competitionProblems.length === 0) {
      competitionProblemsList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无题目</div>';
      return;
    }

    competitionProblemsList.innerHTML = competitionProblems.map(problem => {
      const isSelected = selectedCompetitionProblems.has(problem.id.toString());
      return `
        <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
          <input type="checkbox" 
                 id="competition-problem-${problem.id}" 
                 value="${problem.id}" 
                 ${isSelected ? 'checked' : ''}
                 class="competition-problem-checkbox h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
          <label for="competition-problem-${problem.id}" class="ml-3 flex-1 cursor-pointer">
            <div class="text-sm font-medium text-gray-900">${problem.id} - ${problem.title}</div>
            <div class="text-xs text-gray-500">难度: ${problem.difficulty || '未知'}</div>
          </label>
          <button class="text-danger hover:text-danger/80 text-sm transition-colors duration-200 remove-problem-btn" 
                  data-pid="${problem.id}" data-title="${problem.title}">
            <i class="fa fa-trash mr-1"></i> 删除
          </button>
        </div>
      `;
    }).join('');

    // 添加复选框事件监听器
    document.querySelectorAll('.competition-problem-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const problemId = e.target.value;
        if (e.target.checked) {
          selectedCompetitionProblems.add(problemId);
        } else {
          selectedCompetitionProblems.delete(problemId);
        }
        updateSelectedCompetitionProblemsCount();
      });
    });

    // 添加删除按钮事件监听器
    document.querySelectorAll('.remove-problem-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const problemId = btn.getAttribute('data-pid');
        const problemTitle = btn.getAttribute('data-title');
        openSingleDeleteProblemModal(problemId, problemTitle);
      });
    });
  }

  // 更新已选择的比赛题目数量
  function updateSelectedCompetitionProblemsCount() {
    const count = selectedCompetitionProblems.size;
    selectedProblemsCount.textContent = `已选择 ${count} 个题目`;
    batchDeleteProblemsBtn.disabled = count === 0;
  }

  // 打开单个题目删除确认模态框
  function openSingleDeleteProblemModal(problemId, problemTitle) {
    const problem = competitionProblems.find(p => p.id.toString() === problemId);
    if (!problem) return;

    problemsToDeleteList.innerHTML = `
      <div class="flex items-center p-2 bg-white rounded border">
        <div class="flex-1">
          <div class="text-sm font-medium text-gray-900">${problem.id} - ${problem.title}</div>
          <div class="text-xs text-gray-500">难度: ${problem.difficulty || '未知'}</div>
        </div>
      </div>
    `;

    // 设置确认删除的回调
    confirmDeleteProblems.onclick = () => {
      deleteSingleProblemFromCompetition(problemId);
    };

    deleteProblemsModal.classList.remove('hidden');
    setTimeout(() => {
      deleteProblemsModalContent.classList.remove('scale-95', 'opacity-0');
      deleteProblemsModalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
  }

  // 打开批量删除题目确认模态框
  function openBatchDeleteProblemsModal() {
    if (selectedCompetitionProblems.size === 0) return;

    const selectedProblems = Array.from(selectedCompetitionProblems).map(pid => 
      competitionProblems.find(p => p.id.toString() === pid)
    ).filter(p => p);

    problemsToDeleteList.innerHTML = selectedProblems.map(problem => `
      <div class="flex items-center p-2 bg-white rounded border mb-2">
        <div class="flex-1">
          <div class="text-sm font-medium text-gray-900">${problem.id} - ${problem.title}</div>
          <div class="text-xs text-gray-500">难度: ${problem.difficulty || '未知'}</div>
        </div>
      </div>
    `).join('');

    // 设置确认删除的回调
    confirmDeleteProblems.onclick = () => {
      batchDeleteProblemsFromCompetition();
    };

    deleteProblemsModal.classList.remove('hidden');
    setTimeout(() => {
      deleteProblemsModalContent.classList.remove('scale-95', 'opacity-0');
      deleteProblemsModalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
  }

  // 关闭删除题目确认模态框
  function closeDeleteProblemsModal() {
    deleteProblemsModalContent.classList.remove('scale-100', 'opacity-100');
    deleteProblemsModalContent.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
      deleteProblemsModal.classList.add('hidden');
    }, 300);
  }

  // 删除单个题目
  function deleteSingleProblemFromCompetition(problemId) {
    fetch(`/admin/competition/${currentCompetitionId}/problems/${problemId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                showToast('题目删除成功', 'success');
                closeDeleteProblemsModal();
                // 重新加载比赛题目列表
                fetchCompetitionProblems(currentCompetitionId);
              } else {
                showToast(data.msg || '删除题目失败', 'error');
              }
            })
            .catch(error => {
              console.error('Error removing problem from competition:', error);
              showToast('网络错误，请重试', 'error');
            });
  }

  // 批量删除题目
  function batchDeleteProblemsFromCompetition() {
    const problemIds = Array.from(selectedCompetitionProblems);
    
    // 并行删除所有选中的题目
    const deletePromises = problemIds.map(problemId => 
      fetch(`/admin/competition/${currentCompetitionId}/problems/${problemId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      }).then(response => response.json())
    );

    Promise.all(deletePromises)
            .then(results => {
              const successCount = results.filter(result => result.code === 200).length;
              if (successCount === problemIds.length) {
                showToast(`成功删除 ${successCount} 个题目`, 'success');
                closeDeleteProblemsModal();
                selectedCompetitionProblems.clear();
                updateSelectedCompetitionProblemsCount();
                // 重新加载比赛题目列表
                fetchCompetitionProblems(currentCompetitionId);
              } else {
                showToast(`部分题目删除失败，成功删除 ${successCount} 个`, 'warning');
              }
            })
            .catch(error => {
              console.error('Error batch deleting problems:', error);
              showToast('网络错误，请重试', 'error');
            });
  }

  // 切换比赛下拉框
  function toggleCompetitionDropdown() {
    const isHidden = competitionDropdownMenu.classList.contains('hidden');
    if (isHidden) {
      competitionDropdownMenu.classList.remove('hidden');
      competitionDropdownIcon.style.transform = 'rotate(180deg)';
    } else {
      competitionDropdownMenu.classList.add('hidden');
      competitionDropdownIcon.style.transform = 'rotate(0deg)';
    }
  }

  // 选择比赛选项
  function selectCompetition(competitionId, competitionTitle) {
    competitionSelect.value = competitionId;
    competitionSelectedText.textContent = competitionTitle;
    competitionDropdownMenu.classList.add('hidden');
    competitionDropdownIcon.style.transform = 'rotate(0deg)';
  }

  // 关闭比赛下拉框（点击外部时）
  function closeCompetitionDropdown() {
    competitionDropdownMenu.classList.add('hidden');
    competitionDropdownIcon.style.transform = 'rotate(0deg)';
  }

  // 为编辑比赛打开添加题目模态框
  function openAddProblemModalForEdit() {
    // 清空表单
    addProblemForm.reset();
    selectedProblems.clear();
    selectedCountSpan.textContent = '0';

    // 设置当前比赛ID并保持可用状态
    competitionSelect.value = currentCompetitionId;
    const currentCompetition = competitions.find(c => c.id === currentCompetitionId);
    if (currentCompetition) {
      competitionSelectedText.textContent = `${currentCompetition.id} - ${currentCompetition.title}`;
    }

    // 加载题目列表
    fetchAllProblems().then(() => {
      addProblemModal.classList.remove('hidden');

      // 动画效果
      setTimeout(() => {
        addProblemModalContent.classList.remove('scale-95', 'opacity-0');
        addProblemModalContent.classList.add('scale-100', 'opacity-100');
      }, 10);

      problemSearchInput.focus();
    }).catch(error => {
      showToast('加载题目列表失败: ' + error, 'error');
    });
  }
</script>
</body>
<script src="/libs/ai-widget.js"></script>
</html>