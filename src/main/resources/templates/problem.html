<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${problem.id} + ' - ' + ${problem.title}"></title>

    <!-- Ê†∏ÂøÉÊ†∑ÂºèÂ∫ì -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Markdown Áõ∏ÂÖ≥ËµÑÊ∫ê -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.1/purify.min.js"></script>

    <!-- Monaco Editor Ê†∑Âºè -->
    <style>
        .monaco-editor-container {
            height: 500px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .monaco-editor {
            height: 100%;
        }

        /* ÁºñËæëÂô®Â∑•ÂÖ∑Ê†è */
        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theme-toggle {
            background: none;
            border: 1px solid #dee2e6;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: #e9ecef;
        }

        /* ÁæéÂåñÂêéÁöÑ‰∏ãÊãâÊ°ÜÊ†∑Âºè */
        .custom-select {
            position: relative;
            min-width: 180px;
            z-index: 1000;
        }

        .select-selected {
            background: linear-gradient(135deg, #e0f2fe, #bbdefb);
            color: var(--primary);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid transparent;
        }

        .select-selected:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
            border-color: rgba(26, 115, 232, 0.3);
        }

        .select-selected:after {
            content: "\f078";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .select-selected.select-arrow-active:after {
            transform: rotate(180deg);
        }

        .select-items {
            position: absolute;
            background-color: white;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 9999;
            border-radius: 12px;
            margin-top: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            transform: translateY(-10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(26, 115, 232, 0.1);
        }

        .select-items.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
            display: block;
        }

        .select-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .select-item:last-child {
            border-bottom: none;
        }

        .select-item:hover {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            color: var(--primary);
            transform: translateX(4px);
        }

        .select-item.selected {
            background: linear-gradient(135deg, #e0f2fe, #bbdefb);
            color: var(--primary);
            font-weight: 600;
        }

        .language-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .language-icon {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .language-info {
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
        }
    </style>

    <style>
        :root {
            --primary: #1a73e8;
            --secondary: #4a90e2;
            --accent: #66bb6a;
            --text: #2d3748;
            --bg: #f8fafc;
            --light-blue: rgba(26, 115, 232, 0.05);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #2ea44f;
            --danger: #d73a49;
            --info: #0366d6;
            --bg-light: #f6f8fa;
            --border-radius: 12px;
            --border-color: #e1e4e8;
        }

        body {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f2ff 50%, #f8fafc 100%);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.5;
            color: var(--text);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                    radial-gradient(circle at 20% 80%, rgba(26, 115, 232, 0.03) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(102, 187, 106, 0.03) 0%, transparent 50%),
                    radial-gradient(circle at 40% 40%, rgba(255, 193, 7, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .problem-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 24px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background: linear-gradient(135deg, rgba(26, 115, 232, 0.05) 0%, rgba(102, 187, 106, 0.05) 100%);
            border-bottom: 1px solid rgba(26, 115, 232, 0.1);
            padding: 20px 24px;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.8s ease;
        }

        .card:hover .card-header::before {
            left: 100%;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 30px;
        }

        .problem-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            position: relative;
            animation: fadeIn 0.8s ease-out;
        }

        .problem-title::after {
            content: "|";
            animation: blink 1s infinite;
            color: var(--primary);
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .problem-meta {
            display: flex;
            gap: 20px;
            font-size: 0.95rem;
            color: #586069;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .meta-item i {
            color: var(--primary);
            font-size: 1em;
        }

        .code-preview {
            background: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 16px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            line-height: 1.45;
            white-space: pre;
            overflow-x: auto;
            font-size: 85%;
            border: 1px solid var(--border-color);
        }

        .code-editor-container {
            background: white;
            border-radius: var(--border-radius);
            margin-top: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .CodeMirror {
            border-radius: var(--border-radius);
            height: 500px;
            border: 1px solid var(--border-color);
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .submit-btn {
            background: var(--success);
            color: white;
            padding: 8px 24px;
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: all 0.2s;
            border: none;
        }

        .submit-btn:hover {
            background: #2c974b;
            transform: translateY(-1px);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* Êèê‰∫§ÁªìÊûúÊòæÁ§∫Ê†∑Âºè */
        .submit-result {
            font-size: 14px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            min-width: 120px;
            text-align: center;
            width: auto;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .submit-result.error:hover {
            background: #f1aeb5;
            transform: translateY(-1px);
        }

        .submit-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .submit-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .submit-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* ÈîôËØØËØ¶ÊÉÖÂºπÁ™óÊ†∑Âºè */
        .error-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .error-detail-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .error-detail-content {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .error-detail-modal.show .error-detail-content {
            transform: scale(1);
        }
        
        .error-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .error-detail-title {
            font-size: 18px;
            font-weight: 600;
            color: #721c24;
        }
        
        .error-detail-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .error-detail-close:hover {
            background: #f8f9fa;
            color: #495057;
        }
        
        .test-case-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            border: 1px solid #e9ecef;
        }
        
        .test-case-item {
            margin: 12px 0;
            display: flex;
            align-items: flex-start;
        }
        
        .test-case-item .label {
            font-weight: 600;
            min-width: 100px;
            margin-right: 16px;
            color: #495057;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .test-case-item code {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            color: #495057;
            border: 1px solid #dee2e6;
            flex: 1;
            word-break: break-all;
            white-space: pre-wrap;
        }

        /* GitHubÈ£éÊ†ºÁöÑMarkdownÊ†∑Âºè */
        .markdown-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            word-wrap: break-word;
            padding: 16px;
        }

        .markdown-content h1,
        .markdown-content h2 {
            padding-bottom: 0.3em;
            border-bottom: 1px solid var(--border-color);
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .markdown-content h1 {
            font-size: 2em;
        }

        .markdown-content h2 {
            font-size: 1.5em;
        }

        .markdown-content h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 16px;
        }

        .markdown-content pre {
            background: var(--bg-light);
            padding: 16px;
            border-radius: var(--border-radius);
            overflow: auto;
            margin: 16px 0;
            border: 1px solid var(--border-color);
            line-height: 1.45;
        }

        .markdown-content code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            background: rgba(27,31,35,0.05);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 85%;
        }

        .markdown-content pre code {
            background: transparent;
            padding: 0;
            border-radius: 0;
        }

        .markdown-content img {
            max-width: 100%;
            box-sizing: content-box;
            background-color: #fff;
            margin: 16px 0;
        }

        .markdown-content table {
            border-spacing: 0;
            border-collapse: collapse;
            display: block;
            width: 100%;
            overflow: auto;
            margin: 16px 0;
        }

        .markdown-content th,
        .markdown-content td {
            padding: 6px 13px;
            border: 1px solid var(--border-color);
        }

        .markdown-content th {
            font-weight: 600;
            background: var(--bg-light);
        }

        .markdown-content tr {
            background-color: #fff;
            border-top: 1px solid var(--border-color);
        }

        .markdown-content tr:nth-child(2n) {
            background-color: var(--bg-light);
        }

        .markdown-content blockquote {
            padding: 0 1em;
            color: #6a737d;
            border-left: 0.25em solid var(--border-color);
            margin: 0 0 16px 0;
        }

        .markdown-content ul,
        .markdown-content ol {
            padding-left: 2em;
            margin-top: 0;
            margin-bottom: 16px;
        }

        .markdown-content li {
            word-wrap: break-word;
        }

        .markdown-content li > p {
            margin-top: 16px;
        }

        .markdown-content li + li {
            margin-top: 0.25em;
        }

        /* Ê†áÁ≠æÊ†∑Âºè */
        .tag {
            display: inline-block;
            padding: 0 10px;
            font-size: 12px;
            font-weight: 500;
            line-height: 22px;
            color: #0366d6;
            background-color: #f1f8ff;
            border-radius: 2em;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        /* ÁæéÂåñÁöÑÂà§È¢òÁªìÊûúÂºπÊ°Ü */
        .status-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            font-size: 1.05rem;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            max-width: 450px;
        }

        .status-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status-success {
            background: #f0fff4;
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        .status-error {
            background: #fff5f5;
            color: #742a2a;
            border-left: 4px solid #e53e3e;
        }

        .status-info {
            background: #edf2ff;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }

        .status-toast i {
            font-size: 1.3em;
        }

        @media (max-width: 768px) {
            .problem-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .monaco-editor-container {
                height: 350px;
            }

            .editor-toolbar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .editor-actions {
                width: 100%;
                justify-content: space-between;
            }

            .status-toast {
                min-width: auto;
                max-width: calc(100% - 40px);
            }
        }

        @media (max-width: 480px) {
            .monaco-editor-container {
                height: 300px;
            }

            .editor-toolbar {
                padding: 8px 12px;
            }

            .theme-toggle {
                padding: 4px 8px;
                font-size: 11px;
            }

            .language-info {
                font-size: 11px;
                padding: 1px 6px;
            }
        }

        /* ËØÑËÆ∫Âå∫ÂüüÊ†∑Âºè */
        .comment-section {
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        .comment-section .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            border: none;
        }

        .comment-section .card-header h4 {
            font-weight: 600;
        }

        .comment-form textarea {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 100px;
        }

        .comment-form textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        /* EmojiÈÄâÊã©Âô®Ê†∑Âºè */
        .comment-input-container {
            position: relative;
        }

        .emoji-picker-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .emoji-trigger {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            z-index: 10;
            font-size: 18px;
        }

        .emoji-trigger:hover {
            background: #f7fafc;
            color: #667eea;
        }

        .emoji-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 12px;
            width: 320px;
            max-height: 300px;
            display: none;
            z-index: 1000;
            margin-bottom: 8px;
        }

        .emoji-picker.show {
            display: block;
        }

        .emoji-categories {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .emoji-category {
            background: none;
            border: none;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .emoji-category:hover {
            background: #f7fafc;
        }

        .emoji-category.active {
            background: #667eea;
            color: white;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-item {
            background: none;
            border: none;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-item:hover {
            background: #f7fafc;
            transform: scale(1.1);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .emoji-picker {
                width: 280px;
                right: -10px;
            }

            .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        .comment-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .comment-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        .comment-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* ËØÑËÆ∫È´ò‰∫ÆÊïàÊûú */
        .comment-highlight {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            border: 2px solid #f39c12 !important;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.3) !important;
            animation: highlightPulse 2s ease-in-out;
        }

        @keyframes highlightPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(243, 156, 18, 0.3);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 30px rgba(243, 156, 18, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(243, 156, 18, 0.3);
            }
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .comment-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .comment-author .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .comment-author .name {
            font-weight: 600;
            color: #2d3748;
        }

        .reply-to {
            color: #718096;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }

        .reply-username {
            color: #667eea;
            font-weight: 500;
        }

        .comment-time {
            color: #718096;
            font-size: 0.9rem;
        }

        .comment-content {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 1rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .comment-actions {
            display: flex;
            gap: 1rem;
        }

        .comment-action {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .comment-action:hover {
            background: #e2e8f0;
            color: #4a5568;
        }

        .comment-action.reply:hover {
            color: #667eea;
        }

        .comment-action.delete:hover {
            color: #e53e3e;
        }

        /* ÂõûÂ§çÂå∫ÂüüÊ†∑Âºè */
        .reply-form {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .reply-form.show {
            display: block;
        }

        .reply-form textarea {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            width: 100%;
            min-height: 80px;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .reply-form textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .reply-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .reply-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .reply-btn.primary {
            background: #667eea;
            color: white;
        }

        .reply-btn.primary:hover {
            background: #5a67d8;
        }

        .reply-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .reply-btn.secondary:hover {
            background: #cbd5e0;
        }

        /* Â≠êËØÑËÆ∫Ê†∑Âºè */
        .subcomment-list {
            margin-top: 1rem;
            padding-left: 2rem;
            border-left: 2px solid #e2e8f0;
        }

        .subcomment-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .subcomment-item:last-child {
            margin-bottom: 0;
        }

        /* Á©∫Áä∂ÊÄÅÊ†∑Âºè */
        .comment-list .text-center {
            padding: 3rem 1rem;
        }

        .comment-list .text-center i {
            color: #cbd5e0;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .comment-item {
                padding: 1rem;
            }

            .comment-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .subcomment-list {
                padding-left: 1rem;
            }

            .comment-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
<div class="problem-container">
    <!-- È¢òÁõÆÂ§¥ÈÉ® -->
    <div class="card info-card">
        <div class="problem-header p-4">
            <div class="problem-title">
                <i class="fas fa-code text-primary"></i>
                <span th:text="${problem.title}"></span>
            </div>
            <div class="problem-meta d-flex justify-content-between align-items-center">
                <div>
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span id="time" th:text="'Êó∂Èó¥ÈôêÂà∂Ôºö' + ${problem.timeLimit} + ' ms'"></span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-memory"></i>
                        <span id="memory" th:text="'ÂÜÖÂ≠òÈôêÂà∂Ôºö' + ${problem.memoryLimit} + ' MB'"></span>
                    </div>
                    <!-- Ê†áÁ≠æÂå∫Âüü -->
                    <div class="meta-item">
                        <i class="fas fa-tags text-primary"></i>
                        <div id="tagsContainer" class="d-flex align-items-center flex-wrap gap-1"></div>
                    </div>
                </div>
                <a href="#"
                   class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1"
                   th:href="@{/solve/list/{id}(id=${problem.id})}"
                   target="_self">
                    <i class="fas fa-book-open"></i>
                    <span>Êü•ÁúãÈ¢òËß£</span>
                </a>
            </div>
        </div>
    </div>

    <!-- È¢òÁõÆÊèèËø∞ -->
    <div class="card info-card">
        <div class="card-header">
            <h4 class="mb-0">È¢òÁõÆÊèèËø∞</h4>
        </div>
        <div class="markdown-content" th:text="${problem.description}"></div>
    </div>

    <!-- ËæìÂÖ•Ê†ºÂºè -->
    <div class="card info-card">
        <div class="card-header">
            <h4 class="mb-0">ËæìÂÖ•Ê†ºÂºè</h4>
        </div>
        <div class="markdown-content" th:text="${problem.inputFormat}"></div>
    </div>

    <!-- ËæìÂá∫Ê†ºÂºè -->
    <div class="card info-card">
        <div class="card-header">
            <h4 class="mb-0">ËæìÂá∫Ê†ºÂºè</h4>
        </div>
        <div class="markdown-content" th:text="${problem.outputFormat}"></div>
    </div>

    <!-- ËæìÂÖ•ËæìÂá∫Ê†∑‰æã -->
    <div class="row g-4 mt-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">ËæìÂÖ•Ê†∑‰æã</h5>
                </div>
                <div class="code-preview" th:utext="${problem.inputExample}"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">ËæìÂá∫Ê†∑‰æã</h5>
                </div>
                <div class="code-preview" th:utext="${problem.outputExample}"></div>
            </div>
        </div>
    </div>

    <!-- ÊèêÁ§∫ -->
    <div class="card info-card mt-4">
        <div class="card-header">
            <h4 class="mb-0">ÊèêÁ§∫</h4>
        </div>
        <div class="markdown-content" th:text="${problem.hint}"></div>
    </div>

    <!-- ‰ª£Á†ÅÊèê‰∫§Âå∫Âüü -->
    <div class="card code-editor-container mt-5">
        <form id="submitForm">
            <input type="hidden" name="problemId" th:value="${problem.id}">
            <div class="mb-3">
                <label class="form-label">ÈÄâÊã©ÁºñÁ®ãËØ≠Ë®Ä</label>
                <div class="custom-select" id="languageSelect">
                    <div class="select-selected">C++17</div>
                    <div class="select-items">
                        <div class="select-item selected" data-value="cpp">
                            <span class="language-option">
                                <span class="language-icon"><i class="fab fa-cuttlefish"></i></span>
                                <span>C++17</span>
                            </span>
                        </div>
                        <div class="select-item" data-value="python">
                            <span class="language-option">
                                <span class="language-icon"><i class="fab fa-python"></i></span>
                                <span>Python</span>
                            </span>
                        </div>
                        <div class="select-item" data-value="java">
                            <span class="language-option">
                                <span class="language-icon"><i class="fab fa-java"></i></span>
                                <span>Java</span>
                            </span>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="languageSelectHidden" name="language" value="cpp">
            </div>
            <div id="judgeStatus" class="mb-3">
                <div id="statusAlert" class="alert" style="display: none;"></div>
            </div>

            <div class="mb-4">
                <div class="monaco-editor-container">
                    <div class="editor-toolbar">
                        <div class="language-info" id="languageInfo">C++17</div>
                        <div class="editor-actions">
                            <button type="button" class="theme-toggle" id="themeToggle">
                                <i class="fas fa-moon"></i> ÊöóËâ≤‰∏ªÈ¢ò
                            </button>
                            <button type="button" class="theme-toggle" id="formatCode">
                                <i class="fas fa-magic"></i> Ê†ºÂºèÂåñ
                            </button>
                        </div>
                    </div>
                    <div id="codeEditor" class="monaco-editor"></div>
                </div>
                <textarea id="codeEditorHidden" name="code" style="display: none;"></textarea>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <div id="submitResult" class="submit-result">
                    <!-- Êèê‰∫§ÁªìÊûúÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå -->
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-paper-plane me-2"></i> Êèê‰∫§‰ª£Á†Å
                </button>
            </div>
        </form>
    </div>

    <!-- ËØÑËÆ∫Âå∫Âüü -->
    <div class="card comment-section mt-5">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="fas fa-comments me-2"></i>ËØÑËÆ∫ËÆ®ËÆ∫
                <span class="badge bg-primary ms-2" id="commentCount">0</span>
            </h4>
        </div>
        <div class="card-body">
            <!-- ÂèëË°®ËØÑËÆ∫Âå∫Âüü -->
            <div class="comment-form mb-4">
                <div class="mb-3">
                    <label for="commentContent" class="form-label">ÂèëË°®ËØÑËÆ∫</label>
                    <div class="comment-input-container">
                        <textarea id="commentContent" class="form-control" rows="4" placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï„ÄÅËß£È¢òÊÄùË∑ØÊàñÈÅáÂà∞ÁöÑÈóÆÈ¢ò..."></textarea>
                        <button type="button" class="emoji-trigger" id="emojiTrigger">
                            <i class="fas fa-smile"></i>
                        </button>
                    </div>
                    <div class="emoji-picker-container">
                        <div class="emoji-picker" id="emojiPicker">
                            <div class="emoji-categories">
                                <button class="emoji-category active" data-category="smileys">üòÄ</button>
                                <button class="emoji-category" data-category="people">üëã</button>
                                <button class="emoji-category" data-category="animals">üê∂</button>
                                <button class="emoji-category" data-category="food">üçé</button>
                                <button class="emoji-category" data-category="travel">üöó</button>
                                <button class="emoji-category" data-category="objects">üì±</button>
                                <button class="emoji-category" data-category="symbols">‚ù§Ô∏è</button>
                            </div>
                            <div class="emoji-grid" id="emojiGrid">
                                <!-- EmojiÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-primary" id="submitComment">
                        <i class="fas fa-paper-plane me-2"></i>ÂèëË°®ËØÑËÆ∫
                    </button>
                </div>
            </div>

            <!-- ËØÑËÆ∫ÂàóË°® -->
            <div id="commentList" class="comment-list">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i>
                    <p>ÊöÇÊó†ËØÑËÆ∫ÔºåÂø´Êù•ÂèëË°®Á¨¨‰∏ÄÊù°ËØÑËÆ∫ÂêßÔºÅ</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ê†∏ÂøÉËÑöÊú¨ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Monaco Editor ËÑöÊú¨ -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<!-- Â§áÁî® CDN -->
<script>
  // Â¶ÇÊûú‰∏ª CDN Â§±Ë¥•ÔºåÂ∞ùËØïÂ§áÁî® CDN
  if (typeof require === 'undefined') {
    console.log('Primary CDN failed, trying backup CDN...');
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js';
    script.onload = function() {
      console.log('Backup CDN loaded successfully');
    };
    script.onerror = function() {
      console.error('Both CDNs failed to load Monaco Editor');
    };
    document.head.appendChild(script);
  }
</script>

<script>
    // ÈÖçÁΩÆmarked.js‰ª•Á¨¶ÂêàGitHubÈ£éÊ†º
    marked.setOptions({
        gfm: true,
        breaks: true,
        pedantic: false,
        smartLists: true,
        smartypants: false,
        highlight: function(code, lang) {
            const validLang = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language: validLang }).value;
        },
        extensions: [
            {
                name: 'math',
                level: 'inline',
                start(src) { return src.indexOf('$'); },
                tokenizer(src, tokens) {
                    const match = src.match(/^\$+([^$\n]+?)\$+/);
                    if (match) {
                        return {
                            type: 'math',
                            raw: match[0],
                            text: match[1].trim()
                        };
                    }
                },
                renderer(token) {
                    return `<span class="math">\\(${token.text}\\)</span>`;
                }
            }
        ]
    });

    // Ê∏≤ÊüìMarkdownÂÜÖÂÆπ
    function renderMarkdownElements() {
        document.querySelectorAll('.markdown-content').forEach(element => {
            const rawText = element.textContent;
            const parsedMarkdown = marked.parse(rawText);
            element.innerHTML = DOMPurify.sanitize(parsedMarkdown, {
                ADD_TAGS: ['iframe'],
                ADD_ATTR: ['allow', 'allowfullscreen', 'frameborder', 'scrolling']
            });

            // Ê∏≤ÊüìÊï∞Â≠¶ÂÖ¨Âºè
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise();
            }

            // È´ò‰∫Æ‰ª£Á†ÅÂùó
            element.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });
    }

    // Monaco Editor ÂÖ®Â±ÄÂèòÈáè
    let editor = null;
    let currentTheme = 'vs';
    let currentLanguage = 'cpp';

    // ËØ≠Ë®ÄÈÖçÁΩÆ
    const languageConfig = {
        'cpp': {
            id: 'cpp',
            name: 'C++17',
            template: `#include <iostream>
using namespace std;

int main() {
    // ËØ∑Âú®Ê≠§Â§ÑÁºñÂÜô‰Ω†ÁöÑ‰ª£Á†Å

    return 0;
}`
        },
        'python': {
            id: 'python',
            name: 'Python 3',
            template: `# ËØ∑Âú®Ê≠§Â§ÑÁºñÂÜô‰Ω†ÁöÑ‰ª£Á†Å

`
        },
        'java': {
            id: 'java',
            name: 'Java',
            template: `public class Main {
    public static void main(String[] args) {
        // ËØ∑Âú®Ê≠§Â§ÑÁºñÂÜô‰Ω†ÁöÑ‰ª£Á†Å
    }
}`
        }
    };

    // ÂàùÂßãÂåñ Monaco Editor
    function initMonacoEditor() {
        // Ê£ÄÊü• DOM ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
        const editorElement = document.getElementById('codeEditor');
        if (!editorElement) {
            console.error('ÁºñËæëÂô®ÂÆπÂô®ÂÖÉÁ¥†Êú™ÊâæÂà∞');
            return;
        }

        // Á≠âÂæÖ Monaco Editor Âä†ËΩΩÂÆåÊàê
        function waitForMonaco() {
            if (typeof require !== 'undefined') {
                initializeEditor();
            } else {
                console.log('Waiting for Monaco Editor to load...');
                // ÊúÄÂ§öÁ≠âÂæÖ 10 Áßí
                if (typeof waitForMonaco.counter === 'undefined') {
                    waitForMonaco.counter = 0;
                }
                waitForMonaco.counter++;
                
                if (waitForMonaco.counter > 100) { // 10ÁßíÂêéË∂ÖÊó∂
                    console.error('Monaco Editor failed to load after 10 seconds');
                    showFallbackEditor();
                    return;
                }
                
                setTimeout(waitForMonaco, 100);
            }
        }

        function showFallbackEditor() {
            const editorElement = document.getElementById('codeEditor');
            editorElement.innerHTML = '<textarea id="fallbackEditor" style="width: 100%; height: 100%; border: none; outline: none; font-family: monospace; font-size: 14px; padding: 10px; resize: none;">#include <iostream>\nusing namespace std;\n\nint main() {\n    // ËØ∑Âú®Ê≠§Â§ÑÁºñÂÜô‰Ω†ÁöÑ‰ª£Á†Å\n    \n    return 0;\n}</textarea>';
            
            const fallbackEditor = document.getElementById('fallbackEditor');
            if (fallbackEditor) {
                fallbackEditor.addEventListener('input', function() {
                    document.getElementById('codeEditorHidden').value = this.value;
                });
            }
        }

        function initializeEditor() {
            // ‰ΩøÁî® require Âä†ËΩΩ Monaco Editor
            require.config({
                paths: {
                    'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs'
                }
            });

            require(['vs/editor/editor.main'], function () {
            try {
                // Ê≥®ÂÜåËØ≠Ë®Ä
                monaco.languages.register({ id: 'cpp' });
                monaco.languages.setMonarchTokensProvider('cpp', {
                    tokenizer: {
                        root: [
                            [/[a-zA-Z_$][a-zA-Z0-9_$]*/, 'identifier'],
                            [/\d+/, 'number'],
                            [/"[^"]*"/, 'string'],
                            [/\/\/.*$/, 'comment'],
                            [/\/\*[\s\S]*?\*\//, 'comment'],
                            [/[{}()\[\]]/, 'delimiter.bracket'],
                            [/[<>]=?|==|!=/, 'operator'],
                            [/[+\-*/%=!&|^~]/, 'operator'],
                            [/[;,.]/, 'delimiter']
                        ]
                    }
                });

                // ÂàõÂª∫ÁºñËæëÂô®
                editor = monaco.editor.create(editorElement, {
                    value: languageConfig.cpp.template,
                    language: 'cpp',
                    theme: currentTheme,
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontSize: 14,
                    lineNumbers: 'on',
                    roundedSelection: false,
                    scrollBeyondLastLine: false,
                    readOnly: false,
                    cursorStyle: 'line',
                    wordWrap: 'on',
                    // Ê†ºÂºèÂåñÁõ∏ÂÖ≥ÈÖçÁΩÆ
                    formatOnPaste: true,
                    formatOnType: false,
                    insertSpaces: true,
                    tabSize: 4,
                    detectIndentation: false,
                    // ÂêØÁî®Ëá™Âä®Ë°•ÂÖ®
                    suggest: {
                        showKeywords: true,
                        showSnippets: true,
                        showFunctions: true,
                        showConstructors: true,
                        showFields: true,
                        showVariables: true,
                        showClasses: true,
                        showStructs: true,
                        showInterfaces: true,
                        showModules: true,
                        showProperties: true,
                        showEvents: true,
                        showOperators: true,
                        showUnits: true,
                        showValues: true,
                        showConstants: true,
                        showEnums: true,
                        showEnumMembers: true,
                        showColors: true,
                        showFiles: true,
                        showReferences: true,
                        showFolders: true,
                        showTypeParameters: true,
                        showIssues: true,
                        showUsers: true,
                        showWords: true
                    },
                    // ÂêØÁî®‰ª£Á†ÅÊäòÂè†
                    folding: true,
                    foldingStrategy: 'indentation',
                    showFoldingControls: 'always',
                    // ÂêØÁî®Êã¨Âè∑ÂåπÈÖç
                    matchBrackets: 'always',
                    // ÂêØÁî®Ëá™Âä®Áº©Ëøõ
                    autoIndent: 'full',
                    // ÂêØÁî®Ëá™Âä®Èó≠ÂêàÊã¨Âè∑
                    autoClosingBrackets: 'always',
                    autoClosingQuotes: 'always',
                    // ÂêØÁî®‰ª£Á†ÅÊèêÁ§∫
                    quickSuggestions: true,
                    quickSuggestionsDelay: 100,
                    // ÂêØÁî®ÂèÇÊï∞ÊèêÁ§∫
                    parameterHints: {
                        enabled: true
                    },
                    // ÂêØÁî®ÊÇ¨ÂÅúÊèêÁ§∫
                    hover: {
                        enabled: true
                    },
                    // ÂêØÁî®ÈîôËØØÊèêÁ§∫
                    glyphMargin: true,
                    // ÂêØÁî®ÈÄâÊã©È´ò‰∫Æ
                    occurrencesHighlight: true,
                    // ÂêØÁî®ÈÄâÊã©Áõ∏ÂêåËØç
                    selectionHighlight: true,
                    // ÂêØÁî®ÂΩìÂâçË°åÈ´ò‰∫Æ
                    renderLineHighlight: 'line',
                    // ÂêØÁî®Ë°åÂè∑
                    lineNumbersMinChars: 3,
                    // ÂêØÁî®ÊªöÂä®Êù°
                    scrollbar: {
                        vertical: 'auto',
                        horizontal: 'auto',
                        useShadows: false,
                        verticalHasArrows: false,
                        horizontalHasArrows: false,
                        verticalScrollbarSize: 10,
                        horizontalScrollbarSize: 10
                    }
                });

                // ÁõëÂê¨ÂÜÖÂÆπÂèòÂåñÔºåÂêåÊ≠•Âà∞ÈöêËóèÁöÑ textarea
                editor.onDidChangeModelContent(() => {
                    document.getElementById('codeEditorHidden').value = editor.getValue();
                });

                // ÁªëÂÆöÂø´Êç∑ÈîÆ
                editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
                    saveDraft();
                });

                // Ê∑ªÂä†‰ª£Á†ÅÁâáÊÆµ
                addCodeSnippets();

                // Ê∑ªÂä†ÈîôËØØÊèêÁ§∫
                addErrorMarkers();

                // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆÊèêÁ§∫
                addKeyboardShortcuts();

                console.log('Monaco Editor ÂàùÂßãÂåñÊàêÂäü');

            } catch (error) {
                console.error('Monaco Editor ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                // Â¶ÇÊûú Monaco Editor ÂàùÂßãÂåñÂ§±Ë¥•ÔºåÊòæÁ§∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑ textarea
                editorElement.innerHTML = '<textarea id="fallbackEditor" style="width: 100%; height: 100%; border: none; outline: none; font-family: monospace; font-size: 14px; padding: 10px; resize: none;">#include <iostream>\nusing namespace std;\n\nint main() {\n    // ËØ∑Âú®Ê≠§Â§ÑÁºñÂÜô‰Ω†ÁöÑ‰ª£Á†Å\n    \n    return 0;\n}</textarea>';

                // ÁªëÂÆö fallback editor ÁöÑ‰∫ã‰ª∂
                const fallbackEditor = document.getElementById('fallbackEditor');
                if (fallbackEditor) {
                    fallbackEditor.addEventListener('input', function() {
                        document.getElementById('codeEditorHidden').value = this.value;
                    });
                }
            }
        }, function (error) {
            console.error('Monaco Editor Âä†ËΩΩÂ§±Ë¥•:', error);
            // Â¶ÇÊûú Monaco Editor Âä†ËΩΩÂ§±Ë¥•ÔºåÊòæÁ§∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑ textarea
            const editorElement = document.getElementById('codeEditor');
            if (editorElement) {
                editorElement.innerHTML = '<textarea id="fallbackEditor" style="width: 100%; height: 100%; border: none; outline: none; font-family: monospace; font-size: 14px; padding: 10px; resize: none;">#include <iostream>\nusing namespace std;\n\nint main() {\n    // ËØ∑Âú®Ê≠§Â§ÑÁºñÂÜô‰Ω†ÁöÑ‰ª£Á†Å\n    \n    return 0;\n}</textarea>';

                // ÁªëÂÆö fallback editor ÁöÑ‰∫ã‰ª∂
                const fallbackEditor = document.getElementById('fallbackEditor');
                if (fallbackEditor) {
                    fallbackEditor.addEventListener('input', function() {
                        document.getElementById('codeEditorHidden').value = this.value;
                    });
                }
            }
        });
        }

        // ÂºÄÂßãÁ≠âÂæÖ Monaco Editor Âä†ËΩΩ
        waitForMonaco();
    }

    // Ê∑ªÂä†ÈîôËØØÊ†áËÆ∞ÂäüËÉΩ
    function addErrorMarkers() {
        if (!editor) return;

        // ÁõëÂê¨ÂÜÖÂÆπÂèòÂåñÔºåÊ∑ªÂä†ÁÆÄÂçïÁöÑËØ≠Ê≥ïÊ£ÄÊü•
        editor.onDidChangeModelContent(() => {
            const model = editor.getModel();
            if (!model) return;

            const value = model.getValue();
            const errors = [];

            // ÁÆÄÂçïÁöÑ C++ ËØ≠Ê≥ïÊ£ÄÊü•
            if (currentLanguage === 'cpp') {
                const lines = value.split('\n');
                let totalOpenBraces = 0;
                let totalCloseBraces = 0;
                let totalOpenParens = 0;
                let totalCloseParens = 0;

                // ÁªüËÆ°Êï¥‰∏™Êñá‰ª∂ÁöÑÊã¨Âè∑Êï∞Èáè
                for (let line of lines) {
                    totalOpenBraces += (line.match(/\{/g) || []).length;
                    totalCloseBraces += (line.match(/\}/g) || []).length;
                    totalOpenParens += (line.match(/\(/g) || []).length;
                    totalCloseParens += (line.match(/\)/g) || []).length;
                }

                // Âè™ÊúâÂú®Êï¥‰∏™Êñá‰ª∂Á∫ßÂà´‰∏çÂåπÈÖçÊó∂ÊâçÊòæÁ§∫ÈîôËØØ
                if (totalOpenBraces !== totalCloseBraces) {
                    const lastLine = lines.length;
                    errors.push({
                        startLineNumber: lastLine,
                        startColumn: 1,
                        endLineNumber: lastLine,
                        endColumn: 1,
                        message: `Â§ßÊã¨Âè∑‰∏çÂåπÈÖçÔºö{ Êúâ ${totalOpenBraces} ‰∏™Ôºå} Êúâ ${totalCloseBraces} ‰∏™`,
                        severity: monaco.MarkerSeverity.Warning
                    });
                }

                if (totalOpenParens !== totalCloseParens) {
                    const lastLine = lines.length;
                    errors.push({
                        startLineNumber: lastLine,
                        startColumn: 1,
                        endLineNumber: lastLine,
                        endColumn: 1,
                        message: `Â∞èÊã¨Âè∑‰∏çÂåπÈÖçÔºö( Êúâ ${totalOpenParens} ‰∏™Ôºå) Êúâ ${totalCloseParens} ‰∏™`,
                        severity: monaco.MarkerSeverity.Warning
                    });
                }
            }

            // ËÆæÁΩÆÈîôËØØÊ†áËÆ∞
            monaco.editor.setModelMarkers(model, 'syntax', errors);
        });
    }

    // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆÊèêÁ§∫
    function addKeyboardShortcuts() {
        if (!editor) return;

        // Ê∑ªÂä†Ëá™ÂÆö‰πâÂø´Êç∑ÈîÆ
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyF, () => {
            editor.getAction('editor.action.startFindReplaceAction').run();
        });

        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyG, () => {
            editor.getAction('editor.action.gotoLineAction').run();
        });

        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Slash, () => {
            editor.getAction('editor.action.commentLine').run();
        });

        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyA, () => {
            editor.getAction('editor.action.selectAll').run();
        });
    }

    // Ê∑ªÂä†‰ª£Á†ÅÁâáÊÆµ
    function addCodeSnippets() {
        // C++ ‰ª£Á†ÅÁâáÊÆµ
        monaco.languages.registerCompletionItemProvider('cpp', {
            provideCompletionItems: (model, position) => {
                const suggestions = [
                    {
                        label: 'for',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'for (int i = 0; i < ${1:count}; i++) {\n\t${2:// code}\n}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'for Âæ™ÁéØ'
                    },
                    {
                        label: 'while',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'while (${1:condition}) {\n\t${2:// code}\n}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'while Âæ™ÁéØ'
                    },
                    {
                        label: 'if',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'if (${1:condition}) {\n\t${2:// code}\n}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'if ËØ≠Âè•'
                    },
                    {
                        label: 'ifelse',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'if (${1:condition}) {\n\t${2:// code}\n} else {\n\t${3:// code}\n}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'if-else ËØ≠Âè•'
                    },
                    {
                        label: 'cout',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'cout << ${1:value} << endl;',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'ËæìÂá∫ËØ≠Âè•'
                    },
                    {
                        label: 'cin',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'cin >> ${1:variable};',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'ËæìÂÖ•ËØ≠Âè•'
                    }
                ];

                return { suggestions };
            }
        });

        // Python ‰ª£Á†ÅÁâáÊÆµ
        monaco.languages.registerCompletionItemProvider('python', {
            provideCompletionItems: (model, position) => {
                const suggestions = [
                    {
                        label: 'for',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'for ${1:item} in ${2:iterable}:\n\t${3:# code}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'for Âæ™ÁéØ'
                    },
                    {
                        label: 'while',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'while ${1:condition}:\n\t${2:# code}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'while Âæ™ÁéØ'
                    },
                    {
                        label: 'if',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'if ${1:condition}:\n\t${2:# code}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'if ËØ≠Âè•'
                    },
                    {
                        label: 'def',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'def ${1:function_name}(${2:parameters}):\n\t${3:# code}\n\treturn ${4:value}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'ÂáΩÊï∞ÂÆö‰πâ'
                    },
                    {
                        label: 'print',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'print(${1:value})',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'ËæìÂá∫ËØ≠Âè•'
                    }
                ];

                return { suggestions };
            }
        });
    }

    // ËØ≠Ë®ÄÂàáÊç¢ÂäüËÉΩ
    function switchLanguage(language) {
        const config = languageConfig[language];
        if (!config) return;

        currentLanguage = language;

        // Êõ¥Êñ∞ËØ≠Ë®ÄÊòæÁ§∫
        document.getElementById('languageInfo').textContent = config.name;

        if (editor) {
            // Monaco Editor Ê®°Âºè
            // Êõ¥Êñ∞ËØ≠Ë®Ä
            monaco.editor.setModelLanguage(editor.getModel(), config.id);

            // Â¶ÇÊûúÁºñËæëÂô®‰∏∫Á©∫ÊàñÂè™ÊúâÈªòËÆ§ÂÜÖÂÆπÔºåÂàôÂä†ËΩΩÊ®°Êùø
            const currentValue = editor.getValue().trim();
            const isEmpty = !currentValue || currentValue === languageConfig.cpp.template.trim() ||
                currentValue === languageConfig.python.template.trim() ||
                currentValue === languageConfig.java.template.trim();

            if (isEmpty) {
                editor.setValue(config.template);
            }
        } else {
            // Fallback textarea Ê®°Âºè
            const fallbackEditor = document.getElementById('fallbackEditor');
            if (fallbackEditor) {
                const currentValue = fallbackEditor.value.trim();
                const isEmpty = !currentValue || currentValue === languageConfig.cpp.template.trim() ||
                    currentValue === languageConfig.python.template.trim() ||
                    currentValue === languageConfig.java.template.trim();

                if (isEmpty) {
                    fallbackEditor.value = config.template;
                    // ÂêåÊ≠•Âà∞ÈöêËóèÁöÑ textarea
                    document.getElementById('codeEditorHidden').value = config.template;
                }
            }
        }
    }

    // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
    function toggleTheme() {
        if (!editor) return;

        currentTheme = currentTheme === 'vs' ? 'vs-dark' : 'vs';
        monaco.editor.setTheme(currentTheme);

        const themeButton = document.getElementById('themeToggle');
        const icon = themeButton.querySelector('i');
        const text = themeButton.querySelector('span') || themeButton.childNodes[1];

        if (currentTheme === 'vs-dark') {
            icon.className = 'fas fa-sun';
            text.textContent = ' ‰∫ÆËâ≤‰∏ªÈ¢ò';
        } else {
            icon.className = 'fas fa-moon';
            text.textContent = ' ÊöóËâ≤‰∏ªÈ¢ò';
        }
    }

    // ‰ª£Á†ÅÊ†ºÂºèÂåñÂäüËÉΩ
    function formatCode() {
        if (!editor) {
            // Fallback Ê®°Âºè‰∏ãÁöÑÁÆÄÂçïÊ†ºÂºèÂåñ
            const fallbackEditor = document.getElementById('fallbackEditor');
            if (fallbackEditor) {
                let code = fallbackEditor.value;
                // ÁÆÄÂçïÁöÑ C++ Ê†ºÂºèÂåñ
                code = code
                    .replace(/\s*{\s*/g, ' {\n    ')  // Ê†ºÂºèÂåñÂ∑¶Â§ßÊã¨Âè∑
                    .replace(/\s*}\s*/g, '\n}\n')     // Ê†ºÂºèÂåñÂè≥Â§ßÊã¨Âè∑
                    .replace(/;\s*/g, ';\n')          // Ê†ºÂºèÂåñÂàÜÂè∑
                    .replace(/\n\s*\n\s*\n/g, '\n\n') // ÁßªÈô§Â§ö‰ΩôÁ©∫Ë°å
                    .trim();

                fallbackEditor.value = code;
                document.getElementById('codeEditorHidden').value = code;
                showToast('‰ª£Á†ÅÂ∑≤Ê†ºÂºèÂåñ', 'success', 2000);
            }
            return;
        }

        try {
            // ‰ΩøÁî® Monaco Editor ÁöÑÂÜÖÁΩÆÊ†ºÂºèÂåñ
            const model = editor.getModel();
            if (model) {
                // Ëé∑ÂèñÊ†ºÂºèÂåñÊèê‰æõËÄÖ
                const formattingProvider = monaco.languages.getDocumentFormattingEditProvider('cpp');
                if (formattingProvider) {
                    // ‰ΩøÁî®Ê†ºÂºèÂåñÊèê‰æõËÄÖ
                    formattingProvider.provideDocumentFormattingEdits(model, {
                        insertSpaces: true,
                        tabSize: 4
                    }).then(edits => {
                        if (edits && edits.length > 0) {
                            editor.executeEdits('format', edits);
                            showToast('‰ª£Á†ÅÂ∑≤Ê†ºÂºèÂåñ', 'success', 2000);
                        } else {
                            // Â¶ÇÊûúÊ†ºÂºèÂåñÊèê‰æõËÄÖ‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÊâãÂä®Ê†ºÂºèÂåñ
                            const value = model.getValue();
                            const formatted = formatCppCode(value);
                            editor.setValue(formatted);
                            showToast('‰ª£Á†ÅÂ∑≤Ê†ºÂºèÂåñ', 'success', 2000);
                        }
                    }).catch(() => {
                        // Â¶ÇÊûúÊ†ºÂºèÂåñÊèê‰æõËÄÖÂ§±Ë¥•Ôºå‰ΩøÁî®ÊâãÂä®Ê†ºÂºèÂåñ
                        const value = model.getValue();
                        const formatted = formatCppCode(value);
                        editor.setValue(formatted);
                        showToast('‰ª£Á†ÅÂ∑≤Ê†ºÂºèÂåñ', 'success', 2000);
                    });
                } else {
                    // Â¶ÇÊûúÊ†ºÂºèÂåñÊèê‰æõËÄÖ‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÊâãÂä®Ê†ºÂºèÂåñ
                    const value = model.getValue();
                    const formatted = formatCppCode(value);
                    editor.setValue(formatted);
                    showToast('‰ª£Á†ÅÂ∑≤Ê†ºÂºèÂåñ', 'success', 2000);
                }
            }
        } catch (error) {
            console.error('Ê†ºÂºèÂåñÂ§±Ë¥•:', error);
            // ‰ΩøÁî®ÊâãÂä®Ê†ºÂºèÂåñ‰Ωú‰∏∫Â§áÁî®
            try {
                const model = editor.getModel();
                if (model) {
                    const value = model.getValue();
                    const formatted = formatCppCode(value);
                    editor.setValue(formatted);
                    showToast('‰ª£Á†ÅÂ∑≤Ê†ºÂºèÂåñ', 'success', 2000);
                }
            } catch (fallbackError) {
                console.error('Â§áÁî®Ê†ºÂºèÂåñ‰πüÂ§±Ë¥•:', fallbackError);
                showToast('Ê†ºÂºèÂåñÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®Ë∞ÉÊï¥‰ª£Á†Å', 'error', 3000);
            }
        }
    }

    // ÁÆÄÂçïÁöÑ C++ ‰ª£Á†ÅÊ†ºÂºèÂåñÂáΩÊï∞
    function formatCppCode(code) {
        let lines = code.split('\n');
        let formatted = [];
        let indentLevel = 0;
        const indent = '    '; // 4‰∏™Á©∫Ê†º

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();

            // Ë∑≥ËøáÁ©∫Ë°å
            if (!line) {
                formatted.push('');
                continue;
            }

            // Â§ÑÁêÜÁâπÊÆäË°å
            if (line.startsWith('#include') || line.startsWith('using namespace')) {
                formatted.push(line);
                continue;
            }

            // ÂáèÂ∞ëÁº©ËøõÔºàÂú®Âè≥Â§ßÊã¨Âè∑ÂâçÔºâ
            if (line.startsWith('}')) {
                indentLevel = Math.max(0, indentLevel - 1);
            }

            // Ê∑ªÂä†Áº©Ëøõ
            formatted.push(indent.repeat(indentLevel) + line);

            // Â¢ûÂä†Áº©ËøõÔºàÂú®Â∑¶Â§ßÊã¨Âè∑ÂêéÔºâ
            if (line.endsWith('{')) {
                indentLevel++;
            }

            // ÁâπÊÆäÂ§ÑÁêÜÔºöÂ¶ÇÊûú‰∏ã‰∏ÄË°åÊòØÂè≥Â§ßÊã¨Âè∑ÔºåÂáèÂ∞ëÁº©Ëøõ
            if (i < lines.length - 1) {
                let nextLine = lines[i + 1].trim();
                if (nextLine.startsWith('}')) {
                    // ÂΩìÂâçË°åÂêéÈù¢Â∫îËØ•ÊúâÁ©∫Ë°å
                    if (!lines[i + 1].trim()) {
                        formatted.push('');
                    }
                }
            }
        }

        return formatted.join('\n');
    }

    // ÂàùÂßãÂåñËá™ÂÆö‰πâÈÄâÊã©Ê°Ü
    function initCustomSelect() {
        const customSelect = document.getElementById('languageSelect');
        const selected = customSelect.querySelector('.select-selected');
        const itemsContainer = customSelect.querySelector('.select-items');
        const items = customSelect.querySelectorAll('.select-item');

        // ÁÇπÂáªÈÄâ‰∏≠Âå∫ÂüüÂàáÊç¢ÊòæÁ§∫/ÈöêËóè
        selected.addEventListener('click', function(e) {
            e.stopPropagation();
            closeAllSelect(this);
            itemsContainer.classList.toggle('active');
            this.classList.toggle('select-arrow-active');

            // Á°Æ‰øù‰∏ãÊãâÊ°ÜÊòæÁ§∫
            if (itemsContainer.classList.contains('active')) {
                itemsContainer.style.display = 'block';
            }
        });

        // ÁÇπÂáªÈÄâÈ°π
        items.forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();

                // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
                items.forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');

                // Êõ¥Êñ∞ÊòæÁ§∫ÊñáÊú¨
                const text = this.querySelector('span:last-child').textContent;
                selected.textContent = text;

                // Êõ¥Êñ∞ÈöêËóèËæìÂÖ•Ê°ÜÁöÑÂÄº
                const value = this.getAttribute('data-value');
                document.getElementById('languageSelectHidden').value = value;

                // ÂàáÊç¢ËØ≠Ë®Ä
                switchLanguage(value);

                // ÂÖ≥Èó≠‰∏ãÊãâÊ°Ü
                itemsContainer.classList.remove('active');
                itemsContainer.style.display = 'none';
                selected.classList.remove('select-arrow-active');
            });
        });
    }

    // ÂÖ≥Èó≠ÊâÄÊúâÈÄâÊã©Ê°Ü
    function closeAllSelect(elmnt) {
        const selectItems = document.querySelectorAll('.select-items');
        const selectSelected = document.querySelectorAll('.select-selected');

        selectItems.forEach(item => {
            if (elmnt && item !== elmnt.nextElementSibling && elmnt !== item) {
                item.classList.remove('active');
                item.style.display = 'none';
            }
        });

        selectSelected.forEach(selected => {
            if (elmnt && selected !== elmnt) {
                selected.classList.remove('select-arrow-active');
            }
        });
    }

    // ÁÇπÂáªÈ°µÈù¢ÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ÈÄâÊã©Ê°Ü
    document.addEventListener('click', function(e) {
        closeAllSelect(e.target);
    });

    // ÁªëÂÆö‰∏ªÈ¢òÂàáÊç¢‰∫ã‰ª∂
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    // ÁªëÂÆö‰ª£Á†ÅÊ†ºÂºèÂåñ‰∫ã‰ª∂
    document.getElementById('formatCode').addEventListener('click', formatCode);

    // Ëé∑ÂèñÈ¢òÁõÆÊ†áÁ≠æ
    async function fetchProblemTags(problemId, token) {
        try {
            const params = new URLSearchParams({
                pid:problemId
            });
            const response = await fetch(`/problem/tags?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (data.code !== 200) throw new Error(data.msg || 'Ëé∑ÂèñÊ†áÁ≠æÂ§±Ë¥•');
            return data.data || [];
        } catch (error) {
            console.error('Ê†áÁ≠æËé∑ÂèñÂ§±Ë¥•:', error);
            showToast('Ê†áÁ≠æÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            return [];
        }
    }

    // ËæÖÂä©ÂáΩÊï∞
    function saveDraft() {
        localStorage.setItem('codeDraft', editor.getValue());
        showToast('‰ª£Á†ÅËçâÁ®øÂ∑≤Ëá™Âä®‰øùÂ≠ò', 'info', 2000);
    }

    // ÊòæÁ§∫Êèê‰∫§ÁªìÊûúÂà∞ÊåâÈíÆÂ∑¶ËæπÔºà‰∏ÄÁõ¥‰øùÊåÅÔºâ
    function showSubmitResult(data) {
        const resultElement = document.getElementById('submitResult');
        
        let resultClass = 'info';
        let resultText = '';
        let errorInfo = null;
        
        if (data.code === 200) {
            const judgeResult = data.data;
            if (judgeResult.status === "Á≠îÊ°àÊ≠£Á°Æ") {
                resultClass = 'success';
                resultText = '‚úì Á≠îÊ°àÊ≠£Á°Æ';
            } else {
                resultClass = 'error';
                resultText = '‚úó ' + (judgeResult.status || 'Êú™Áü•ÈîôËØØ');
                errorInfo = judgeResult.errorInfo;
            }
        } else {
            resultClass = 'error';
            resultText = '‚úó ' + (data.msg || 'Êèê‰∫§Â§±Ë¥•');
        }
        
        resultElement.className = `submit-result ${resultClass}`;
        resultElement.textContent = resultText;
        
        // Â¶ÇÊûúÊúâÈîôËØØ‰ø°ÊÅØÔºåÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
        if (errorInfo) {
            resultElement.style.cursor = 'pointer';
            resultElement.innerHTML = resultText + ' <span style="font-size: 12px; opacity: 0.8;">(ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ)</span>';
            resultElement.onclick = () => showErrorDetail(errorInfo);
        } else {
            resultElement.style.cursor = 'default';
            resultElement.onclick = null;
        }
        
        // ÁªìÊûú‰∏ÄÁõ¥‰øùÊåÅÊòæÁ§∫Ôºå‰∏çËá™Âä®Ê∏ÖÈô§
    }
    
    function showErrorDetail(errorInfo) {
        // ÂàõÂª∫ÂºπÁ™ó
        const modal = document.createElement('div');
        modal.className = 'error-detail-modal';
        modal.innerHTML = `
            <div class="error-detail-content">
                <div class="error-detail-header">
                    <div class="error-detail-title">ÈîôËØØËØ¶ÊÉÖ</div>
                    <button class="error-detail-close">&times;</button>
                </div>
                <div class="error-detail-body">
                    ${formatErrorInfo(errorInfo)}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // ÊòæÁ§∫ÂºπÁ™ó
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        
        // ÂÖ≥Èó≠ÂºπÁ™ó‰∫ã‰ª∂
        const closeBtn = modal.querySelector('.error-detail-close');
        const closeModal = () => {
            modal.classList.remove('show');
            setTimeout(() => {
                if (modal.parentNode) {
                    document.body.removeChild(modal);
                }
            }, 300);
        };
        
        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // ESCÈîÆÂÖ≥Èó≠
        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
    }
    
    function formatErrorInfo(errorInfo) {
        if (!errorInfo) return '';
        
        // Â§ÑÁêÜÊç¢Ë°åÁ¨¶
        let formatted = errorInfo.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÊµãËØïÁî®‰æã‰ø°ÊÅØ
        if (formatted.includes('ËæìÂÖ•:') && formatted.includes('ÊúüÂæÖËæìÂá∫:') && formatted.includes('ÂÆûÈôÖËæìÂá∫:')) {
            // Ëß£ÊûêÊµãËØïÁî®‰æã‰ø°ÊÅØ
            const lines = formatted.split('\n');
            let result = '<div class="test-case-info">';
            let lineCount = 0;
            const maxLines = 20; // ÊúÄÂ§öÊòæÁ§∫20Ë°å
            
            for (let line of lines) {
                line = line.trim();
                if (lineCount >= maxLines) {
                    result += '<div class="test-case-item" style="color: #6c757d; font-style: italic;">... (Êõ¥Â§öÂÜÖÂÆπÂ∑≤ÁúÅÁï•)</div>';
                    break;
                }
                
                if (line.startsWith('ËæìÂÖ•:')) {
                    result += `<div class="test-case-item"><span class="label">ËæìÂÖ•:</span> <code>${line.substring(3).trim()}</code></div>`;
                    lineCount++;
                } else if (line.startsWith('ÊúüÂæÖËæìÂá∫:')) {
                    result += `<div class="test-case-item"><span class="label">ÊúüÂæÖËæìÂá∫:</span> <code>${line.substring(5).trim()}</code></div>`;
                    lineCount++;
                } else if (line.startsWith('ÂÆûÈôÖËæìÂá∫:')) {
                    result += `<div class="test-case-item"><span class="label">ÂÆûÈôÖËæìÂá∫:</span> <code>${line.substring(5).trim() || '(Á©∫)'}</code></div>`;
                    lineCount++;
                } else if (line) {
                    result += `<div class="test-case-item">${line}</div>`;
                    lineCount++;
                }
            }
            
            result += '</div>';
            return result;
        } else {
            // ÊôÆÈÄöÈîôËØØ‰ø°ÊÅØÔºåÈôêÂà∂Ë°åÊï∞
            const lines = formatted.split('\n');
            const maxLines = 15; // ÊúÄÂ§öÊòæÁ§∫15Ë°å
            if (lines.length > maxLines) {
                const truncatedLines = lines.slice(0, maxLines);
                return truncatedLines.join('<br>') + '<br><span style="color: #6c757d; font-style: italic;">... (Êõ¥Â§öÂÜÖÂÆπÂ∑≤ÁúÅÁï•)</span>';
            }
            return formatted.replace(/\n/g, '<br>');
        }
    }

    // ÊòæÁ§∫ÁæéÂåñÁöÑÊèêÁ§∫Ê°Ü
    function showToast(message, type = 'info', duration = 3000) {
        // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑtoast
        const existingToast = document.querySelector('.status-toast');
        if (existingToast) {
            existingToast.remove();
        }

        // ÂàõÂª∫Êñ∞ÁöÑtoast
        const toast = document.createElement('div');
        toast.className = `status-toast status-${type}`;

        // Ê†πÊçÆÁ±ªÂûãÊ∑ªÂä†‰∏çÂêåÁöÑÂõæÊ†á
        let icon = '';
        if (type === 'success') {
            icon = '<i class="fas fa-check-circle"></i>';
        } else if (type === 'error') {
            icon = '<i class="fas fa-times-circle"></i>';
        } else {
            icon = '<i class="fas fa-info-circle"></i>';
        }

        toast.innerHTML = `${icon}<span>${message}</span>`;
        document.body.appendChild(toast);

        // ÊòæÁ§∫Âä®Áîª
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        // Ëá™Âä®Ê∂àÂ§±
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // ÊòæÁ§∫Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂØπËØùÊ°Ü
    function showConfirmDialog(message) {
        return new Promise((resolve) => {
            // ÂàõÂª∫ÈÅÆÁΩ©Â±Ç
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;

            // ÂàõÂª∫ÂØπËØùÊ°Ü
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 24px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                transform: scale(0.9);
                transition: transform 0.3s ease;
            `;

            dialog.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-question-circle" style="font-size: 2rem; color: #667eea; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-size: 1.1rem; color: #2d3748; line-height: 1.5;">${message}</p>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button id="confirmCancel" style="
                        padding: 10px 20px;
                        border: 1px solid #e2e8f0;
                        background: white;
                        color: #4a5568;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.95rem;
                        transition: all 0.2s ease;
                    ">ÂèñÊ∂à</button>
                    <button id="confirmOk" style="
                        padding: 10px 20px;
                        border: none;
                        background: #e53e3e;
                        color: white;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.95rem;
                        transition: all 0.2s ease;
                    ">Á°ÆÂÆö</button>
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // ÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                overlay.style.opacity = '1';
                dialog.style.transform = 'scale(1)';
            }, 10);

            // ÁªëÂÆö‰∫ã‰ª∂
            const cancelBtn = dialog.querySelector('#confirmCancel');
            const okBtn = dialog.querySelector('#confirmOk');

            const cleanup = () => {
                overlay.style.opacity = '0';
                dialog.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 300);
            };

            cancelBtn.addEventListener('click', () => {
                cleanup();
                resolve(false);
            });

            okBtn.addEventListener('click', () => {
                cleanup();
                resolve(true);
            });

            // ÁÇπÂáªÈÅÆÁΩ©Â±ÇÂÖ≥Èó≠
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    cleanup();
                    resolve(false);
                }
            });

            // ÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú
            cancelBtn.addEventListener('mouseenter', () => {
                cancelBtn.style.background = '#f7fafc';
                cancelBtn.style.borderColor = '#cbd5e0';
            });
            cancelBtn.addEventListener('mouseleave', () => {
                cancelBtn.style.background = 'white';
                cancelBtn.style.borderColor = '#e2e8f0';
            });

            okBtn.addEventListener('mouseenter', () => {
                okBtn.style.background = '#c53030';
            });
            okBtn.addEventListener('mouseleave', () => {
                okBtn.style.background = '#e53e3e';
            });
        });
    }

    function formatTime(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // È°µÈù¢Âä†ËΩΩÂàùÂßãÂåñ
    window.addEventListener('DOMContentLoaded', async () => {
        if (!localStorage.getItem('token')) {
            showToast('ËØ∑ÂÖàÁôªÂΩïÔºÅ', 'error');
            setTimeout(() => {
                window.location.href = '/index.html';
            }, 1500);
            return;
        }

        // ÂàùÂßãÂåñ Monaco Editor
        initMonacoEditor();

        // ÂàùÂßãÂåñËá™ÂÆö‰πâÈÄâÊã©Ê°Ü
        initCustomSelect();

        // Á≠âÂæÖ Monaco Editor Âä†ËΩΩÂÆåÊàêÔºåÂ¶ÇÊûúÂ§±Ë¥•Âàô‰ΩøÁî® fallback
        setTimeout(() => {
            // Ê£ÄÊü•ÊòØÂê¶ÂàùÂßãÂåñÊàêÂäü
            if (!editor) {
                console.log('Monaco Editor ÂàùÂßãÂåñÂ§±Ë¥•Ôºå‰ΩøÁî® fallback textarea');
                const editorElement = document.getElementById('codeEditor');
                if (editorElement && !document.getElementById('fallbackEditor')) {
                    editorElement.innerHTML = '<textarea id="fallbackEditor" style="width: 100%; height: 100%; border: none; outline: none; font-family: monospace; font-size: 14px; padding: 10px; resize: none;">#include <iostream>\nusing namespace std;\n\nint main() {\n    // ËØ∑Âú®Ê≠§Â§ÑÁºñÂÜô‰Ω†ÁöÑ‰ª£Á†Å\n    \n    return 0;\n}</textarea>';

                    // ÁªëÂÆö fallback editor ÁöÑ‰∫ã‰ª∂
                    const fallbackEditor = document.getElementById('fallbackEditor');
                    if (fallbackEditor) {
                        fallbackEditor.addEventListener('input', function() {
                            document.getElementById('codeEditorHidden').value = this.value;
                        });
                    }
                }
            }

            // ÂàùÂßãËÆæÁΩÆ‰∏∫C++17
            switchLanguage('cpp');
        }, 2000);

        // Ê∏≤ÊüìMarkdownÂÜÖÂÆπ
        if (typeof DOMPurify !== 'undefined') {
            renderMarkdownElements();
        }

        // Âä†ËΩΩÊ†áÁ≠æ
        const problemId = document.querySelector('input[name="problemId"]').value;
        const token = localStorage.getItem('token');
        const tagsContainer = document.getElementById('tagsContainer');

        if (problemId) {
            const tags = await fetchProblemTags(problemId, token);
            if (tags.length > 0) {
                tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.textContent = tag.name || tag;
                    tagsContainer.appendChild(tagElement);
                });
            } else {
                const noTags = document.createElement('span');
                noTags.className = 'text-muted';
                noTags.style.fontSize = '0.9rem';
                noTags.textContent = 'Êó†Ê†áÁ≠æ';
                tagsContainer.appendChild(noTags);
            }
        }
    });

    // Ë°®ÂçïÊèê‰∫§Â§ÑÁêÜ
    document.getElementById('submitForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalButtonText = submitBtn.innerHTML;
        const option = document.getElementById('languageSelectHidden').value;

        if (option === "java") {
            showToast("ÊöÇ‰∏çÊîØÊåÅÁî®JavaÊèê‰∫§ÔºåËØ∑Á≠âÂæÖ", 'error');
            return;
        }

        // ÊòæÁ§∫Êèê‰∫§‰∏≠ÁöÑÊèêÁ§∫
        showToast('ËØÑÊµã‰∏≠ÔºåËØ∑Á®çÂÄô...', 'info', 10000);

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Êèê‰∫§‰∏≠...';

        // ÊèêÂèñÊó∂Èó¥ÂíåÂÜÖÂ≠òÈôêÂà∂
        const timeText = document.getElementById('time').textContent;
        const timeValue = timeText.split('Ôºö')[1].split(' ')[0];

        const memoryText = document.getElementById('memory').textContent;
        const memoryValue = memoryText.split('Ôºö')[1].split(' ')[0];

        try {
            const currentDate = new Date();
            let code = '';

            if (editor) {
                // Monaco Editor Ê®°Âºè
                code = editor.getValue();
            } else {
                // Fallback textarea Ê®°Âºè
                const fallbackEditor = document.getElementById('fallbackEditor');
                if (fallbackEditor) {
                    code = fallbackEditor.value;
                } else {
                    code = document.getElementById('codeEditorHidden').value;
                }
            }

            const pid = document.querySelector('input[name="problemId"]').value;
            const uname = localStorage.getItem('name');
            const cid = "0";
            const create_time = formatTime(currentDate);
            const time = timeValue;
            const memory = memoryValue;

            const response = await fetch('/judge/submit', {
                method: 'POST',
                body: JSON.stringify({ code, option, pid, uname, cid, create_time, time, memory }),
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            // ÊòæÁ§∫ÁªìÊûúÂà∞ÊåâÈíÆÂ∑¶ËæπÔºà‰∏ÄÁõ¥‰øùÊåÅÔºâ
            showSubmitResult(data);
            
            // ÂêåÊó∂ÊòæÁ§∫Âè≥‰∏äËßíÈÄöÁü•
            if (data.code === 200) {
                const judgeResult = data.data;
                if(judgeResult.status === "Á≠îÊ°àÊ≠£Á°Æ"){
                    showToast(`${judgeResult.status}ÔºÅ`, 'success', 5000);
                }
                else{
                    showToast(`${judgeResult.status || judgeResult.errorInfo || 'Êú™Áü•ÈîôËØØ'}ÔºÅ`, 'error', 5000);
                }
            } else {
                showToast(`${data.msg}ÔºÅ`, 'error', 5000);
            }

        } catch (error) {
            showToast('ÁΩëÁªúËøûÊé•ÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalButtonText;
        }
    });

    // ËØÑËÆ∫ÂäüËÉΩÁõ∏ÂÖ≥‰ª£Á†Å
    let currentProblemId = null;
    let currentUserId = null;
    let currentUsername = null;
    let currentReceiveUserId = null; // ÂΩìÂâçÂõûÂ§çÁöÑÁõÆÊ†áÁî®Êà∑ID

    // ÂàùÂßãÂåñËØÑËÆ∫ÂäüËÉΩ
    function initCommentSystem() {
        currentProblemId = document.querySelector('input[name="problemId"]').value;
        currentUserId = localStorage.getItem('id');
        currentUsername = localStorage.getItem('name');

        if (!currentUserId || !currentUsername) {
            showToast('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜçÂèëË°®ËØÑËÆ∫', 'error');
            return;
        }

        // Âä†ËΩΩËØÑËÆ∫ÂàóË°®
        loadComments();

        // ÁªëÂÆö‰∫ã‰ª∂
        bindCommentEvents();

        // ÂàùÂßãÂåñemojiÈÄâÊã©Âô®
        initEmojiPicker();

        // Ê£ÄÊü•URLÂèÇÊï∞‰∏≠ÊòØÂê¶ÊúâcommentIdÔºåÂ¶ÇÊûúÊúâÂàôËá™Âä®ÂÆö‰ΩçÂíåÈ´ò‰∫Æ
        const urlParams = new URLSearchParams(window.location.search);
        const commentId = urlParams.get('commentId');
        if (commentId) {
            // Âª∂ËøüÊâßË°åÔºåÁ°Æ‰øùËØÑËÆ∫Â∑≤ÁªèÂä†ËΩΩÂÆåÊàê
            setTimeout(() => {
                highlightComment(commentId);
            }, 1000);
        }
    }

    // ÁªëÂÆöËØÑËÆ∫Áõ∏ÂÖ≥‰∫ã‰ª∂
    function bindCommentEvents() {
        // ÂèëË°®ËØÑËÆ∫
        document.getElementById('submitComment').addEventListener('click', submitComment);

        // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÂõûÂ§çÂíåÂà†Èô§ÊåâÈíÆ
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('reply') || e.target.closest('.reply')) {
                e.preventDefault();
                const replyBtn = e.target.classList.contains('reply') ? e.target : e.target.closest('.reply');
                const commentId = replyBtn.dataset.commentId;
                currentReceiveUserId = replyBtn.dataset.receiveUserId; // ‰øùÂ≠òË¢´ÂõûÂ§çÁî®Êà∑ÁöÑID
                showReplyForm(commentId);
            } else if (e.target.classList.contains('delete') || e.target.closest('.delete')) {
                e.preventDefault();
                const deleteBtn = e.target.classList.contains('delete') ? e.target : e.target.closest('.delete');
                const commentId = deleteBtn.dataset.commentId;
                deleteComment(commentId);
            } else if (e.target.classList.contains('submit-reply')) {
                e.preventDefault();
                const commentId = e.target.dataset.commentId;
                submitReply(commentId);
            } else if (e.target.classList.contains('cancel-reply')) {
                e.preventDefault();
                const commentId = e.target.dataset.commentId;
                hideReplyForm(commentId);
            }
        });
    }

    // Âä†ËΩΩËØÑËÆ∫ÂàóË°®
    async function loadComments() {
        try {
            const response = await fetch(`/comment/list?pid=${currentProblemId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            if (data.code === 200) {
                renderComments(data.data);
                updateCommentCount(data.data.length);
            } else {
                showToast('Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•', 'error');
            }
        } catch (error) {
            console.error('Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•:', error);
            showToast('ÁΩëÁªúËøûÊé•ÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï', 'error');
        }
    }

    // Ê∏≤ÊüìËØÑËÆ∫ÂàóË°®
    function renderComments(comments) {
        const commentList = document.getElementById('commentList');

        if (!comments || comments.length === 0) {
            commentList.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i>
                    <p>ÊöÇÊó†ËØÑËÆ∫ÔºåÂø´Êù•ÂèëË°®Á¨¨‰∏ÄÊù°ËØÑËÆ∫ÂêßÔºÅ</p>
                </div>
            `;
            return;
        }

        commentList.innerHTML = comments.map(comment => renderCommentItem(comment)).join('');
    }

    // Ê∏≤ÊüìÂçï‰∏™ËØÑËÆ∫È°πÔºàÈ°∂Á∫ßËØÑËÆ∫Ôºâ
    function renderCommentItem(comment) {
        const isOwner = comment.userId == currentUserId;
        const avatarText = comment.username ? comment.username.charAt(0).toUpperCase() : 'U';

        // Ê∏≤ÊüìÂ≠êËØÑËÆ∫
        let subcommentsHtml = '';
        if (comment.subcommentList && comment.subcommentList.length > 0) {
            subcommentsHtml = `
                <div class="subcomment-list">
                    ${comment.subcommentList.map(subcomment => renderSubcommentItem(subcomment)).join('')}
                </div>
            `;
        }

        return `
            <div class="comment-item" data-comment-id="${comment.id}">
                <div class="comment-header">
                    <div class="comment-author">
                        <div class="avatar">${avatarText}</div>
                        <span class="name">${comment.username || 'ÂåøÂêçÁî®Êà∑'}</span>
                    </div>
                    <div class="comment-time">${formatCommentTime(comment.createTime)}</div>
                </div>
                <div class="comment-content">${escapeHtml(comment.content)}</div>
                <div class="comment-actions">
                    <button class="comment-action reply" data-comment-id="${comment.id}" data-receive-user-id="${comment.userId}">
                        <i class="fas fa-reply me-1"></i>ÂõûÂ§ç
                    </button>
                    ${isOwner ? `
                        <button class="comment-action delete" data-comment-id="${comment.id}">
                            <i class="fas fa-trash me-1"></i>Âà†Èô§
                        </button>
                    ` : ''}
                </div>
                <div class="reply-form" id="reply-form-${comment.id}">
                    <textarea placeholder="ÂõûÂ§ç ${comment.username || 'ÂåøÂêçÁî®Êà∑'}..." rows="3"></textarea>
                    <div class="reply-actions">
                        <button class="reply-btn secondary cancel-reply" data-comment-id="${comment.id}">ÂèñÊ∂à</button>
                        <button class="reply-btn primary submit-reply" data-comment-id="${comment.id}">ÂõûÂ§ç</button>
                    </div>
                </div>
                ${subcommentsHtml}
            </div>
        `;
    }

    // Ê∏≤ÊüìÂ≠êËØÑËÆ∫È°π
    function renderSubcommentItem(subcomment) {
        const isOwner = subcomment.userId == currentUserId;
        const avatarText = subcomment.username ? subcomment.username.charAt(0).toUpperCase() : 'U';

        // ÊûÑÂª∫ÂõûÂ§çÊòæÁ§∫ÊñáÊú¨
        let replyText = '';
        if (subcomment.parentId && subcomment.parentUsername) {
            replyText = `<span class="reply-to">ÂõûÂ§ç <span class="reply-username">@${subcomment.parentUsername}</span></span>`;
        }

        return `
            <div class="subcomment-item" data-comment-id="${subcomment.id}">
                <div class="comment-header">
                    <div class="comment-author">
                        <div class="avatar">${avatarText}</div>
                        <span class="name">${subcomment.username || 'ÂåøÂêçÁî®Êà∑'}</span>
                        ${replyText}
                    </div>
                    <div class="comment-time">${formatCommentTime(subcomment.createTime)}</div>
                </div>
                <div class="comment-content">${escapeHtml(subcomment.content)}</div>
                <div class="comment-actions">
                    <button class="comment-action reply" data-comment-id="${subcomment.id}" data-receive-user-id="${subcomment.userId}">
                        <i class="fas fa-reply me-1"></i>ÂõûÂ§ç
                    </button>
                    ${isOwner ? `
                        <button class="comment-action delete" data-comment-id="${subcomment.id}">
                            <i class="fas fa-trash me-1"></i>Âà†Èô§
                        </button>
                    ` : ''}
                </div>
                <div class="reply-form" id="reply-form-${subcomment.id}">
                    <textarea placeholder="ÂõûÂ§ç ${subcomment.username || 'ÂåøÂêçÁî®Êà∑'}..." rows="3"></textarea>
                    <div class="reply-actions">
                        <button class="reply-btn secondary cancel-reply" data-comment-id="${subcomment.id}">ÂèñÊ∂à</button>
                        <button class="reply-btn primary submit-reply" data-comment-id="${subcomment.id}">ÂõûÂ§ç</button>
                    </div>
                </div>
            </div>
        `;
    }


    // ÂèëË°®ËØÑËÆ∫
    async function submitComment() {
        const content = document.getElementById('commentContent').value.trim();

        if (!content) {
            showToast('ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ', 'error');
            return;
        }

        if (!currentUserId || !currentUsername) {
            showToast('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜçÂèëË°®ËØÑËÆ∫', 'error');
            return;
        }

        try {
            const response = await fetch('/comment/publish', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    problemId: parseInt(currentProblemId),
                    parentId: null,
                    receiveUserId: null, // È°∂Á∫ßËØÑËÆ∫Ê≤°ÊúâÂõûÂ§çÁâπÂÆöÁî®Êà∑
                    username: currentUsername,
                    content: content,
                    createTime: new Date().toISOString()
                })
            });

            const data = await response.json();
            if (data.code === 200) {
                showToast('ËØÑËÆ∫ÂèëË°®ÊàêÂäü', 'success');
                document.getElementById('commentContent').value = '';
                loadComments(); // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫ÂàóË°®
            } else {
                showToast(data.msg || 'ËØÑËÆ∫ÂèëË°®Â§±Ë¥•', 'error');
            }
        } catch (error) {
            console.error('ÂèëË°®ËØÑËÆ∫Â§±Ë¥•:', error);
            showToast('ÁΩëÁªúËøûÊé•ÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï', 'error');
        }
    }

    // ÊòæÁ§∫ÂõûÂ§çË°®Âçï
    function showReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
            replyForm.classList.add('show');
            replyForm.querySelector('textarea').focus();
        }
    }

    // ÈöêËóèÂõûÂ§çË°®Âçï
    function hideReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
            replyForm.classList.remove('show');
            replyForm.querySelector('textarea').value = '';
        }
        currentReceiveUserId = null; // Ê∏ÖÁ©∫Ë¢´ÂõûÂ§çÁî®Êà∑ID
    }

    // Êèê‰∫§ÂõûÂ§ç
    async function submitReply(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        const content = replyForm.querySelector('textarea').value.trim();

        if (!content) {
            showToast('ËØ∑ËæìÂÖ•ÂõûÂ§çÂÜÖÂÆπ', 'error');
            return;
        }

        if (!currentUserId || !currentUsername) {
            showToast('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜçÂèëË°®ÂõûÂ§ç', 'error');
            return;
        }

        try {
            const response = await fetch('/comment/publish', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    problemId: parseInt(currentProblemId),
                    parentId: parseInt(commentId),
                    receiveUserId: currentReceiveUserId ? parseInt(currentReceiveUserId) : null,
                    username: currentUsername,
                    content: content,
                    createTime: new Date().toISOString()
                })
            });

            const data = await response.json();
            if (data.code === 200) {
                showToast('ÂõûÂ§çÂèëË°®ÊàêÂäü', 'success');
                hideReplyForm(commentId);
                loadComments(); // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫ÂàóË°®
            } else {
                showToast(data.msg || 'ÂõûÂ§çÂèëË°®Â§±Ë¥•', 'error');
            }
        } catch (error) {
            console.error('ÂèëË°®ÂõûÂ§çÂ§±Ë¥•:', error);
            showToast('ÁΩëÁªúËøûÊé•ÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï', 'error');
        }
    }

    // Âà†Èô§ËØÑËÆ∫
    async function deleteComment(commentId) {
        // ‰ΩøÁî®Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂØπËØùÊ°Ü
        const confirmed = await showConfirmDialog('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºü');
        if (!confirmed) {
            return;
        }

        try {
            const response = await fetch(`/comment/delete?commentId=${commentId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            if (data.code === 200) {
                showToast('ËØÑËÆ∫Âà†Èô§ÊàêÂäü', 'success');
                loadComments(); // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫ÂàóË°®
            } else {
                showToast(data.msg || 'ËØÑËÆ∫Âà†Èô§Â§±Ë¥•', 'error');
            }
        } catch (error) {
            console.error('Âà†Èô§ËØÑËÆ∫Â§±Ë¥•:', error);
            showToast('ÁΩëÁªúËøûÊé•ÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï', 'error');
        }
    }

    // Êõ¥Êñ∞ËØÑËÆ∫Êï∞Èáè
    function updateCommentCount(count) {
        const commentCountElement = document.getElementById('commentCount');
        if (commentCountElement) {
            commentCountElement.textContent = count;
        }
    }

    // ËΩ¨‰πâHTMLÂ≠óÁ¨¶
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Ê†ºÂºèÂåñÊó∂Èó¥ÔºàËØÑËÆ∫‰∏ìÁî®Ôºâ
    function formatCommentTime(timeString) {
        const date = new Date(timeString);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) { // 1ÂàÜÈíüÂÜÖ
            return 'ÂàöÂàö';
        } else if (diff < 3600000) { // 1Â∞èÊó∂ÂÜÖ
            return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
        } else if (diff < 86400000) { // 1Â§©ÂÜÖ
            return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
        } else if (diff < 2592000000) { // 30Â§©ÂÜÖ
            return Math.floor(diff / 86400000) + 'Â§©Ââç';
        } else {
            return date.toLocaleDateString();
        }
    }

    // EmojiÈÄâÊã©Âô®ÂäüËÉΩ
    function initEmojiPicker() {
        const emojiTrigger = document.getElementById('emojiTrigger');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiGrid = document.getElementById('emojiGrid');
        const commentTextarea = document.getElementById('commentContent');

        // EmojiÊï∞ÊçÆ
        const emojiData = {
            smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê'],
            people: ['üë∂', 'üßí', 'üë¶', 'üëß', 'üßë', 'üë®', 'üë©', 'üßì', 'üë¥', 'üëµ', 'üë§', 'üë•', 'ü´Ç', 'üëã', 'ü§ö', 'üñê', '‚úã', 'üññ', 'üëå', 'ü§è', '‚úå', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òù', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úç', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅ', 'üëÖ', 'üëÑ', 'üíã', 'ü©∏'],
            animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'ü¶ç', 'ü¶ß', 'üêï', 'üê©', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üêà', 'üêà‚Äç‚¨õ', 'ü¶Ñ', 'üêé', 'ü¶ì', 'ü¶å', 'üêÇ', 'üêÉ', 'üêÑ', 'üê™', 'üê´', 'ü¶ô', 'ü¶í', 'üêò', 'ü¶è', 'ü¶õ', 'üêê', 'üêë', 'üêè', 'üêö', 'üêå', 'ü¶ã', 'üêõ', 'üêú', 'üêù', 'üêû', 'ü¶ó', 'üï∑', 'üï∏', 'ü¶Ç', 'ü¶ü', 'ü¶†', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ'],
            food: ['üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂', 'ü´í', 'üåΩ', 'ü•ï', 'ü´ë', 'ü•î', 'üç†', 'ü•ê', 'ü•ñ', 'üçû', 'ü•®', 'ü•Ø', 'üßÄ', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî', 'üçü', 'üçï', 'ü´ì', 'ü•ô', 'üåÆ', 'üåØ', 'ü´î', 'ü•ó', 'ü•ò', 'ü´ï', 'ü•´', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'ü¶™', 'üç§', 'üçô', 'üçö', 'üçò', 'üç•', 'ü•†', 'ü•Æ', 'üç¢', 'üç°', 'üçß', 'üç®', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞', 'üéÇ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç©', 'üç™', 'üå∞', 'ü•ú', 'üçØ'],
            travel: ['üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèé', 'üöì', 'üöë', 'üöí', 'üöê', 'üõª', 'üöö', 'üöõ', 'üöú', 'üèç', 'üõµ', 'üö≤', 'üõ¥', 'üõπ', 'üõº', 'üöÅ', '‚úà', 'üõ©', 'üõ´', 'üõ¨', 'ü™Ç', 'üí∫', 'üöÄ', 'üõ∏', 'üöâ', 'üöä', 'üöù', 'üöû', 'üöã', 'üöÉ', 'üöã', 'üöû', 'üöù', 'üöÑ', 'üöÖ', 'üöà', 'üöÇ', 'üöÜ', 'üöá', 'üöä', 'üöâ', '‚úà', 'üõ´', 'üõ¨', 'üõ©', 'üí∫', 'üõ∞', 'üöÄ', 'üõ∏', 'üöÅ', 'üõ∂', '‚õµ', 'üö§', 'üõ•', 'üõ≥', '‚õ¥', 'üö¢', '‚öì', 'üöß', '‚õΩ', 'üö®', 'üö•', 'üö¶', 'üõë', 'üöè', 'üó∫', 'üóø', 'üóΩ', 'üóº', 'üè∞', 'üèØ', 'üèü', 'üé°', 'üé¢', 'üé†', '‚õ≤', '‚õ±', 'üèñ', 'üèù', 'üèî', '‚õ∞', 'üåã', 'üóª', 'üèï', '‚õ∫', 'üõñ', 'üè†', 'üè°', 'üèò', 'üèö', 'üèó', 'üè≠', 'üè¢', 'üè¨', 'üè£', 'üè§', 'üè•', 'üè¶', 'üè®', 'üè™', 'üè´', 'üè©', 'üíí', 'üèõ', '‚õ™', 'üïå', 'üõï', 'üïç', 'üïã', '‚õ©', 'üõ§', 'üõ£', 'üóæ', 'üéë', 'üèû', 'üåÖ', 'üåÑ', 'üå†', 'üéá', 'üéÜ', 'üåá', 'üåÜ', 'üèô', 'üåÉ', 'üåå', 'üåâ', 'üåÅ'],
            objects: ['‚åö', 'üì±', 'üì≤', 'üíª', '‚å®', 'üñ•', 'üñ®', 'üñ±', 'üñ≤', 'üïπ', 'üóú', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üìº', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìΩ', 'üéû', 'üìû', '‚òé', 'üìü', 'üì†', 'üì∫', 'üìª', 'üéô', 'üéö', 'üéõ', 'üß≠', '‚è±', '‚è≤', '‚è∞', 'üï∞', '‚åõ', '‚è≥', 'üì°', 'üîã', 'üîå', 'üí°', 'üî¶', 'üïØ', 'ü™î', 'üßØ', 'üõ¢', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'ü™ô', 'üí∞', 'üí≥', 'üíé', '‚öñ', 'ü™ú', 'üß∞', 'üîß', 'üî®', '‚öí', 'üõ†', '‚õè', 'ü™ö', 'üî©', '‚öô', 'ü™§', 'üß±', '‚õì', 'üß≤', 'üî´', 'üí£', 'üß®', 'ü™ì', 'üî™', 'üó°', '‚öî', 'üõ°', 'üö¨', '‚ö∞', 'ü™¶', '‚ö±', 'üè∫', 'üîÆ', 'üìø', 'üßø', 'üíà', '‚öó', 'üî≠', 'üî¨', 'üï≥', 'ü©π', 'ü©∫', 'üíä', 'üíâ', 'üß¨', 'ü¶†', 'üß´', 'üß™', 'üå°', 'üßπ', 'üß∫', 'üßª', 'üöΩ', 'üö∞', 'üöø', 'üõÅ', 'üõÄ', 'üßº', 'ü™•', 'ü™í', 'üßΩ', 'üß¥', 'üõé', 'üîë', 'üóù', 'üö™', 'ü™ë', 'üõè', 'üõã', 'ü™û', 'ü™ü', 'üõç', 'üõí', 'üéÅ', 'üéà', 'üéè', 'üéÄ', 'ü™Ñ', 'ü™Ö', 'üéä', 'üéâ', 'üéé', 'üèÆ', 'ü™î', 'üßß', '‚úâ', 'üìß', 'üì®', 'üì©', 'üì§', 'üì•', 'üì¶', 'üì´', 'üì™', 'üì¨', 'üì≠', 'üìÆ', 'üó≥', '‚úè', '‚úí', 'üñã', 'üñä', 'üñå', 'üñç', 'üìù', 'üíº', 'üìÅ', 'üìÇ', 'üóÇ', 'üìÖ', 'üìÜ', 'üóí', 'üóì', 'üìá', 'üìà', 'üìâ', 'üìä', 'üìã', 'üìå', 'üìç', 'üìé', 'üñá', 'üìè', 'üìê', '‚úÇ', 'üóÉ', 'üóÑ', 'üóë', 'üîí', 'üîì', 'üîè', 'üîê', 'üîë', 'üóù', 'üî®', 'ü™ì', '‚õè', '‚öí', 'üõ†', 'üó°', '‚öî', 'üî´', 'üèπ', 'üõ°', 'üîß', 'ü™ö', 'üî©', '‚öô', 'ü™§', 'üß∞', '‚öñ', 'ü¶Ω', 'ü¶º', 'üõ¢', 'üõû', '‚öó', 'üß™', 'üß´', 'üß¨', 'ü¶†', 'üß≠', 'ü™ú', 'üß≤', 'üß∞', 'ü™ö', 'üîß', 'üî®', '‚öí', 'üõ†', '‚õè', 'ü™ö', 'üî©', '‚öô', 'ü™§', 'üß±', '‚õì', 'üß≤', 'üî´', 'üí£', 'üß®', 'ü™ì', 'üî™', 'üó°', '‚öî', 'üõ°', 'üö¨', '‚ö∞', 'ü™¶', '‚ö±', 'üè∫', 'üîÆ', 'üìø', 'üßø', 'üíà', '‚öó', 'üî≠', 'üî¨', 'üï≥', 'ü©π', 'ü©∫', 'üíä', 'üíâ', 'üß¨', 'ü¶†', 'üß´', 'üß™', 'üå°', 'üßπ', 'üß∫', 'üßª', 'üöΩ', 'üö∞', 'üöø', 'üõÅ', 'üõÄ', 'üßº', 'ü™•', 'ü™í', 'üßΩ', 'üß¥', 'üõé', 'üîë', 'üóù', 'üö™', 'ü™ë', 'üõè', 'üõã', 'ü™û', 'ü™ü', 'üõç', 'üõí', 'üéÅ', 'üéà', 'üéè', 'üéÄ', 'ü™Ñ', 'ü™Ö', 'üéä', 'üéâ', 'üéé', 'üèÆ', 'ü™î', 'üßß'],
            symbols: ['‚ù§', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆ', '‚úù', '‚ò™', 'üïâ', '‚ò∏', '‚ú°', 'üîØ', 'üïé', '‚òØ', '‚ò¶', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõ', 'üâë', '‚ò¢', '‚ò£', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑', '‚ú¥', 'üÜö', 'üíÆ', 'üâê', '„äô', '„äó', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞', 'üÖ±', 'üÜé', 'üÖæ', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚Äº', '‚Åâ', 'üîÖ', 'üîÜ', '„ÄΩ', '‚ö†', 'üö∏', 'üî±', '‚öú', 'üî∞', '‚ôª', '‚úÖ', 'üàØ', 'üíπ', '‚ùá', '‚ú≥', '‚ùé', 'üåê', 'üí†', '‚ìÇ', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖø', 'üà≥', 'üàÇ', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ', 'üî£', '‚Ñπ', 'üî§', 'üî°', 'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü']
        };

        // ÂàáÊç¢emojiÈÄâÊã©Âô®ÊòæÁ§∫/ÈöêËóè
        emojiTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.classList.toggle('show');
        });

        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠emojiÈÄâÊã©Âô®
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && !emojiTrigger.contains(e.target)) {
                emojiPicker.classList.remove('show');
            }
        });

        // ÂàáÊç¢emojiÂàÜÁ±ª
        document.querySelectorAll('.emoji-category').forEach(category => {
            category.addEventListener('click', (e) => {
                e.preventDefault();

                // Êõ¥Êñ∞ÊøÄÊ¥ªÁä∂ÊÄÅ
                document.querySelectorAll('.emoji-category').forEach(cat => cat.classList.remove('active'));
                category.classList.add('active');

                // ÊòæÁ§∫ÂØπÂ∫îÂàÜÁ±ªÁöÑemoji
                const categoryName = category.dataset.category;
                renderEmojiGrid(emojiData[categoryName]);
            });
        });

        // Ê∏≤ÊüìemojiÁΩëÊ†º
        function renderEmojiGrid(emojis) {
            emojiGrid.innerHTML = '';
            emojis.forEach(emoji => {
                const emojiButton = document.createElement('button');
                emojiButton.className = 'emoji-item';
                emojiButton.textContent = emoji;
                emojiButton.addEventListener('click', () => {
                    insertEmoji(emoji);
                });
                emojiGrid.appendChild(emojiButton);
            });
        }

        // ÊèíÂÖ•emojiÂà∞ÊñáÊú¨Âå∫Âüü
        function insertEmoji(emoji) {
            const textarea = commentTextarea;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const before = text.substring(0, start);
            const after = text.substring(end, text.length);

            // ÊèíÂÖ•emojiÂà∞ÂÖâÊ†á‰ΩçÁΩÆ
            textarea.value = before + emoji + after;

            // ËÆæÁΩÆÂÖâÊ†á‰ΩçÁΩÆÂà∞emojiÂêéÈù¢
            const newPosition = start + emoji.length;
            textarea.selectionStart = textarea.selectionEnd = newPosition;

            // ËÅöÁÑ¶Âà∞ÊñáÊú¨Ê°Ü
            textarea.focus();

            // ÂÖ≥Èó≠emojiÈÄâÊã©Âô®
            emojiPicker.classList.remove('show');

            // Ëß¶Âèëinput‰∫ã‰ª∂ÔºåÁ°Æ‰øùÂÖ∂‰ªñÁõëÂê¨Âô®ËÉΩÊ£ÄÊµãÂà∞ÂèòÂåñ
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // ÂàùÂßãÂåñÊòæÁ§∫Á¨¨‰∏Ä‰∏™ÂàÜÁ±ªÁöÑemoji
        renderEmojiGrid(emojiData.smileys);
    }

    // È´ò‰∫ÆÊåáÂÆöËØÑËÆ∫Âπ∂ÊªöÂä®Âà∞ËØ•‰ΩçÁΩÆ
    function highlightComment(commentId) {
        // Â∞ùËØïÊü•ÊâæËØÑËÆ∫ÂÖÉÁ¥†ÔºàÂèØËÉΩÊòØÈ°∂Á∫ßËØÑËÆ∫ÊàñÂ≠êËØÑËÆ∫Ôºâ
        let commentElement = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
        if (!commentElement) {
            commentElement = document.querySelector(`.subcomment-item[data-comment-id="${commentId}"]`);
        }

        if (commentElement) {
            // Ê∑ªÂä†È´ò‰∫ÆÊ†∑Âºè
            commentElement.classList.add('comment-highlight');

            // ÊªöÂä®Âà∞ËØ•ËØÑËÆ∫‰ΩçÁΩÆ
            commentElement.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            // 3ÁßíÂêéÁßªÈô§È´ò‰∫ÆÊïàÊûú
            setTimeout(() => {
                commentElement.classList.remove('comment-highlight');
            }, 3000);

            console.log('ÊàêÂäüÈ´ò‰∫ÆËØÑËÆ∫ÔºåcommentId:', commentId);
        } else {
            console.log('Êú™ÊâæÂà∞ÊåáÂÆöÁöÑËØÑËÆ∫ÔºåcommentId:', commentId);
            // Â¶ÇÊûúËØÑËÆ∫ËøòÊ≤°Âä†ËΩΩÔºåÂèØ‰ª•Â∞ùËØïÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫ÂàóË°®
            setTimeout(() => {
                loadComments();
                setTimeout(() => {
                    highlightComment(commentId);
                }, 500);
            }, 1000);
        }
    }

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñËØÑËÆ∫Á≥ªÁªü
    document.addEventListener('DOMContentLoaded', function() {
        // Âª∂ËøüÂàùÂßãÂåñÔºåÁ°Æ‰øùÂÖ∂‰ªñÂäüËÉΩÂÖàÂä†ËΩΩÂÆåÊàê
        setTimeout(initCommentSystem, 1000);
    });
</script>
</body>
<script src="/libs/ai-widget.js"></script>
</html>