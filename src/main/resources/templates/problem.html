<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${problem.id} + ' - ' + ${problem.title}"></title>

    <!-- 核心样式库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Markdown 相关资源 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.1/purify.min.js"></script>

    <!-- Monaco Editor 样式 -->
    <style>
        .monaco-editor-container {
            height: 500px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .monaco-editor {
            height: 100%;
        }

        /* 编辑器工具栏 */
        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theme-toggle {
            background: none;
            border: 1px solid #dee2e6;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: #e9ecef;
        }

        /* 美化后的下拉框样式 */
        .custom-select {
            position: relative;
            min-width: 180px;
            z-index: 1000;
        }

        .select-selected {
            background: linear-gradient(135deg, #e0f2fe, #bbdefb);
            color: var(--primary);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid transparent;
        }

        .select-selected:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
            border-color: rgba(26, 115, 232, 0.3);
        }

        .select-selected:after {
            content: "\f078";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .select-selected.select-arrow-active:after {
            transform: rotate(180deg);
        }

        .select-items {
            position: absolute;
            background-color: white;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 9999;
            border-radius: 12px;
            margin-top: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            transform: translateY(-10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(26, 115, 232, 0.1);
        }

        .select-items.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
            display: block;
        }

        .select-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .select-item:last-child {
            border-bottom: none;
        }

        .select-item:hover {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            color: var(--primary);
            transform: translateX(4px);
        }

        .select-item.selected {
            background: linear-gradient(135deg, #e0f2fe, #bbdefb);
            color: var(--primary);
            font-weight: 600;
        }

        .language-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .language-icon {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .language-info {
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
        }
    </style>

    <style>
        :root {
            --primary: #1a73e8;
            --secondary: #4a90e2;
            --accent: #66bb6a;
            --text: #2d3748;
            --bg: #f8fafc;
            --light-blue: rgba(26, 115, 232, 0.05);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #2ea44f;
            --danger: #d73a49;
            --info: #0366d6;
            --bg-light: #f6f8fa;
            --border-radius: 12px;
            --border-color: #e1e4e8;
        }

        body {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f2ff 50%, #f8fafc 100%);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.5;
            color: var(--text);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                    radial-gradient(circle at 20% 80%, rgba(26, 115, 232, 0.03) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(102, 187, 106, 0.03) 0%, transparent 50%),
                    radial-gradient(circle at 40% 40%, rgba(255, 193, 7, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .problem-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 24px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background: linear-gradient(135deg, rgba(26, 115, 232, 0.05) 0%, rgba(102, 187, 106, 0.05) 100%);
            border-bottom: 1px solid rgba(26, 115, 232, 0.1);
            padding: 20px 24px;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.8s ease;
        }

        .card:hover .card-header::before {
            left: 100%;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 30px;
        }

        .problem-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            position: relative;
            animation: fadeIn 0.8s ease-out;
        }

        .problem-title::after {
            content: "|";
            animation: blink 1s infinite;
            color: var(--primary);
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .problem-meta {
            display: flex;
            gap: 20px;
            font-size: 0.95rem;
            color: #586069;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .meta-item i {
            color: var(--primary);
            font-size: 1em;
        }

        .code-preview {
            background: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 16px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            line-height: 1.45;
            white-space: pre;
            overflow-x: auto;
            font-size: 85%;
            border: 1px solid var(--border-color);
        }

        .code-editor-container {
            background: white;
            border-radius: var(--border-radius);
            margin-top: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .CodeMirror {
            border-radius: var(--border-radius);
            height: 500px;
            border: 1px solid var(--border-color);
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .submit-btn {
            background: var(--success);
            color: white;
            padding: 8px 24px;
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: all 0.2s;
            border: none;
        }

        .submit-btn:hover {
            background: #2c974b;
            transform: translateY(-1px);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* 提交结果显示样式 */
        .submit-result {
            font-size: 14px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            min-width: 120px;
            text-align: center;
            width: auto;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .submit-result.error:hover {
            background: #f1aeb5;
            transform: translateY(-1px);
        }

        .submit-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .submit-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .submit-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* 错误详情弹窗样式 */
        .error-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .error-detail-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .error-detail-content {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .error-detail-modal.show .error-detail-content {
            transform: scale(1);
        }
        
        .error-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .error-detail-title {
            font-size: 18px;
            font-weight: 600;
            color: #721c24;
        }
        
        .error-detail-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .error-detail-close:hover {
            background: #f8f9fa;
            color: #495057;
        }
        
        .test-case-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            border: 1px solid #e9ecef;
        }
        
        .test-case-item {
            margin: 12px 0;
            display: flex;
            align-items: flex-start;
        }
        
        .test-case-item .label {
            font-weight: 600;
            min-width: 100px;
            margin-right: 16px;
            color: #495057;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .test-case-item code {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            color: #495057;
            border: 1px solid #dee2e6;
            flex: 1;
            word-break: break-all;
            white-space: pre-wrap;
        }

        /* GitHub风格的Markdown样式 */
        .markdown-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            word-wrap: break-word;
            padding: 16px;
        }

        .markdown-content h1,
        .markdown-content h2 {
            padding-bottom: 0.3em;
            border-bottom: 1px solid var(--border-color);
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .markdown-content h1 {
            font-size: 2em;
        }

        .markdown-content h2 {
            font-size: 1.5em;
        }

        .markdown-content h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 16px;
        }

        .markdown-content pre {
            background: var(--bg-light);
            padding: 16px;
            border-radius: var(--border-radius);
            overflow: auto;
            margin: 16px 0;
            border: 1px solid var(--border-color);
            line-height: 1.45;
        }

        .markdown-content code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            background: rgba(27,31,35,0.05);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 85%;
        }

        .markdown-content pre code {
            background: transparent;
            padding: 0;
            border-radius: 0;
        }

        .markdown-content img {
            max-width: 100%;
            box-sizing: content-box;
            background-color: #fff;
            margin: 16px 0;
        }

        .markdown-content table {
            border-spacing: 0;
            border-collapse: collapse;
            display: block;
            width: 100%;
            overflow: auto;
            margin: 16px 0;
        }

        .markdown-content th,
        .markdown-content td {
            padding: 6px 13px;
            border: 1px solid var(--border-color);
        }

        .markdown-content th {
            font-weight: 600;
            background: var(--bg-light);
        }

        .markdown-content tr {
            background-color: #fff;
            border-top: 1px solid var(--border-color);
        }

        .markdown-content tr:nth-child(2n) {
            background-color: var(--bg-light);
        }

        .markdown-content blockquote {
            padding: 0 1em;
            color: #6a737d;
            border-left: 0.25em solid var(--border-color);
            margin: 0 0 16px 0;
        }

        .markdown-content ul,
        .markdown-content ol {
            padding-left: 2em;
            margin-top: 0;
            margin-bottom: 16px;
        }

        .markdown-content li {
            word-wrap: break-word;
        }

        .markdown-content li > p {
            margin-top: 16px;
        }

        .markdown-content li + li {
            margin-top: 0.25em;
        }

        /* 标签样式 */
        .tag {
            display: inline-block;
            padding: 0 10px;
            font-size: 12px;
            font-weight: 500;
            line-height: 22px;
            color: #0366d6;
            background-color: #f1f8ff;
            border-radius: 2em;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        /* 美化的判题结果弹框 */
        .status-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            font-size: 1.05rem;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            max-width: 450px;
        }

        .status-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status-success {
            background: #f0fff4;
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        .status-error {
            background: #fff5f5;
            color: #742a2a;
            border-left: 4px solid #e53e3e;
        }

        .status-info {
            background: #edf2ff;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }

        .status-toast i {
            font-size: 1.3em;
        }

        @media (max-width: 768px) {
            .problem-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .monaco-editor-container {
                height: 350px;
            }

            .editor-toolbar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .editor-actions {
                width: 100%;
                justify-content: space-between;
            }

            .status-toast {
                min-width: auto;
                max-width: calc(100% - 40px);
            }
        }

        @media (max-width: 480px) {
            .monaco-editor-container {
                height: 300px;
            }

            .editor-toolbar {
                padding: 8px 12px;
            }

            .theme-toggle {
                padding: 4px 8px;
                font-size: 11px;
            }

            .language-info {
                font-size: 11px;
                padding: 1px 6px;
            }
        }

        /* 评论区域样式 */
        .comment-section {
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        .comment-section .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            border: none;
        }

        .comment-section .card-header h4 {
            font-weight: 600;
        }

        .comment-form textarea {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 100px;
        }

        .comment-form textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        /* Emoji选择器样式 */
        .comment-input-container {
            position: relative;
        }

        .emoji-picker-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .emoji-trigger {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            z-index: 10;
            font-size: 18px;
        }

        .emoji-trigger:hover {
            background: #f7fafc;
            color: #667eea;
        }

        .emoji-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 12px;
            width: 320px;
            max-height: 300px;
            display: none;
            z-index: 1000;
            margin-bottom: 8px;
        }

        .emoji-picker.show {
            display: block;
        }

        .emoji-categories {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .emoji-category {
            background: none;
            border: none;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .emoji-category:hover {
            background: #f7fafc;
        }

        .emoji-category.active {
            background: #667eea;
            color: white;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-item {
            background: none;
            border: none;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-item:hover {
            background: #f7fafc;
            transform: scale(1.1);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .emoji-picker {
                width: 280px;
                right: -10px;
            }

            .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        .comment-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .comment-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        .comment-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* 评论高亮效果 */
        .comment-highlight {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            border: 2px solid #f39c12 !important;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.3) !important;
            animation: highlightPulse 2s ease-in-out;
        }

        @keyframes highlightPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(243, 156, 18, 0.3);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 30px rgba(243, 156, 18, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(243, 156, 18, 0.3);
            }
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .comment-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .comment-author .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .comment-author .name {
            font-weight: 600;
            color: #2d3748;
        }

        .reply-to {
            color: #718096;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }

        .reply-username {
            color: #667eea;
            font-weight: 500;
        }

        .comment-time {
            color: #718096;
            font-size: 0.9rem;
        }

        .comment-content {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 1rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .comment-actions {
            display: flex;
            gap: 1rem;
        }

        .comment-action {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .comment-action:hover {
            background: #e2e8f0;
            color: #4a5568;
        }

        .comment-action.reply:hover {
            color: #667eea;
        }

        .comment-action.delete:hover {
            color: #e53e3e;
        }

        /* 回复区域样式 */
        .reply-form {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .reply-form.show {
            display: block;
        }

        .reply-form textarea {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            width: 100%;
            min-height: 80px;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .reply-form textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .reply-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .reply-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .reply-btn.primary {
            background: #667eea;
            color: white;
        }

        .reply-btn.primary:hover {
            background: #5a67d8;
        }

        .reply-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .reply-btn.secondary:hover {
            background: #cbd5e0;
        }

        /* 子评论样式 */
        .subcomment-list {
            margin-top: 1rem;
            padding-left: 2rem;
            border-left: 2px solid #e2e8f0;
        }

        .subcomment-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .subcomment-item:last-child {
            margin-bottom: 0;
        }

        /* 空状态样式 */
        .comment-list .text-center {
            padding: 3rem 1rem;
        }

        .comment-list .text-center i {
            color: #cbd5e0;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .comment-item {
                padding: 1rem;
            }

            .comment-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .subcomment-list {
                padding-left: 1rem;
            }

            .comment-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
<div class="problem-container">
    <!-- 题目头部 -->
    <div class="card info-card">
        <div class="problem-header p-4">
            <div class="problem-title">
                <i class="fas fa-code text-primary"></i>
                <span th:text="${problem.title}"></span>
            </div>
            <div class="problem-meta d-flex justify-content-between align-items-center">
                <div>
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span id="time" th:text="'时间限制：' + ${problem.timeLimit} + ' ms'"></span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-memory"></i>
                        <span id="memory" th:text="'内存限制：' + ${problem.memoryLimit} + ' MB'"></span>
                    </div>
                    <!-- 标签区域 -->
                    <div class="meta-item">
                        <i class="fas fa-tags text-primary"></i>
                        <div id="tagsContainer" class="d-flex align-items-center flex-wrap gap-1"></div>
                    </div>
                </div>
                <a href="#"
                   class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1"
                   th:href="@{/solve/list/{id}(id=${problem.id})}"
                   target="_self">
                    <i class="fas fa-book-open"></i>
                    <span>查看题解</span>
                </a>
            </div>
        </div>
    </div>

    <!-- 题目描述 -->
    <div class="card info-card">
        <div class="card-header">
            <h4 class="mb-0">题目描述</h4>
        </div>
        <div class="markdown-content" th:text="${problem.description}"></div>
    </div>

    <!-- 输入格式 -->
    <div class="card info-card">
        <div class="card-header">
            <h4 class="mb-0">输入格式</h4>
        </div>
        <div class="markdown-content" th:text="${problem.inputFormat}"></div>
    </div>

    <!-- 输出格式 -->
    <div class="card info-card">
        <div class="card-header">
            <h4 class="mb-0">输出格式</h4>
        </div>
        <div class="markdown-content" th:text="${problem.outputFormat}"></div>
    </div>

    <!-- 输入输出样例 -->
    <div class="row g-4 mt-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">输入样例</h5>
                </div>
                <div class="code-preview" th:utext="${problem.inputExample}"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">输出样例</h5>
                </div>
                <div class="code-preview" th:utext="${problem.outputExample}"></div>
            </div>
        </div>
    </div>

    <!-- 提示 -->
    <div class="card info-card mt-4">
        <div class="card-header">
            <h4 class="mb-0">提示</h4>
        </div>
        <div class="markdown-content" th:text="${problem.hint}"></div>
    </div>

    <!-- 代码提交区域 -->
    <div class="card code-editor-container mt-5">
        <form id="submitForm">
            <input type="hidden" name="problemId" th:value="${problem.id}">
            <div class="mb-3">
                <label class="form-label">选择编程语言</label>
                <div class="custom-select" id="languageSelect">
                    <div class="select-selected">C++17</div>
                    <div class="select-items">
                        <div class="select-item selected" data-value="cpp">
                            <span class="language-option">
                                <span class="language-icon"><i class="fab fa-cuttlefish"></i></span>
                                <span>C++17</span>
                            </span>
                        </div>
                        <div class="select-item" data-value="python">
                            <span class="language-option">
                                <span class="language-icon"><i class="fab fa-python"></i></span>
                                <span>Python</span>
                            </span>
                        </div>
                        <div class="select-item" data-value="java">
                            <span class="language-option">
                                <span class="language-icon"><i class="fab fa-java"></i></span>
                                <span>Java</span>
                            </span>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="languageSelectHidden" name="language" value="cpp">
            </div>
            <div id="judgeStatus" class="mb-3">
                <div id="statusAlert" class="alert" style="display: none;"></div>
            </div>

            <div class="mb-4">
                <div class="monaco-editor-container">
                    <div class="editor-toolbar">
                        <div class="language-info" id="languageInfo">C++17</div>
                        <div class="editor-actions">
                            <button type="button" class="theme-toggle" id="themeToggle">
                                <i class="fas fa-moon"></i> 暗色主题
                            </button>
                            <button type="button" class="theme-toggle" id="formatCode">
                                <i class="fas fa-magic"></i> 格式化
                            </button>
                        </div>
                    </div>
                    <div id="codeEditor" class="monaco-editor"></div>
                </div>
                <textarea id="codeEditorHidden" name="code" style="display: none;"></textarea>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <div id="submitResult" class="submit-result">
                    <!-- 提交结果将显示在这里 -->
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-paper-plane me-2"></i> 提交代码
                </button>
            </div>
        </form>
    </div>

    <!-- 评论区域 -->
    <div class="card comment-section mt-5">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="fas fa-comments me-2"></i>评论讨论
                <span class="badge bg-primary ms-2" id="commentCount">0</span>
            </h4>
        </div>
        <div class="card-body">
            <!-- 发表评论区域 -->
            <div class="comment-form mb-4">
                <div class="mb-3">
                    <label for="commentContent" class="form-label">发表评论</label>
                    <div class="comment-input-container">
                        <textarea id="commentContent" class="form-control" rows="4" placeholder="分享你的想法、解题思路或遇到的问题..."></textarea>
                        <button type="button" class="emoji-trigger" id="emojiTrigger">
                            <i class="fas fa-smile"></i>
                        </button>
                    </div>
                    <div class="emoji-picker-container">
                        <div class="emoji-picker" id="emojiPicker">
                            <div class="emoji-categories">
                                <button class="emoji-category active" data-category="smileys">😀</button>
                                <button class="emoji-category" data-category="people">👋</button>
                                <button class="emoji-category" data-category="animals">🐶</button>
                                <button class="emoji-category" data-category="food">🍎</button>
                                <button class="emoji-category" data-category="travel">🚗</button>
                                <button class="emoji-category" data-category="objects">📱</button>
                                <button class="emoji-category" data-category="symbols">❤️</button>
                            </div>
                            <div class="emoji-grid" id="emojiGrid">
                                <!-- Emoji列表将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-primary" id="submitComment">
                        <i class="fas fa-paper-plane me-2"></i>发表评论
                    </button>
                </div>
            </div>

            <!-- 评论列表 -->
            <div id="commentList" class="comment-list">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i>
                    <p>暂无评论，快来发表第一条评论吧！</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 核心脚本 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Monaco Editor 脚本 -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<!-- 备用 CDN -->
<script>
  // 如果主 CDN 失败，尝试备用 CDN
  if (typeof require === 'undefined') {
    console.log('Primary CDN failed, trying backup CDN...');
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js';
    script.onload = function() {
      console.log('Backup CDN loaded successfully');
    };
    script.onerror = function() {
      console.error('Both CDNs failed to load Monaco Editor');
    };
    document.head.appendChild(script);
  }
</script>

<script>
    // 配置marked.js以符合GitHub风格
    marked.setOptions({
        gfm: true,
        breaks: true,
        pedantic: false,
        smartLists: true,
        smartypants: false,
        highlight: function(code, lang) {
            const validLang = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language: validLang }).value;
        },
        extensions: [
            {
                name: 'math',
                level: 'inline',
                start(src) { return src.indexOf('$'); },
                tokenizer(src, tokens) {
                    const match = src.match(/^\$+([^$\n]+?)\$+/);
                    if (match) {
                        return {
                            type: 'math',
                            raw: match[0],
                            text: match[1].trim()
                        };
                    }
                },
                renderer(token) {
                    return `<span class="math">\\(${token.text}\\)</span>`;
                }
            }
        ]
    });

    // 渲染Markdown内容
    function renderMarkdownElements() {
        document.querySelectorAll('.markdown-content').forEach(element => {
            const rawText = element.textContent;
            const parsedMarkdown = marked.parse(rawText);
            element.innerHTML = DOMPurify.sanitize(parsedMarkdown, {
                ADD_TAGS: ['iframe'],
                ADD_ATTR: ['allow', 'allowfullscreen', 'frameborder', 'scrolling']
            });

            // 渲染数学公式
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise();
            }

            // 高亮代码块
            element.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });
    }

    // Monaco Editor 全局变量
    let editor = null;
    let currentTheme = 'vs';
    let currentLanguage = 'cpp';

    // 语言配置
    const languageConfig = {
        'cpp': {
            id: 'cpp',
            name: 'C++17',
            template: `#include <iostream>
using namespace std;

int main() {
    // 请在此处编写你的代码

    return 0;
}`
        },
        'python': {
            id: 'python',
            name: 'Python 3',
            template: `# 请在此处编写你的代码

`
        },
        'java': {
            id: 'java',
            name: 'Java',
            template: `public class Main {
    public static void main(String[] args) {
        // 请在此处编写你的代码
    }
}`
        }
    };

    // 初始化 Monaco Editor
    function initMonacoEditor() {
        // 检查 DOM 元素是否存在
        const editorElement = document.getElementById('codeEditor');
        if (!editorElement) {
            console.error('编辑器容器元素未找到');
            return;
        }

        // 等待 Monaco Editor 加载完成
        function waitForMonaco() {
            if (typeof require !== 'undefined') {
                initializeEditor();
            } else {
                console.log('Waiting for Monaco Editor to load...');
                // 最多等待 10 秒
                if (typeof waitForMonaco.counter === 'undefined') {
                    waitForMonaco.counter = 0;
                }
                waitForMonaco.counter++;
                
                if (waitForMonaco.counter > 100) { // 10秒后超时
                    console.error('Monaco Editor failed to load after 10 seconds');
                    showFallbackEditor();
                    return;
                }
                
                setTimeout(waitForMonaco, 100);
            }
        }

        function showFallbackEditor() {
            const editorElement = document.getElementById('codeEditor');
            editorElement.innerHTML = '<textarea id="fallbackEditor" style="width: 100%; height: 100%; border: none; outline: none; font-family: monospace; font-size: 14px; padding: 10px; resize: none;">#include <iostream>\nusing namespace std;\n\nint main() {\n    // 请在此处编写你的代码\n    \n    return 0;\n}</textarea>';
            
            const fallbackEditor = document.getElementById('fallbackEditor');
            if (fallbackEditor) {
                fallbackEditor.addEventListener('input', function() {
                    document.getElementById('codeEditorHidden').value = this.value;
                });
            }
        }

        function initializeEditor() {
            // 使用 require 加载 Monaco Editor
            require.config({
                paths: {
                    'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs'
                }
            });

            require(['vs/editor/editor.main'], function () {
            try {
                // 注册语言
                monaco.languages.register({ id: 'cpp' });
                monaco.languages.setMonarchTokensProvider('cpp', {
                    tokenizer: {
                        root: [
                            [/[a-zA-Z_$][a-zA-Z0-9_$]*/, 'identifier'],
                            [/\d+/, 'number'],
                            [/"[^"]*"/, 'string'],
                            [/\/\/.*$/, 'comment'],
                            [/\/\*[\s\S]*?\*\//, 'comment'],
                            [/[{}()\[\]]/, 'delimiter.bracket'],
                            [/[<>]=?|==|!=/, 'operator'],
                            [/[+\-*/%=!&|^~]/, 'operator'],
                            [/[;,.]/, 'delimiter']
                        ]
                    }
                });

                // 创建编辑器
                editor = monaco.editor.create(editorElement, {
                    value: languageConfig.cpp.template,
                    language: 'cpp',
                    theme: currentTheme,
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontSize: 14,
                    lineNumbers: 'on',
                    roundedSelection: false,
                    scrollBeyondLastLine: false,
                    readOnly: false,
                    cursorStyle: 'line',
                    wordWrap: 'on',
                    // 格式化相关配置
                    formatOnPaste: true,
                    formatOnType: false,
                    insertSpaces: true,
                    tabSize: 4,
                    detectIndentation: false,
                    // 启用自动补全
                    suggest: {
                        showKeywords: true,
                        showSnippets: true,
                        showFunctions: true,
                        showConstructors: true,
                        showFields: true,
                        showVariables: true,
                        showClasses: true,
                        showStructs: true,
                        showInterfaces: true,
                        showModules: true,
                        showProperties: true,
                        showEvents: true,
                        showOperators: true,
                        showUnits: true,
                        showValues: true,
                        showConstants: true,
                        showEnums: true,
                        showEnumMembers: true,
                        showColors: true,
                        showFiles: true,
                        showReferences: true,
                        showFolders: true,
                        showTypeParameters: true,
                        showIssues: true,
                        showUsers: true,
                        showWords: true
                    },
                    // 启用代码折叠
                    folding: true,
                    foldingStrategy: 'indentation',
                    showFoldingControls: 'always',
                    // 启用括号匹配
                    matchBrackets: 'always',
                    // 启用自动缩进
                    autoIndent: 'full',
                    // 启用自动闭合括号
                    autoClosingBrackets: 'always',
                    autoClosingQuotes: 'always',
                    // 启用代码提示
                    quickSuggestions: true,
                    quickSuggestionsDelay: 100,
                    // 启用参数提示
                    parameterHints: {
                        enabled: true
                    },
                    // 启用悬停提示
                    hover: {
                        enabled: true
                    },
                    // 启用错误提示
                    glyphMargin: true,
                    // 启用选择高亮
                    occurrencesHighlight: true,
                    // 启用选择相同词
                    selectionHighlight: true,
                    // 启用当前行高亮
                    renderLineHighlight: 'line',
                    // 启用行号
                    lineNumbersMinChars: 3,
                    // 启用滚动条
                    scrollbar: {
                        vertical: 'auto',
                        horizontal: 'auto',
                        useShadows: false,
                        verticalHasArrows: false,
                        horizontalHasArrows: false,
                        verticalScrollbarSize: 10,
                        horizontalScrollbarSize: 10
                    }
                });

                // 监听内容变化，同步到隐藏的 textarea
                editor.onDidChangeModelContent(() => {
                    document.getElementById('codeEditorHidden').value = editor.getValue();
                });

                // 绑定快捷键
                editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
                    saveDraft();
                });

                // 添加代码片段
                addCodeSnippets();

                // 添加错误提示
                addErrorMarkers();

                // 添加键盘快捷键提示
                addKeyboardShortcuts();

                console.log('Monaco Editor 初始化成功');

            } catch (error) {
                console.error('Monaco Editor 初始化失败:', error);
                // 如果 Monaco Editor 初始化失败，显示一个简单的 textarea
                editorElement.innerHTML = '<textarea id="fallbackEditor" style="width: 100%; height: 100%; border: none; outline: none; font-family: monospace; font-size: 14px; padding: 10px; resize: none;">#include <iostream>\nusing namespace std;\n\nint main() {\n    // 请在此处编写你的代码\n    \n    return 0;\n}</textarea>';

                // 绑定 fallback editor 的事件
                const fallbackEditor = document.getElementById('fallbackEditor');
                if (fallbackEditor) {
                    fallbackEditor.addEventListener('input', function() {
                        document.getElementById('codeEditorHidden').value = this.value;
                    });
                }
            }
        }, function (error) {
            console.error('Monaco Editor 加载失败:', error);
            // 如果 Monaco Editor 加载失败，显示一个简单的 textarea
            const editorElement = document.getElementById('codeEditor');
            if (editorElement) {
                editorElement.innerHTML = '<textarea id="fallbackEditor" style="width: 100%; height: 100%; border: none; outline: none; font-family: monospace; font-size: 14px; padding: 10px; resize: none;">#include <iostream>\nusing namespace std;\n\nint main() {\n    // 请在此处编写你的代码\n    \n    return 0;\n}</textarea>';

                // 绑定 fallback editor 的事件
                const fallbackEditor = document.getElementById('fallbackEditor');
                if (fallbackEditor) {
                    fallbackEditor.addEventListener('input', function() {
                        document.getElementById('codeEditorHidden').value = this.value;
                    });
                }
            }
        });
        }

        // 开始等待 Monaco Editor 加载
        waitForMonaco();
    }

    // 添加错误标记功能
    function addErrorMarkers() {
        if (!editor) return;

        // 监听内容变化，添加简单的语法检查
        editor.onDidChangeModelContent(() => {
            const model = editor.getModel();
            if (!model) return;

            const value = model.getValue();
            const errors = [];

            // 简单的 C++ 语法检查
            if (currentLanguage === 'cpp') {
                const lines = value.split('\n');
                let totalOpenBraces = 0;
                let totalCloseBraces = 0;
                let totalOpenParens = 0;
                let totalCloseParens = 0;

                // 统计整个文件的括号数量
                for (let line of lines) {
                    totalOpenBraces += (line.match(/\{/g) || []).length;
                    totalCloseBraces += (line.match(/\}/g) || []).length;
                    totalOpenParens += (line.match(/\(/g) || []).length;
                    totalCloseParens += (line.match(/\)/g) || []).length;
                }

                // 只有在整个文件级别不匹配时才显示错误
                if (totalOpenBraces !== totalCloseBraces) {
                    const lastLine = lines.length;
                    errors.push({
                        startLineNumber: lastLine,
                        startColumn: 1,
                        endLineNumber: lastLine,
                        endColumn: 1,
                        message: `大括号不匹配：{ 有 ${totalOpenBraces} 个，} 有 ${totalCloseBraces} 个`,
                        severity: monaco.MarkerSeverity.Warning
                    });
                }

                if (totalOpenParens !== totalCloseParens) {
                    const lastLine = lines.length;
                    errors.push({
                        startLineNumber: lastLine,
                        startColumn: 1,
                        endLineNumber: lastLine,
                        endColumn: 1,
                        message: `小括号不匹配：( 有 ${totalOpenParens} 个，) 有 ${totalCloseParens} 个`,
                        severity: monaco.MarkerSeverity.Warning
                    });
                }
            }

            // 设置错误标记
            monaco.editor.setModelMarkers(model, 'syntax', errors);
        });
    }

    // 添加键盘快捷键提示
    function addKeyboardShortcuts() {
        if (!editor) return;

        // 添加自定义快捷键
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyF, () => {
            editor.getAction('editor.action.startFindReplaceAction').run();
        });

        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyG, () => {
            editor.getAction('editor.action.gotoLineAction').run();
        });

        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Slash, () => {
            editor.getAction('editor.action.commentLine').run();
        });

        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyA, () => {
            editor.getAction('editor.action.selectAll').run();
        });
    }

    // 添加代码片段
    function addCodeSnippets() {
        // C++ 代码片段
        monaco.languages.registerCompletionItemProvider('cpp', {
            provideCompletionItems: (model, position) => {
                const suggestions = [
                    {
                        label: 'for',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'for (int i = 0; i < ${1:count}; i++) {\n\t${2:// code}\n}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'for 循环'
                    },
                    {
                        label: 'while',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'while (${1:condition}) {\n\t${2:// code}\n}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'while 循环'
                    },
                    {
                        label: 'if',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'if (${1:condition}) {\n\t${2:// code}\n}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'if 语句'
                    },
                    {
                        label: 'ifelse',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'if (${1:condition}) {\n\t${2:// code}\n} else {\n\t${3:// code}\n}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'if-else 语句'
                    },
                    {
                        label: 'cout',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'cout << ${1:value} << endl;',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: '输出语句'
                    },
                    {
                        label: 'cin',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'cin >> ${1:variable};',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: '输入语句'
                    }
                ];

                return { suggestions };
            }
        });

        // Python 代码片段
        monaco.languages.registerCompletionItemProvider('python', {
            provideCompletionItems: (model, position) => {
                const suggestions = [
                    {
                        label: 'for',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'for ${1:item} in ${2:iterable}:\n\t${3:# code}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'for 循环'
                    },
                    {
                        label: 'while',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'while ${1:condition}:\n\t${2:# code}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'while 循环'
                    },
                    {
                        label: 'if',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'if ${1:condition}:\n\t${2:# code}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'if 语句'
                    },
                    {
                        label: 'def',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'def ${1:function_name}(${2:parameters}):\n\t${3:# code}\n\treturn ${4:value}',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: '函数定义'
                    },
                    {
                        label: 'print',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: 'print(${1:value})',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: '输出语句'
                    }
                ];

                return { suggestions };
            }
        });
    }

    // 语言切换功能
    function switchLanguage(language) {
        const config = languageConfig[language];
        if (!config) return;

        currentLanguage = language;

        // 更新语言显示
        document.getElementById('languageInfo').textContent = config.name;

        if (editor) {
            // Monaco Editor 模式
            // 更新语言
            monaco.editor.setModelLanguage(editor.getModel(), config.id);

            // 如果编辑器为空或只有默认内容，则加载模板
            const currentValue = editor.getValue().trim();
            const isEmpty = !currentValue || currentValue === languageConfig.cpp.template.trim() ||
                currentValue === languageConfig.python.template.trim() ||
                currentValue === languageConfig.java.template.trim();

            if (isEmpty) {
                editor.setValue(config.template);
            }
        } else {
            // Fallback textarea 模式
            const fallbackEditor = document.getElementById('fallbackEditor');
            if (fallbackEditor) {
                const currentValue = fallbackEditor.value.trim();
                const isEmpty = !currentValue || currentValue === languageConfig.cpp.template.trim() ||
                    currentValue === languageConfig.python.template.trim() ||
                    currentValue === languageConfig.java.template.trim();

                if (isEmpty) {
                    fallbackEditor.value = config.template;
                    // 同步到隐藏的 textarea
                    document.getElementById('codeEditorHidden').value = config.template;
                }
            }
        }
    }

    // 主题切换功能
    function toggleTheme() {
        if (!editor) return;

        currentTheme = currentTheme === 'vs' ? 'vs-dark' : 'vs';
        monaco.editor.setTheme(currentTheme);

        const themeButton = document.getElementById('themeToggle');
        const icon = themeButton.querySelector('i');
        const text = themeButton.querySelector('span') || themeButton.childNodes[1];

        if (currentTheme === 'vs-dark') {
            icon.className = 'fas fa-sun';
            text.textContent = ' 亮色主题';
        } else {
            icon.className = 'fas fa-moon';
            text.textContent = ' 暗色主题';
        }
    }

    // 代码格式化功能
    function formatCode() {
        if (!editor) {
            // Fallback 模式下的简单格式化
            const fallbackEditor = document.getElementById('fallbackEditor');
            if (fallbackEditor) {
                let code = fallbackEditor.value;
                // 简单的 C++ 格式化
                code = code
                    .replace(/\s*{\s*/g, ' {\n    ')  // 格式化左大括号
                    .replace(/\s*}\s*/g, '\n}\n')     // 格式化右大括号
                    .replace(/;\s*/g, ';\n')          // 格式化分号
                    .replace(/\n\s*\n\s*\n/g, '\n\n') // 移除多余空行
                    .trim();

                fallbackEditor.value = code;
                document.getElementById('codeEditorHidden').value = code;
                showToast('代码已格式化', 'success', 2000);
            }
            return;
        }

        try {
            // 使用 Monaco Editor 的内置格式化
            const model = editor.getModel();
            if (model) {
                // 获取格式化提供者
                const formattingProvider = monaco.languages.getDocumentFormattingEditProvider('cpp');
                if (formattingProvider) {
                    // 使用格式化提供者
                    formattingProvider.provideDocumentFormattingEdits(model, {
                        insertSpaces: true,
                        tabSize: 4
                    }).then(edits => {
                        if (edits && edits.length > 0) {
                            editor.executeEdits('format', edits);
                            showToast('代码已格式化', 'success', 2000);
                        } else {
                            // 如果格式化提供者不可用，使用手动格式化
                            const value = model.getValue();
                            const formatted = formatCppCode(value);
                            editor.setValue(formatted);
                            showToast('代码已格式化', 'success', 2000);
                        }
                    }).catch(() => {
                        // 如果格式化提供者失败，使用手动格式化
                        const value = model.getValue();
                        const formatted = formatCppCode(value);
                        editor.setValue(formatted);
                        showToast('代码已格式化', 'success', 2000);
                    });
                } else {
                    // 如果格式化提供者不可用，使用手动格式化
                    const value = model.getValue();
                    const formatted = formatCppCode(value);
                    editor.setValue(formatted);
                    showToast('代码已格式化', 'success', 2000);
                }
            }
        } catch (error) {
            console.error('格式化失败:', error);
            // 使用手动格式化作为备用
            try {
                const model = editor.getModel();
                if (model) {
                    const value = model.getValue();
                    const formatted = formatCppCode(value);
                    editor.setValue(formatted);
                    showToast('代码已格式化', 'success', 2000);
                }
            } catch (fallbackError) {
                console.error('备用格式化也失败:', fallbackError);
                showToast('格式化失败，请手动调整代码', 'error', 3000);
            }
        }
    }

    // 简单的 C++ 代码格式化函数
    function formatCppCode(code) {
        let lines = code.split('\n');
        let formatted = [];
        let indentLevel = 0;
        const indent = '    '; // 4个空格

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();

            // 跳过空行
            if (!line) {
                formatted.push('');
                continue;
            }

            // 处理特殊行
            if (line.startsWith('#include') || line.startsWith('using namespace')) {
                formatted.push(line);
                continue;
            }

            // 减少缩进（在右大括号前）
            if (line.startsWith('}')) {
                indentLevel = Math.max(0, indentLevel - 1);
            }

            // 添加缩进
            formatted.push(indent.repeat(indentLevel) + line);

            // 增加缩进（在左大括号后）
            if (line.endsWith('{')) {
                indentLevel++;
            }

            // 特殊处理：如果下一行是右大括号，减少缩进
            if (i < lines.length - 1) {
                let nextLine = lines[i + 1].trim();
                if (nextLine.startsWith('}')) {
                    // 当前行后面应该有空行
                    if (!lines[i + 1].trim()) {
                        formatted.push('');
                    }
                }
            }
        }

        return formatted.join('\n');
    }

    // 初始化自定义选择框
    function initCustomSelect() {
        const customSelect = document.getElementById('languageSelect');
        const selected = customSelect.querySelector('.select-selected');
        const itemsContainer = customSelect.querySelector('.select-items');
        const items = customSelect.querySelectorAll('.select-item');

        // 点击选中区域切换显示/隐藏
        selected.addEventListener('click', function(e) {
            e.stopPropagation();
            closeAllSelect(this);
            itemsContainer.classList.toggle('active');
            this.classList.toggle('select-arrow-active');

            // 确保下拉框显示
            if (itemsContainer.classList.contains('active')) {
                itemsContainer.style.display = 'block';
            }
        });

        // 点击选项
        items.forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();

                // 更新选中状态
                items.forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');

                // 更新显示文本
                const text = this.querySelector('span:last-child').textContent;
                selected.textContent = text;

                // 更新隐藏输入框的值
                const value = this.getAttribute('data-value');
                document.getElementById('languageSelectHidden').value = value;

                // 切换语言
                switchLanguage(value);

                // 关闭下拉框
                itemsContainer.classList.remove('active');
                itemsContainer.style.display = 'none';
                selected.classList.remove('select-arrow-active');
            });
        });
    }

    // 关闭所有选择框
    function closeAllSelect(elmnt) {
        const selectItems = document.querySelectorAll('.select-items');
        const selectSelected = document.querySelectorAll('.select-selected');

        selectItems.forEach(item => {
            if (elmnt && item !== elmnt.nextElementSibling && elmnt !== item) {
                item.classList.remove('active');
                item.style.display = 'none';
            }
        });

        selectSelected.forEach(selected => {
            if (elmnt && selected !== elmnt) {
                selected.classList.remove('select-arrow-active');
            }
        });
    }

    // 点击页面其他地方关闭选择框
    document.addEventListener('click', function(e) {
        closeAllSelect(e.target);
    });

    // 绑定主题切换事件
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    // 绑定代码格式化事件
    document.getElementById('formatCode').addEventListener('click', formatCode);

    // 获取题目标签
    async function fetchProblemTags(problemId, token) {
        try {
            const params = new URLSearchParams({
                pid:problemId
            });
            const response = await fetch(`/problem/tags?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (data.code !== 200) throw new Error(data.msg || '获取标签失败');
            return data.data || [];
        } catch (error) {
            console.error('标签获取失败:', error);
            showToast('标签加载失败，请重试', 'error');
            return [];
        }
    }

    // 辅助函数
    function saveDraft() {
        localStorage.setItem('codeDraft', editor.getValue());
        showToast('代码草稿已自动保存', 'info', 2000);
    }

    // 显示提交结果到按钮左边（一直保持）
    function showSubmitResult(data) {
        const resultElement = document.getElementById('submitResult');
        
        let resultClass = 'info';
        let resultText = '';
        let errorInfo = null;
        
        if (data.code === 200) {
            const judgeResult = data.data;
            if (judgeResult.status === "答案正确") {
                resultClass = 'success';
                resultText = '✓ 答案正确';
            } else {
                resultClass = 'error';
                resultText = '✗ ' + (judgeResult.status || '未知错误');
                errorInfo = judgeResult.errorInfo;
            }
        } else {
            resultClass = 'error';
            resultText = '✗ ' + (data.msg || '提交失败');
        }
        
        resultElement.className = `submit-result ${resultClass}`;
        resultElement.textContent = resultText;
        
        // 如果有错误信息，添加点击事件
        if (errorInfo) {
            resultElement.style.cursor = 'pointer';
            resultElement.innerHTML = resultText + ' <span style="font-size: 12px; opacity: 0.8;">(点击查看详情)</span>';
            resultElement.onclick = () => showErrorDetail(errorInfo);
        } else {
            resultElement.style.cursor = 'default';
            resultElement.onclick = null;
        }
        
        // 结果一直保持显示，不自动清除
    }
    
    function showErrorDetail(errorInfo) {
        // 创建弹窗
        const modal = document.createElement('div');
        modal.className = 'error-detail-modal';
        modal.innerHTML = `
            <div class="error-detail-content">
                <div class="error-detail-header">
                    <div class="error-detail-title">错误详情</div>
                    <button class="error-detail-close">&times;</button>
                </div>
                <div class="error-detail-body">
                    ${formatErrorInfo(errorInfo)}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // 显示弹窗
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        
        // 关闭弹窗事件
        const closeBtn = modal.querySelector('.error-detail-close');
        const closeModal = () => {
            modal.classList.remove('show');
            setTimeout(() => {
                if (modal.parentNode) {
                    document.body.removeChild(modal);
                }
            }, 300);
        };
        
        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // ESC键关闭
        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
    }
    
    function formatErrorInfo(errorInfo) {
        if (!errorInfo) return '';
        
        // 处理换行符
        let formatted = errorInfo.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        // 检查是否包含测试用例信息
        if (formatted.includes('输入:') && formatted.includes('期待输出:') && formatted.includes('实际输出:')) {
            // 解析测试用例信息
            const lines = formatted.split('\n');
            let result = '<div class="test-case-info">';
            let lineCount = 0;
            const maxLines = 20; // 最多显示20行
            
            for (let line of lines) {
                line = line.trim();
                if (lineCount >= maxLines) {
                    result += '<div class="test-case-item" style="color: #6c757d; font-style: italic;">... (更多内容已省略)</div>';
                    break;
                }
                
                if (line.startsWith('输入:')) {
                    result += `<div class="test-case-item"><span class="label">输入:</span> <code>${line.substring(3).trim()}</code></div>`;
                    lineCount++;
                } else if (line.startsWith('期待输出:')) {
                    result += `<div class="test-case-item"><span class="label">期待输出:</span> <code>${line.substring(5).trim()}</code></div>`;
                    lineCount++;
                } else if (line.startsWith('实际输出:')) {
                    result += `<div class="test-case-item"><span class="label">实际输出:</span> <code>${line.substring(5).trim() || '(空)'}</code></div>`;
                    lineCount++;
                } else if (line) {
                    result += `<div class="test-case-item">${line}</div>`;
                    lineCount++;
                }
            }
            
            result += '</div>';
            return result;
        } else {
            // 普通错误信息，限制行数
            const lines = formatted.split('\n');
            const maxLines = 15; // 最多显示15行
            if (lines.length > maxLines) {
                const truncatedLines = lines.slice(0, maxLines);
                return truncatedLines.join('<br>') + '<br><span style="color: #6c757d; font-style: italic;">... (更多内容已省略)</span>';
            }
            return formatted.replace(/\n/g, '<br>');
        }
    }

    // 显示美化的提示框
    function showToast(message, type = 'info', duration = 3000) {
        // 移除已存在的toast
        const existingToast = document.querySelector('.status-toast');
        if (existingToast) {
            existingToast.remove();
        }

        // 创建新的toast
        const toast = document.createElement('div');
        toast.className = `status-toast status-${type}`;

        // 根据类型添加不同的图标
        let icon = '';
        if (type === 'success') {
            icon = '<i class="fas fa-check-circle"></i>';
        } else if (type === 'error') {
            icon = '<i class="fas fa-times-circle"></i>';
        } else {
            icon = '<i class="fas fa-info-circle"></i>';
        }

        toast.innerHTML = `${icon}<span>${message}</span>`;
        document.body.appendChild(toast);

        // 显示动画
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        // 自动消失
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // 显示自定义确认对话框
    function showConfirmDialog(message) {
        return new Promise((resolve) => {
            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;

            // 创建对话框
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 24px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                transform: scale(0.9);
                transition: transform 0.3s ease;
            `;

            dialog.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-question-circle" style="font-size: 2rem; color: #667eea; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-size: 1.1rem; color: #2d3748; line-height: 1.5;">${message}</p>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button id="confirmCancel" style="
                        padding: 10px 20px;
                        border: 1px solid #e2e8f0;
                        background: white;
                        color: #4a5568;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.95rem;
                        transition: all 0.2s ease;
                    ">取消</button>
                    <button id="confirmOk" style="
                        padding: 10px 20px;
                        border: none;
                        background: #e53e3e;
                        color: white;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.95rem;
                        transition: all 0.2s ease;
                    ">确定</button>
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // 显示动画
            setTimeout(() => {
                overlay.style.opacity = '1';
                dialog.style.transform = 'scale(1)';
            }, 10);

            // 绑定事件
            const cancelBtn = dialog.querySelector('#confirmCancel');
            const okBtn = dialog.querySelector('#confirmOk');

            const cleanup = () => {
                overlay.style.opacity = '0';
                dialog.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 300);
            };

            cancelBtn.addEventListener('click', () => {
                cleanup();
                resolve(false);
            });

            okBtn.addEventListener('click', () => {
                cleanup();
                resolve(true);
            });

            // 点击遮罩层关闭
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    cleanup();
                    resolve(false);
                }
            });

            // 按钮悬停效果
            cancelBtn.addEventListener('mouseenter', () => {
                cancelBtn.style.background = '#f7fafc';
                cancelBtn.style.borderColor = '#cbd5e0';
            });
            cancelBtn.addEventListener('mouseleave', () => {
                cancelBtn.style.background = 'white';
                cancelBtn.style.borderColor = '#e2e8f0';
            });

            okBtn.addEventListener('mouseenter', () => {
                okBtn.style.background = '#c53030';
            });
            okBtn.addEventListener('mouseleave', () => {
                okBtn.style.background = '#e53e3e';
            });
        });
    }

    function formatTime(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // 页面加载初始化
    window.addEventListener('DOMContentLoaded', async () => {
        if (!localStorage.getItem('token')) {
            showToast('请先登录！', 'error');
            setTimeout(() => {
                window.location.href = '/index.html';
            }, 1500);
            return;
        }

        // 初始化 Monaco Editor
        initMonacoEditor();

        // 初始化自定义选择框
        initCustomSelect();

        // 等待 Monaco Editor 加载完成，如果失败则使用 fallback
        setTimeout(() => {
            // 检查是否初始化成功
            if (!editor) {
                console.log('Monaco Editor 初始化失败，使用 fallback textarea');
                const editorElement = document.getElementById('codeEditor');
                if (editorElement && !document.getElementById('fallbackEditor')) {
                    editorElement.innerHTML = '<textarea id="fallbackEditor" style="width: 100%; height: 100%; border: none; outline: none; font-family: monospace; font-size: 14px; padding: 10px; resize: none;">#include <iostream>\nusing namespace std;\n\nint main() {\n    // 请在此处编写你的代码\n    \n    return 0;\n}</textarea>';

                    // 绑定 fallback editor 的事件
                    const fallbackEditor = document.getElementById('fallbackEditor');
                    if (fallbackEditor) {
                        fallbackEditor.addEventListener('input', function() {
                            document.getElementById('codeEditorHidden').value = this.value;
                        });
                    }
                }
            }

            // 初始设置为C++17
            switchLanguage('cpp');
        }, 2000);

        // 渲染Markdown内容
        if (typeof DOMPurify !== 'undefined') {
            renderMarkdownElements();
        }

        // 加载标签
        const problemId = document.querySelector('input[name="problemId"]').value;
        const token = localStorage.getItem('token');
        const tagsContainer = document.getElementById('tagsContainer');

        if (problemId) {
            const tags = await fetchProblemTags(problemId, token);
            if (tags.length > 0) {
                tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.textContent = tag.name || tag;
                    tagsContainer.appendChild(tagElement);
                });
            } else {
                const noTags = document.createElement('span');
                noTags.className = 'text-muted';
                noTags.style.fontSize = '0.9rem';
                noTags.textContent = '无标签';
                tagsContainer.appendChild(noTags);
            }
        }
    });

    // 表单提交处理
    document.getElementById('submitForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalButtonText = submitBtn.innerHTML;
        const option = document.getElementById('languageSelectHidden').value;

        if (option === "java") {
            showToast("暂不支持用Java提交，请等待", 'error');
            return;
        }

        // 显示提交中的提示
        showToast('评测中，请稍候...', 'info', 10000);

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>提交中...';

        // 提取时间和内存限制
        const timeText = document.getElementById('time').textContent;
        const timeValue = timeText.split('：')[1].split(' ')[0];

        const memoryText = document.getElementById('memory').textContent;
        const memoryValue = memoryText.split('：')[1].split(' ')[0];

        try {
            const currentDate = new Date();
            let code = '';

            if (editor) {
                // Monaco Editor 模式
                code = editor.getValue();
            } else {
                // Fallback textarea 模式
                const fallbackEditor = document.getElementById('fallbackEditor');
                if (fallbackEditor) {
                    code = fallbackEditor.value;
                } else {
                    code = document.getElementById('codeEditorHidden').value;
                }
            }

            const pid = document.querySelector('input[name="problemId"]').value;
            const uname = localStorage.getItem('name');
            const cid = "0";
            const create_time = formatTime(currentDate);
            const time = timeValue;
            const memory = memoryValue;

            const response = await fetch('/judge/submit', {
                method: 'POST',
                body: JSON.stringify({ code, option, pid, uname, cid, create_time, time, memory }),
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            // 显示结果到按钮左边（一直保持）
            showSubmitResult(data);
            
            // 同时显示右上角通知
            if (data.code === 200) {
                const judgeResult = data.data;
                if(judgeResult.status === "答案正确"){
                    showToast(`${judgeResult.status}！`, 'success', 5000);
                }
                else{
                    showToast(`${judgeResult.status || judgeResult.errorInfo || '未知错误'}！`, 'error', 5000);
                }
            } else {
                showToast(`${data.msg}！`, 'error', 5000);
            }

        } catch (error) {
            showToast('网络连接异常，请检查网络后重试', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalButtonText;
        }
    });

    // 评论功能相关代码
    let currentProblemId = null;
    let currentUserId = null;
    let currentUsername = null;
    let currentReceiveUserId = null; // 当前回复的目标用户ID

    // 初始化评论功能
    function initCommentSystem() {
        currentProblemId = document.querySelector('input[name="problemId"]').value;
        currentUserId = localStorage.getItem('id');
        currentUsername = localStorage.getItem('name');

        if (!currentUserId || !currentUsername) {
            showToast('请先登录后再发表评论', 'error');
            return;
        }

        // 加载评论列表
        loadComments();

        // 绑定事件
        bindCommentEvents();

        // 初始化emoji选择器
        initEmojiPicker();

        // 检查URL参数中是否有commentId，如果有则自动定位和高亮
        const urlParams = new URLSearchParams(window.location.search);
        const commentId = urlParams.get('commentId');
        if (commentId) {
            // 延迟执行，确保评论已经加载完成
            setTimeout(() => {
                highlightComment(commentId);
            }, 1000);
        }
    }

    // 绑定评论相关事件
    function bindCommentEvents() {
        // 发表评论
        document.getElementById('submitComment').addEventListener('click', submitComment);

        // 使用事件委托处理回复和删除按钮
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('reply') || e.target.closest('.reply')) {
                e.preventDefault();
                const replyBtn = e.target.classList.contains('reply') ? e.target : e.target.closest('.reply');
                const commentId = replyBtn.dataset.commentId;
                currentReceiveUserId = replyBtn.dataset.receiveUserId; // 保存被回复用户的ID
                showReplyForm(commentId);
            } else if (e.target.classList.contains('delete') || e.target.closest('.delete')) {
                e.preventDefault();
                const deleteBtn = e.target.classList.contains('delete') ? e.target : e.target.closest('.delete');
                const commentId = deleteBtn.dataset.commentId;
                deleteComment(commentId);
            } else if (e.target.classList.contains('submit-reply')) {
                e.preventDefault();
                const commentId = e.target.dataset.commentId;
                submitReply(commentId);
            } else if (e.target.classList.contains('cancel-reply')) {
                e.preventDefault();
                const commentId = e.target.dataset.commentId;
                hideReplyForm(commentId);
            }
        });
    }

    // 加载评论列表
    async function loadComments() {
        try {
            const response = await fetch(`/comment/list?pid=${currentProblemId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            if (data.code === 200) {
                renderComments(data.data);
                updateCommentCount(data.data.length);
            } else {
                showToast('加载评论失败', 'error');
            }
        } catch (error) {
            console.error('加载评论失败:', error);
            showToast('网络连接异常，请检查网络后重试', 'error');
        }
    }

    // 渲染评论列表
    function renderComments(comments) {
        const commentList = document.getElementById('commentList');

        if (!comments || comments.length === 0) {
            commentList.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i>
                    <p>暂无评论，快来发表第一条评论吧！</p>
                </div>
            `;
            return;
        }

        commentList.innerHTML = comments.map(comment => renderCommentItem(comment)).join('');
    }

    // 渲染单个评论项（顶级评论）
    function renderCommentItem(comment) {
        const isOwner = comment.userId == currentUserId;
        const avatarText = comment.username ? comment.username.charAt(0).toUpperCase() : 'U';

        // 渲染子评论
        let subcommentsHtml = '';
        if (comment.subcommentList && comment.subcommentList.length > 0) {
            subcommentsHtml = `
                <div class="subcomment-list">
                    ${comment.subcommentList.map(subcomment => renderSubcommentItem(subcomment)).join('')}
                </div>
            `;
        }

        return `
            <div class="comment-item" data-comment-id="${comment.id}">
                <div class="comment-header">
                    <div class="comment-author">
                        <div class="avatar">${avatarText}</div>
                        <span class="name">${comment.username || '匿名用户'}</span>
                    </div>
                    <div class="comment-time">${formatCommentTime(comment.createTime)}</div>
                </div>
                <div class="comment-content">${escapeHtml(comment.content)}</div>
                <div class="comment-actions">
                    <button class="comment-action reply" data-comment-id="${comment.id}" data-receive-user-id="${comment.userId}">
                        <i class="fas fa-reply me-1"></i>回复
                    </button>
                    ${isOwner ? `
                        <button class="comment-action delete" data-comment-id="${comment.id}">
                            <i class="fas fa-trash me-1"></i>删除
                        </button>
                    ` : ''}
                </div>
                <div class="reply-form" id="reply-form-${comment.id}">
                    <textarea placeholder="回复 ${comment.username || '匿名用户'}..." rows="3"></textarea>
                    <div class="reply-actions">
                        <button class="reply-btn secondary cancel-reply" data-comment-id="${comment.id}">取消</button>
                        <button class="reply-btn primary submit-reply" data-comment-id="${comment.id}">回复</button>
                    </div>
                </div>
                ${subcommentsHtml}
            </div>
        `;
    }

    // 渲染子评论项
    function renderSubcommentItem(subcomment) {
        const isOwner = subcomment.userId == currentUserId;
        const avatarText = subcomment.username ? subcomment.username.charAt(0).toUpperCase() : 'U';

        // 构建回复显示文本
        let replyText = '';
        if (subcomment.parentId && subcomment.parentUsername) {
            replyText = `<span class="reply-to">回复 <span class="reply-username">@${subcomment.parentUsername}</span></span>`;
        }

        return `
            <div class="subcomment-item" data-comment-id="${subcomment.id}">
                <div class="comment-header">
                    <div class="comment-author">
                        <div class="avatar">${avatarText}</div>
                        <span class="name">${subcomment.username || '匿名用户'}</span>
                        ${replyText}
                    </div>
                    <div class="comment-time">${formatCommentTime(subcomment.createTime)}</div>
                </div>
                <div class="comment-content">${escapeHtml(subcomment.content)}</div>
                <div class="comment-actions">
                    <button class="comment-action reply" data-comment-id="${subcomment.id}" data-receive-user-id="${subcomment.userId}">
                        <i class="fas fa-reply me-1"></i>回复
                    </button>
                    ${isOwner ? `
                        <button class="comment-action delete" data-comment-id="${subcomment.id}">
                            <i class="fas fa-trash me-1"></i>删除
                        </button>
                    ` : ''}
                </div>
                <div class="reply-form" id="reply-form-${subcomment.id}">
                    <textarea placeholder="回复 ${subcomment.username || '匿名用户'}..." rows="3"></textarea>
                    <div class="reply-actions">
                        <button class="reply-btn secondary cancel-reply" data-comment-id="${subcomment.id}">取消</button>
                        <button class="reply-btn primary submit-reply" data-comment-id="${subcomment.id}">回复</button>
                    </div>
                </div>
            </div>
        `;
    }


    // 发表评论
    async function submitComment() {
        const content = document.getElementById('commentContent').value.trim();

        if (!content) {
            showToast('请输入评论内容', 'error');
            return;
        }

        if (!currentUserId || !currentUsername) {
            showToast('请先登录后再发表评论', 'error');
            return;
        }

        try {
            const response = await fetch('/comment/publish', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    problemId: parseInt(currentProblemId),
                    parentId: null,
                    receiveUserId: null, // 顶级评论没有回复特定用户
                    username: currentUsername,
                    content: content,
                    createTime: new Date().toISOString()
                })
            });

            const data = await response.json();
            if (data.code === 200) {
                showToast('评论发表成功', 'success');
                document.getElementById('commentContent').value = '';
                loadComments(); // 重新加载评论列表
            } else {
                showToast(data.msg || '评论发表失败', 'error');
            }
        } catch (error) {
            console.error('发表评论失败:', error);
            showToast('网络连接异常，请检查网络后重试', 'error');
        }
    }

    // 显示回复表单
    function showReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
            replyForm.classList.add('show');
            replyForm.querySelector('textarea').focus();
        }
    }

    // 隐藏回复表单
    function hideReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
            replyForm.classList.remove('show');
            replyForm.querySelector('textarea').value = '';
        }
        currentReceiveUserId = null; // 清空被回复用户ID
    }

    // 提交回复
    async function submitReply(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        const content = replyForm.querySelector('textarea').value.trim();

        if (!content) {
            showToast('请输入回复内容', 'error');
            return;
        }

        if (!currentUserId || !currentUsername) {
            showToast('请先登录后再发表回复', 'error');
            return;
        }

        try {
            const response = await fetch('/comment/publish', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    problemId: parseInt(currentProblemId),
                    parentId: parseInt(commentId),
                    receiveUserId: currentReceiveUserId ? parseInt(currentReceiveUserId) : null,
                    username: currentUsername,
                    content: content,
                    createTime: new Date().toISOString()
                })
            });

            const data = await response.json();
            if (data.code === 200) {
                showToast('回复发表成功', 'success');
                hideReplyForm(commentId);
                loadComments(); // 重新加载评论列表
            } else {
                showToast(data.msg || '回复发表失败', 'error');
            }
        } catch (error) {
            console.error('发表回复失败:', error);
            showToast('网络连接异常，请检查网络后重试', 'error');
        }
    }

    // 删除评论
    async function deleteComment(commentId) {
        // 使用自定义确认对话框
        const confirmed = await showConfirmDialog('确定要删除这条评论吗？');
        if (!confirmed) {
            return;
        }

        try {
            const response = await fetch(`/comment/delete?commentId=${commentId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            if (data.code === 200) {
                showToast('评论删除成功', 'success');
                loadComments(); // 重新加载评论列表
            } else {
                showToast(data.msg || '评论删除失败', 'error');
            }
        } catch (error) {
            console.error('删除评论失败:', error);
            showToast('网络连接异常，请检查网络后重试', 'error');
        }
    }

    // 更新评论数量
    function updateCommentCount(count) {
        const commentCountElement = document.getElementById('commentCount');
        if (commentCountElement) {
            commentCountElement.textContent = count;
        }
    }

    // 转义HTML字符
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 格式化时间（评论专用）
    function formatCommentTime(timeString) {
        const date = new Date(timeString);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) { // 1分钟内
            return '刚刚';
        } else if (diff < 3600000) { // 1小时内
            return Math.floor(diff / 60000) + '分钟前';
        } else if (diff < 86400000) { // 1天内
            return Math.floor(diff / 3600000) + '小时前';
        } else if (diff < 2592000000) { // 30天内
            return Math.floor(diff / 86400000) + '天前';
        } else {
            return date.toLocaleDateString();
        }
    }

    // Emoji选择器功能
    function initEmojiPicker() {
        const emojiTrigger = document.getElementById('emojiTrigger');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiGrid = document.getElementById('emojiGrid');
        const commentTextarea = document.getElementById('commentContent');

        // Emoji数据
        const emojiData = {
            smileys: ['😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '🙃', '😉', '😊', '😇', '🥰', '😍', '🤩', '😘', '😗', '😚', '😙', '😋', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔', '🤐', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '🥵', '🥶', '🥴', '😵', '🤯', '🤠', '🥳', '😎', '🤓', '🧐'],
            people: ['👶', '🧒', '👦', '👧', '🧑', '👨', '👩', '🧓', '👴', '👵', '👤', '👥', '🫂', '👋', '🤚', '🖐', '✋', '🖖', '👌', '🤏', '✌', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝', '👍', '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍', '💅', '🤳', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠', '🦷', '🦴', '👀', '👁', '👅', '👄', '💋', '🩸'],
            animals: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐸', '🐵', '🙈', '🙉', '🙊', '🐒', '🦍', '🦧', '🐕', '🐩', '🦮', '🐕‍🦺', '🐈', '🐈‍⬛', '🦄', '🐎', '🦓', '🦌', '🐂', '🐃', '🐄', '🐪', '🐫', '🦙', '🦒', '🐘', '🦏', '🦛', '🐐', '🐑', '🐏', '🐚', '🐌', '🦋', '🐛', '🐜', '🐝', '🐞', '🦗', '🕷', '🕸', '🦂', '🦟', '🦠', '🐢', '🐍', '🦎', '🦖', '🦕', '🐙', '🦑', '🦐', '🦞', '🦀', '🐡', '🐠', '🐟', '🐬', '🐳', '🐋', '🦈', '🐊', '🐅', '🐆'],
            food: ['🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶', '🫒', '🌽', '🥕', '🫑', '🥔', '🍠', '🥐', '🥖', '🍞', '🥨', '🥯', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭', '🍔', '🍟', '🍕', '🫓', '🥙', '🌮', '🌯', '🫔', '🥗', '🥘', '🫕', '🥫', '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🦪', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯'],
            travel: ['🚗', '🚕', '🚙', '🚌', '🚎', '🏎', '🚓', '🚑', '🚒', '🚐', '🛻', '🚚', '🚛', '🚜', '🏍', '🛵', '🚲', '🛴', '🛹', '🛼', '🚁', '✈', '🛩', '🛫', '🛬', '🪂', '💺', '🚀', '🛸', '🚉', '🚊', '🚝', '🚞', '🚋', '🚃', '🚋', '🚞', '🚝', '🚄', '🚅', '🚈', '🚂', '🚆', '🚇', '🚊', '🚉', '✈', '🛫', '🛬', '🛩', '💺', '🛰', '🚀', '🛸', '🚁', '🛶', '⛵', '🚤', '🛥', '🛳', '⛴', '🚢', '⚓', '🚧', '⛽', '🚨', '🚥', '🚦', '🛑', '🚏', '🗺', '🗿', '🗽', '🗼', '🏰', '🏯', '🏟', '🎡', '🎢', '🎠', '⛲', '⛱', '🏖', '🏝', '🏔', '⛰', '🌋', '🗻', '🏕', '⛺', '🛖', '🏠', '🏡', '🏘', '🏚', '🏗', '🏭', '🏢', '🏬', '🏣', '🏤', '🏥', '🏦', '🏨', '🏪', '🏫', '🏩', '💒', '🏛', '⛪', '🕌', '🛕', '🕍', '🕋', '⛩', '🛤', '🛣', '🗾', '🎑', '🏞', '🌅', '🌄', '🌠', '🎇', '🎆', '🌇', '🌆', '🏙', '🌃', '🌌', '🌉', '🌁'],
            objects: ['⌚', '📱', '📲', '💻', '⌨', '🖥', '🖨', '🖱', '🖲', '🕹', '🗜', '💽', '💾', '💿', '📀', '📼', '📷', '📸', '📹', '🎥', '📽', '🎞', '📞', '☎', '📟', '📠', '📺', '📻', '🎙', '🎚', '🎛', '🧭', '⏱', '⏲', '⏰', '🕰', '⌛', '⏳', '📡', '🔋', '🔌', '💡', '🔦', '🕯', '🪔', '🧯', '🛢', '💸', '💵', '💴', '💶', '💷', '🪙', '💰', '💳', '💎', '⚖', '🪜', '🧰', '🔧', '🔨', '⚒', '🛠', '⛏', '🪚', '🔩', '⚙', '🪤', '🧱', '⛓', '🧲', '🔫', '💣', '🧨', '🪓', '🔪', '🗡', '⚔', '🛡', '🚬', '⚰', '🪦', '⚱', '🏺', '🔮', '📿', '🧿', '💈', '⚗', '🔭', '🔬', '🕳', '🩹', '🩺', '💊', '💉', '🧬', '🦠', '🧫', '🧪', '🌡', '🧹', '🧺', '🧻', '🚽', '🚰', '🚿', '🛁', '🛀', '🧼', '🪥', '🪒', '🧽', '🧴', '🛎', '🔑', '🗝', '🚪', '🪑', '🛏', '🛋', '🪞', '🪟', '🛍', '🛒', '🎁', '🎈', '🎏', '🎀', '🪄', '🪅', '🎊', '🎉', '🎎', '🏮', '🪔', '🧧', '✉', '📧', '📨', '📩', '📤', '📥', '📦', '📫', '📪', '📬', '📭', '📮', '🗳', '✏', '✒', '🖋', '🖊', '🖌', '🖍', '📝', '💼', '📁', '📂', '🗂', '📅', '📆', '🗒', '🗓', '📇', '📈', '📉', '📊', '📋', '📌', '📍', '📎', '🖇', '📏', '📐', '✂', '🗃', '🗄', '🗑', '🔒', '🔓', '🔏', '🔐', '🔑', '🗝', '🔨', '🪓', '⛏', '⚒', '🛠', '🗡', '⚔', '🔫', '🏹', '🛡', '🔧', '🪚', '🔩', '⚙', '🪤', '🧰', '⚖', '🦽', '🦼', '🛢', '🛞', '⚗', '🧪', '🧫', '🧬', '🦠', '🧭', '🪜', '🧲', '🧰', '🪚', '🔧', '🔨', '⚒', '🛠', '⛏', '🪚', '🔩', '⚙', '🪤', '🧱', '⛓', '🧲', '🔫', '💣', '🧨', '🪓', '🔪', '🗡', '⚔', '🛡', '🚬', '⚰', '🪦', '⚱', '🏺', '🔮', '📿', '🧿', '💈', '⚗', '🔭', '🔬', '🕳', '🩹', '🩺', '💊', '💉', '🧬', '🦠', '🧫', '🧪', '🌡', '🧹', '🧺', '🧻', '🚽', '🚰', '🚿', '🛁', '🛀', '🧼', '🪥', '🪒', '🧽', '🧴', '🛎', '🔑', '🗝', '🚪', '🪑', '🛏', '🛋', '🪞', '🪟', '🛍', '🛒', '🎁', '🎈', '🎏', '🎀', '🪄', '🪅', '🎊', '🎉', '🎎', '🏮', '🪔', '🧧'],
            symbols: ['❤', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❣', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '☮', '✝', '☪', '🕉', '☸', '✡', '🔯', '🕎', '☯', '☦', '🛐', '⛎', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓', '🆔', '⚛', '🉑', '☢', '☣', '📴', '📳', '🈶', '🈚', '🈸', '🈺', '🈷', '✴', '🆚', '💮', '🉐', '㊙', '㊗', '🈴', '🈵', '🈹', '🈲', '🅰', '🅱', '🆎', '🅾', '🆘', '❌', '⭕', '🛑', '⛔', '📛', '🚫', '💯', '💢', '♨', '🚷', '🚯', '🚳', '🚱', '🔞', '📵', '🚭', '❗', '❕', '❓', '❔', '‼', '⁉', '🔅', '🔆', '〽', '⚠', '🚸', '🔱', '⚜', '🔰', '♻', '✅', '🈯', '💹', '❇', '✳', '❎', '🌐', '💠', 'Ⓜ', '🌀', '💤', '🏧', '🚾', '♿', '🅿', '🈳', '🈂', '🛂', '🛃', '🛄', '🛅', '🚹', '🚺', '🚼', '🚻', '🚮', '🎦', '📶', '🈁', '🔣', 'ℹ', '🔤', '🔡', '🔠', '🆖', '🆗', '🆙', '🆒', '🆕', '🆓', '0️⃣', '1️⃣', '2️⃣', '3️⃣', '4️⃣', '5️⃣', '6️⃣', '7️⃣', '8️⃣', '9️⃣', '🔟']
        };

        // 切换emoji选择器显示/隐藏
        emojiTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.classList.toggle('show');
        });

        // 点击其他地方关闭emoji选择器
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && !emojiTrigger.contains(e.target)) {
                emojiPicker.classList.remove('show');
            }
        });

        // 切换emoji分类
        document.querySelectorAll('.emoji-category').forEach(category => {
            category.addEventListener('click', (e) => {
                e.preventDefault();

                // 更新激活状态
                document.querySelectorAll('.emoji-category').forEach(cat => cat.classList.remove('active'));
                category.classList.add('active');

                // 显示对应分类的emoji
                const categoryName = category.dataset.category;
                renderEmojiGrid(emojiData[categoryName]);
            });
        });

        // 渲染emoji网格
        function renderEmojiGrid(emojis) {
            emojiGrid.innerHTML = '';
            emojis.forEach(emoji => {
                const emojiButton = document.createElement('button');
                emojiButton.className = 'emoji-item';
                emojiButton.textContent = emoji;
                emojiButton.addEventListener('click', () => {
                    insertEmoji(emoji);
                });
                emojiGrid.appendChild(emojiButton);
            });
        }

        // 插入emoji到文本区域
        function insertEmoji(emoji) {
            const textarea = commentTextarea;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const before = text.substring(0, start);
            const after = text.substring(end, text.length);

            // 插入emoji到光标位置
            textarea.value = before + emoji + after;

            // 设置光标位置到emoji后面
            const newPosition = start + emoji.length;
            textarea.selectionStart = textarea.selectionEnd = newPosition;

            // 聚焦到文本框
            textarea.focus();

            // 关闭emoji选择器
            emojiPicker.classList.remove('show');

            // 触发input事件，确保其他监听器能检测到变化
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // 初始化显示第一个分类的emoji
        renderEmojiGrid(emojiData.smileys);
    }

    // 高亮指定评论并滚动到该位置
    function highlightComment(commentId) {
        // 尝试查找评论元素（可能是顶级评论或子评论）
        let commentElement = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
        if (!commentElement) {
            commentElement = document.querySelector(`.subcomment-item[data-comment-id="${commentId}"]`);
        }

        if (commentElement) {
            // 添加高亮样式
            commentElement.classList.add('comment-highlight');

            // 滚动到该评论位置
            commentElement.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            // 3秒后移除高亮效果
            setTimeout(() => {
                commentElement.classList.remove('comment-highlight');
            }, 3000);

            console.log('成功高亮评论，commentId:', commentId);
        } else {
            console.log('未找到指定的评论，commentId:', commentId);
            // 如果评论还没加载，可以尝试重新加载评论列表
            setTimeout(() => {
                loadComments();
                setTimeout(() => {
                    highlightComment(commentId);
                }, 500);
            }, 1000);
        }
    }

    // 页面加载完成后初始化评论系统
    document.addEventListener('DOMContentLoaded', function() {
        // 延迟初始化，确保其他功能先加载完成
        setTimeout(initCommentSystem, 1000);
    });
</script>
</body>
<script src="/libs/ai-widget.js"></script>
</html>