<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${competition_problem.id} + ' - ' + ${competition_problem.title}"></title>

  <!-- 核心样式库 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Markdown 相关资源 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.1/purify.min.js"></script>

  <!-- Monaco Editor 样式 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/editor/editor.main.css">

  <style>
    :root {
      --primary: #1a73e8;
      --secondary: #2f855a;
      --primary-color: #1a73e8;
      --secondary-color: #2f855a;
      --text: #2d3748;
      --neutral-dark: #2d3748;
      --neutral-medium: #4a5568;
      --neutral-light: #e2e8f0;
      --success: #2ea44f;
      --danger: #d73a49;
      --info: #0366d6;
      --bg-light: #f6f8fa;
      --border-radius: 6px;
      --border-color: #e1e4e8;
    }
    .hidden {
      display: none !important;
    }
    body {
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      line-height: 1.5;
      color: #24292e;
    }

    .problem-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .card {
      border-radius: var(--border-radius);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .card-header {
      background-color: var(--bg-light);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 16px;
    }

    .problem-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 30px;
    }

    .problem-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 2rem;
      color: var(--primary);
      font-weight: 600;
    }

    .problem-meta {
      display: flex;
      gap: 20px;
      font-size: 0.95rem;
      color: #586069;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .meta-item i {
      color: var(--primary);
      font-size: 1em;
    }

    .code-preview {
      background: var(--bg-light);
      border-radius: var(--border-radius);
      padding: 16px;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      line-height: 1.45;
      white-space: pre;
      overflow-x: auto;
      font-size: 85%;
      border: 1px solid var(--border-color);
    }

    .code-editor-container {
      background: white;
      border-radius: var(--border-radius);
      margin-top: 30px;
      padding: 20px;
      border: 1px solid var(--border-color);
    }

    /* Monaco Editor 容器样式 */
    .monaco-editor-container {
      position: relative;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      overflow: hidden;
      background: white;
    }

    .editor-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-bottom: 1px solid var(--border-color);
      font-size: 12px;
    }

    .editor-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .theme-toggle {
      background: transparent;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: #e9ecef;
    }

    .language-info {
      font-size: 12px;
      color: #6c757d;
      background: #e9ecef;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 500;
    }

    /* 美化后的下拉框样式 */
    .custom-select {
      position: relative;
      min-width: 180px;
      z-index: 1000;
    }

    .select-selected {
      background: linear-gradient(135deg, #e0f2fe, #bbdefb);
      color: var(--primary);
      padding: 0.75rem 1rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.1);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 2px solid transparent;
    }

    .select-selected:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
      border-color: rgba(26, 115, 232, 0.3);
    }

    .select-selected:after {
      content: "\f078";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      font-size: 0.8rem;
      transition: transform 0.3s ease;
    }

    .select-selected.select-arrow-active:after {
      transform: rotate(180deg);
    }

    .select-items {
      position: absolute;
      background-color: white;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 9999;
      border-radius: 12px;
      margin-top: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      max-height: 300px;
      overflow-y: auto;
      display: none;
      transform: translateY(-10px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(26, 115, 232, 0.1);
    }

    .select-items.active {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
      display: block;
    }

    .select-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .select-item:last-child {
      border-bottom: none;
    }

    .select-item:hover {
      background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
      color: var(--primary);
      transform: translateX(4px);
    }

    .select-item.selected {
      background: linear-gradient(135deg, #e0f2fe, #bbdefb);
      color: var(--primary);
      font-weight: 600;
    }

    .language-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .language-icon {
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
    }

    /* 比赛期间不支持评论的提示样式 */
    .competition-notice {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
    }

    .competition-notice i {
      color: #856404;
      font-size: 1.2rem;
    }

    .competition-notice .notice-text {
      color: #856404;
      font-weight: 500;
      margin: 0;
    }

    /* 评论区域样式 */
    .comment-section {
      border: none;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
    }

    .comment-section .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px 12px 0 0;
      border: none;
    }

    .comment-section .card-header h4 {
      font-weight: 600;
    }

    .comment-form textarea {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      transition: all 0.3s ease;
      resize: vertical;
      min-height: 100px;
    }

    .comment-form textarea:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      outline: none;
    }

    /* Emoji选择器样式 */
    .comment-input-container {
      position: relative;
    }

    .emoji-picker-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .emoji-trigger {
      position: absolute;
      right: 15px;
      top: 15px;
      background: none;
      border: none;
      color: #6b7280;
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.2s;
    }

    .emoji-trigger:hover {
      color: #667eea;
    }

    .emoji-picker {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
      max-height: 300px;
      overflow: hidden;
    }

    .emoji-picker.show {
      display: block;
    }

    .emoji-categories {
      display: flex;
      padding: 10px;
      border-bottom: 1px solid #e2e8f0;
      gap: 5px;
      overflow-x: auto;
    }

    .emoji-category {
      background: none;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background-color 0.2s;
    }

    .emoji-category:hover {
      background: #f3f4f6;
    }

    .emoji-category.active {
      background: #667eea;
      color: white;
    }

    .emoji-grid {
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 5px;
    }

    .emoji-item {
      background: none;
      border: none;
      padding: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background-color 0.2s;
    }

    .emoji-item:hover {
      background: #f3f4f6;
    }

    .comment-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .comment-item {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      background: #f8fafc;
      transition: all 0.3s ease;
    }

    .comment-item:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .comment-author {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .name {
      font-weight: 600;
      color: #374151;
    }

    .comment-time {
      color: #6b7280;
      font-size: 0.875rem;
    }

    .comment-content {
      color: #374151;
      line-height: 1.6;
      margin-bottom: 1rem;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .comment-actions {
      display: flex;
      gap: 1rem;
    }

    .comment-action {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: all 0.2s;
      font-size: 0.875rem;
    }

    .comment-action:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .comment-action.reply:hover {
      color: #667eea;
    }

    .comment-action.delete:hover {
      color: #ef4444;
    }

    .reply-form {
      margin-top: 1rem;
      padding: 1rem;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      display: none;
    }

    .reply-form.show {
      display: block;
    }

    .reply-form textarea {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 0.75rem;
      resize: vertical;
      min-height: 80px;
      margin-bottom: 1rem;
    }

    .reply-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .reply-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .reply-btn.secondary {
      background: #f3f4f6;
      color: #6b7280;
    }

    .reply-btn.secondary:hover {
      background: #e5e7eb;
    }

    .reply-btn.primary {
      background: #667eea;
      color: white;
    }

    .reply-btn.primary:hover {
      background: #5a67d8;
    }

    /* 子评论样式 */
    .subcomment-list {
      margin-top: 1rem;
      padding-left: 2rem;
      border-left: 2px solid #e2e8f0;
    }

    .subcomment-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }

    .subcomment-item:last-child {
      margin-bottom: 0;
    }

    /* 空状态样式 */
    .comment-list .text-center {
      padding: 3rem 1rem;
    }

    .comment-list .text-center i {
      color: #cbd5e0;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .comment-item {
        padding: 1rem;
      }

      .comment-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .subcomment-list {
        padding-left: 1rem;
      }

      .comment-actions {
        flex-wrap: wrap;
      }
    }

    #codeEditor {
      height: 500px;
      width: 100%;
    }

    .submit-btn {
      background: var(--success);
      color: white;
      padding: 8px 24px;
      border-radius: var(--border-radius);
      font-weight: 600;
      transition: all 0.2s;
      border: none;
    }

    .submit-btn:hover {
      background: #2c974b;
      transform: translateY(-1px);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    /* GitHub风格的Markdown样式 */
    .markdown-content {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      line-height: 1.6;
      word-wrap: break-word;
      padding: 16px;
    }

    .markdown-content h1,
    .markdown-content h2 {
      padding-bottom: 0.3em;
      border-bottom: 1px solid var(--border-color);
      margin-top: 24px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .markdown-content h1 {
      font-size: 2em;
    }

    .markdown-content h2 {
      font-size: 1.5em;
    }

    .markdown-content h3 {
      font-size: 1.25em;
      font-weight: 600;
      margin-top: 24px;
      margin-bottom: 16px;
    }

    .markdown-content pre {
      background: var(--bg-light);
      padding: 16px;
      border-radius: var(--border-radius);
      overflow: auto;
      margin: 16px 0;
      border: 1px solid var(--border-color);
      line-height: 1.45;
    }

    .markdown-content code {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      background: rgba(27,31,35,0.05);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-size: 85%;
    }

    .markdown-content pre code {
      background: transparent;
      padding: 0;
      border-radius: 0;
    }

    .markdown-content img {
      max-width: 100%;
      box-sizing: content-box;
      background-color: #fff;
      margin: 16px 0;
    }

    .markdown-content table {
      border-spacing: 0;
      border-collapse: collapse;
      display: block;
      width: 100%;
      overflow: auto;
      margin: 16px 0;
    }

    .markdown-content th,
    .markdown-content td {
      padding: 6px 13px;
      border: 1px solid var(--border-color);
    }

    .markdown-content th {
      font-weight: 600;
      background: var(--bg-light);
    }

    .markdown-content tr {
      background-color: #fff;
      border-top: 1px solid var(--border-color);
    }

    .markdown-content tr:nth-child(2n) {
      background-color: var(--bg-light);
    }

    .markdown-content blockquote {
      padding: 0 1em;
      color: #6a737d;
      border-left: 0.25em solid var(--border-color);
      margin: 0 0 16px 0;
    }

    .markdown-content ul,
    .markdown-content ol {
      padding-left: 2em;
      margin-top: 0;
      margin-bottom: 16px;
    }

    .markdown-content li {
      word-wrap: break-word;
    }

    .markdown-content li > p {
      margin-top: 16px;
    }

    .markdown-content li + li {
      margin-top: 0.25em;
    }

    /* 标签样式 */
    .tag {
      display: inline-block;
      padding: 0 10px;
      font-size: 12px;
      font-weight: 500;
      line-height: 22px;
      color: #0366d6;
      background-color: #f1f8ff;
      border-radius: 2em;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    /* 美化的判题结果弹框 */
    .status-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      font-size: 1.05rem;
      font-weight: 500;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 300px;
      max-width: 450px;
    }

    .status-toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .status-success {
      background: #f0fff4;
      color: #22543d;
      border-left: 4px solid #38a169;
    }

    .status-error {
      background: #fff5f5;
      color: #742a2a;
      border-left: 4px solid #e53e3e;
    }

    .status-info {
      background: #edf2ff;
      color: #2c5282;
      border-left: 4px solid #4299e1;
    }

    .status-toast i {
      font-size: 1.3em;
    }

    @media (max-width: 768px) {
      .problem-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .CodeMirror {
        height: 350px;
      }

      .status-toast {
        min-width: auto;
        max-width: calc(100% - 40px);
      }
    }
  </style>
</head>
<body>
<div class="problem-container hidden">
  <!-- 题目头部 -->
  <div class="card info-card">
    <div class="problem-header p-4">
      <div class="problem-title">
        <i class="fas fa-code text-primary"></i>
        <span th:text="${competition_problem.title}"></span>
      </div>
      <div class="problem-meta d-flex justify-content-between align-items-center">
        <div>
          <div class="meta-item">
            <i class="fas fa-clock"></i>
            <span id="time" th:text="'时间限制：' + ${competition_problem.timeLimit} + ' ms'"></span>
          </div>
          <div class="meta-item">
            <i class="fas fa-memory"></i>
            <span id="memory" th:text="'内存限制：' + ${competition_problem.memoryLimit} + ' MB'"></span>
          </div>
          <!-- 标签区域 -->
          <div class="meta-item">
            <i class="fas fa-tags text-primary"></i>
            <div id="tagsContainer" class="d-flex align-items-center flex-wrap gap-1"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 题目描述 -->
  <div class="card info-card">
    <div class="card-header">
      <h4 class="mb-0">题目描述</h4>
    </div>
    <div class="markdown-content" th:text="${competition_problem.description}"></div>
  </div>

  <!-- 输入格式 -->
  <div class="card info-card">
    <div class="card-header">
      <h4 class="mb-0">输入格式</h4>
    </div>
    <div class="markdown-content" th:text="${competition_problem.inputFormat}"></div>
  </div>

  <!-- 输出格式 -->
  <div class="card info-card">
    <div class="card-header">
      <h4 class="mb-0">输出格式</h4>
    </div>
    <div class="markdown-content" th:text="${competition_problem.outputFormat}"></div>
  </div>

  <!-- 输入输出样例 -->
  <div class="row g-4 mt-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">输入样例</h5>
        </div>
        <div class="code-preview" th:utext="${competition_problem.inputExample}"></div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">输出样例</h5>
        </div>
        <div class="code-preview" th:utext="${competition_problem.outputExample}"></div>
      </div>
    </div>
  </div>

  <!-- 提示 -->
  <div class="card info-card mt-4">
    <div class="card-header">
      <h4 class="mb-0">提示</h4>
    </div>
    <div class="markdown-content" th:text="${competition_problem.hint}"></div>
  </div>

  <!-- 比赛期间不支持评论的提示 -->
  <div class="competition-notice" id="competitionNotice">
    <i class="fas fa-exclamation-triangle"></i>
    <p class="notice-text">比赛期间不支持评论功能，请专注于解题。比赛结束后可正常使用评论功能。</p>
  </div>

  <!-- 评论区域 -->
  <div class="card comment-section mt-5" id="commentSection" style="display: none;">
    <div class="card-header">
      <h4 class="mb-0">
        <i class="fas fa-comments me-2"></i>评论讨论
        <span class="badge bg-primary ms-2" id="commentCount">0</span>
      </h4>
    </div>
    <div class="card-body">
      <!-- 发表评论区域 -->
      <div class="comment-form mb-4">
        <div class="mb-3">
          <label for="commentContent" class="form-label">发表评论</label>
          <div class="comment-input-container">
            <textarea id="commentContent" class="form-control" rows="4" placeholder="分享你的想法、解题思路或遇到的问题..."></textarea>
            <button type="button" class="emoji-trigger" id="emojiTrigger">
              <i class="fas fa-smile"></i>
            </button>
          </div>
          <div class="emoji-picker-container">
            <div class="emoji-picker" id="emojiPicker">
              <div class="emoji-categories">
                <button class="emoji-category active" data-category="smileys">😀</button>
                <button class="emoji-category" data-category="people">👋</button>
                <button class="emoji-category" data-category="animals">🐶</button>
                <button class="emoji-category" data-category="food">🍎</button>
                <button class="emoji-category" data-category="travel">🚗</button>
                <button class="emoji-category" data-category="objects">📱</button>
                <button class="emoji-category" data-category="symbols">❤️</button>
              </div>
              <div class="emoji-grid" id="emojiGrid">
                <!-- Emoji列表将通过JavaScript动态生成 -->
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-primary" id="submitComment">
            <i class="fas fa-paper-plane me-2"></i>发表评论
          </button>
        </div>
      </div>

      <!-- 评论列表 -->
      <div id="commentList" class="comment-list">
        <div class="text-center text-muted py-4">
          <i class="fas fa-comment-slash fa-2x mb-2"></i>
          <p>暂无评论，快来发表第一条评论吧！</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 代码提交区域 -->
  <div class="card code-editor-container mt-5">
    <form id="submitForm">
      <span id="pid" style="display: none;" th:text="${competition_problem.id}"></span>
      <div class="mb-3">
        <label class="form-label">选择编程语言</label>
        <div class="custom-select" id="languageSelect">
          <div class="select-selected">C++17</div>
          <div class="select-items">
            <div class="select-item selected" data-value="cpp">
              <span class="language-option">
                <span class="language-icon"><i class="fab fa-cuttlefish"></i></span>
                <span>C++17</span>
              </span>
            </div>
            <div class="select-item" data-value="python">
              <span class="language-option">
                <span class="language-icon"><i class="fab fa-python"></i></span>
                <span>Python</span>
              </span>
            </div>
            <div class="select-item" data-value="java">
              <span class="language-option">
                <span class="language-icon"><i class="fab fa-java"></i></span>
                <span>Java</span>
              </span>
            </div>
          </div>
        </div>
        <input type="hidden" id="languageSelectHidden" name="language" value="cpp">
      </div>
      <div id="judgeStatus" class="mb-3">
        <div id="statusAlert" class="alert" style="display: none;"></div>
      </div>

      <div class="mb-4">
        <div class="monaco-editor-container">
          <div class="editor-toolbar">
            <div class="language-info" id="languageInfo">C++17</div>
            <div class="editor-actions">
              <button type="button" class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i> 暗色主题
              </button>
              <button type="button" class="theme-toggle" id="formatCode">
                <i class="fas fa-magic"></i> 格式化
              </button>
            </div>
          </div>
          <div id="codeEditor" class="monaco-editor"></div>
        </div>
        <textarea id="codeEditorHidden" name="code" style="display: none;"></textarea>
      </div>

      <div class="d-flex justify-content-end">
        <button type="submit" class="submit-btn">
          <i class="fas fa-paper-plane me-2"></i> 提交代码
        </button>
      </div>
    </form>
  </div>
</div>

<script src="/libs/bootstrap/bootstrap.bundle.min.js"></script>

<!-- Monaco Editor 脚本 -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>

<script>
  // 配置marked.js以符合GitHub风格
  marked.setOptions({
    gfm: true,
    breaks: true,
    pedantic: false,
    smartLists: true,
    smartypants: false,
    highlight: function(code, lang) {
      const validLang = hljs.getLanguage(lang) ? lang : 'plaintext';
      return hljs.highlight(code, { language: validLang }).value;
    },
    extensions: [
      {
        name: 'math',
        level: 'inline',
        start(src) { return src.indexOf('$'); },
        tokenizer(src, tokens) {
          const match = src.match(/^\$+([^$\n]+?)\$+/);
          if (match) {
            return {
              type: 'math',
              raw: match[0],
              text: match[1].trim()
            };
          }
        },
        renderer(token) {
          return `<span class="math">\\(${token.text}\\)</span>`;
        }
      }
    ]
  });

  // 渲染Markdown内容
  function renderMarkdownElements() {
    document.querySelectorAll('.markdown-content').forEach(element => {
      const rawText = element.textContent;
      const parsedMarkdown = marked.parse(rawText);
      const safeHtml = DOMPurify.sanitize(parsedMarkdown, {
        ADD_TAGS: ['iframe'],
        ADD_ATTR: ['allow', 'allowfullscreen', 'frameborder', 'scrolling']
      });
      element.innerHTML = safeHtml;

      // 渲染数学公式
      if (typeof MathJax !== 'undefined') {
        MathJax.typesetPromise();
      }

      // 高亮代码块
      element.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
    });
  }

  // Monaco Editor 相关变量
  let editor = null;
  let currentLanguage = 'cpp';
  let currentTheme = 'vs';

  // 语言配置
  const languageConfig = {
    cpp: {
      language: 'cpp',
      template: `#include <iostream>
#include <set>
using namespace std;

int main() {
    int a, b;
    cin >> a >> b;
    cout << a + b << endl;
    
    return 0;
}`
    },
    python: {
      language: 'python',
      template: `# 请在此处编写你的代码
a, b = map(int, input().split())
print(a + b)`
    },
    java: {
      language: 'java',
      template: `import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);
        int a = scanner.nextInt();
        int b = scanner.nextInt();
        System.out.println(a + b);
    }
}`
    }
  };

  // 初始化 Monaco Editor
  function initMonacoEditor() {
    // 检查 DOM 元素是否存在
    const editorElement = document.getElementById('codeEditor');
    if (!editorElement) {
      console.error('编辑器容器元素未找到');
      return;
    }

    // 配置 Monaco Editor
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      // 注册语言
      monaco.languages.register({ id: 'cpp' });
      monaco.languages.setMonarchTokensProvider('cpp', {
        tokenizer: {
          root: [
            [/[a-zA-Z_$][a-zA-Z0-9_$]*/, 'identifier'],
            [/\d+/, 'number'],
            [/["'].*?["']/, 'string'],
            [/\/\/.*$/, 'comment'],
            [/\/\*[\s\S]*?\*\//, 'comment'],
            [/[{}()\[\]]/, 'delimiter'],
            [/[;,.]/, 'delimiter']
          ]
        }
      });

      monaco.languages.register({ id: 'python' });
      monaco.languages.setMonarchTokensProvider('python', {
        tokenizer: {
          root: [
            [/[a-zA-Z_$][a-zA-Z0-9_$]*/, 'identifier'],
            [/\d+/, 'number'],
            [/["'].*?["']/, 'string'],
            [/#.*$/, 'comment'],
            [/[{}()\[\]]/, 'delimiter'],
            [/[;,.]/, 'delimiter']
          ]
        }
      });

      monaco.languages.register({ id: 'java' });
      monaco.languages.setMonarchTokensProvider('java', {
        tokenizer: {
          root: [
            [/[a-zA-Z_$][a-zA-Z0-9_$]*/, 'identifier'],
            [/\d+/, 'number'],
            [/["'].*?["']/, 'string'],
            [/\/\/.*$/, 'comment'],
            [/\/\*[\s\S]*?\*\//, 'comment'],
            [/[{}()\[\]]/, 'delimiter'],
            [/[;,.]/, 'delimiter']
          ]
        }
      });

      // 创建编辑器
      editor = monaco.editor.create(editorElement, {
        value: languageConfig.cpp.template,
        language: 'cpp',
        theme: currentTheme,
        automaticLayout: true,
        minimap: { enabled: false },
        fontSize: 14,
        lineNumbers: 'on',
        roundedSelection: false,
        scrollBeyondLastLine: false,
        readOnly: false,
        cursorStyle: 'line',
        wordWrap: 'on',
        formatOnPaste: true,
        formatOnType: false,
        insertSpaces: true,
        tabSize: 4,
        detectIndentation: false,
        suggest: {
          showKeywords: true,
          showSnippets: true,
          showFunctions: true
        },
        parameterHints: { enabled: true },
        hover: { enabled: true },
        glyphMargin: true,
        occurrencesHighlight: 'single',
        renderLineHighlight: 'line'
      });

      // 监听内容变化
      editor.onDidChangeModelContent(() => {
        const value = editor.getValue();
        document.getElementById('codeEditorHidden').value = value;
      });

      console.log('Monaco Editor 初始化成功');
    });
  }

  // 切换语言
  function switchLanguage(language) {
    if (!editor) return;

    currentLanguage = language;
    const config = languageConfig[language];
    if (config) {
      monaco.editor.setModelLanguage(editor.getModel(), config.language);
      editor.setValue(config.template);
      document.getElementById('languageInfo').textContent = 
        language === 'cpp' ? 'C++17' : 
        language === 'python' ? 'Python' : 'Java';
    }
  }

  // 主题切换
  function toggleTheme() {
    if (!editor) {
      console.log('Editor not initialized yet');
      return;
    }

    currentTheme = currentTheme === 'vs' ? 'vs-dark' : 'vs';
    monaco.editor.setTheme(currentTheme);

    const themeToggle = document.getElementById('themeToggle');
    const icon = themeToggle.querySelector('i');

    if (currentTheme === 'vs-dark') {
      icon.className = 'fas fa-sun';
      themeToggle.innerHTML = '<i class="fas fa-sun"></i> 亮色主题';
    } else {
      icon.className = 'fas fa-moon';
      themeToggle.innerHTML = '<i class="fas fa-moon"></i> 暗色主题';
    }
  }

  // 代码格式化功能
  function formatCode() {
    if (!editor) return;

    try {
      const model = editor.getModel();
      if (model) {
        const value = model.getValue();
        const formatted = formatCppCode(value);
        editor.setValue(formatted);
        showToast('代码已格式化', 'success', 2000);
      }
    } catch (error) {
      console.error('格式化失败:', error);
      showToast('格式化失败，请手动调整代码', 'error', 3000);
    }
  }

  // 简单的 C++ 代码格式化函数
  function formatCppCode(code) {
    let lines = code.split('\n');
    let formatted = [];
    let indentLevel = 0;
    const indent = '    ';

    for (let i = 0; i < lines.length; i++) {
      let line = lines[i].trim();

      if (!line) {
        formatted.push('');
        continue;
      }

      if (line.startsWith('#include') || line.startsWith('using namespace')) {
        formatted.push(line);
        continue;
      }

      if (line.startsWith('}')) {
        indentLevel = Math.max(0, indentLevel - 1);
      }

      formatted.push(indent.repeat(indentLevel) + line);

      if (line.endsWith('{')) {
        indentLevel++;
      }
    }

    return formatted.join('\n');
  }

  // 初始化自定义选择框
  function initCustomSelect() {
    const customSelect = document.getElementById('languageSelect');
    const selected = customSelect.querySelector('.select-selected');
    const itemsContainer = customSelect.querySelector('.select-items');
    const items = customSelect.querySelectorAll('.select-item');

    selected.addEventListener('click', function(e) {
      e.stopPropagation();
      closeAllSelect(this);
      itemsContainer.classList.toggle('active');
      this.classList.toggle('select-arrow-active');
      
      if (itemsContainer.classList.contains('active')) {
        itemsContainer.style.display = 'block';
      }
    });

    items.forEach(item => {
      item.addEventListener('click', function(e) {
        e.stopPropagation();
        
        items.forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');
        
        const text = this.querySelector('span:last-child').textContent;
        selected.textContent = text;
        
        const value = this.getAttribute('data-value');
        document.getElementById('languageSelectHidden').value = value;
        
        switchLanguage(value);
        
        itemsContainer.classList.remove('active');
        itemsContainer.style.display = 'none';
        selected.classList.remove('select-arrow-active');
      });
    });
  }

  // 关闭所有选择框
  function closeAllSelect(elmnt) {
    const selectItems = document.querySelectorAll('.select-items');
    const selectSelected = document.querySelectorAll('.select-selected');

    selectItems.forEach(item => {
      if (elmnt && item !== elmnt.nextElementSibling && elmnt !== item) {
        item.classList.remove('active');
        item.style.display = 'none';
      }
    });

    selectSelected.forEach(selected => {
      if (elmnt && selected !== elmnt) {
        selected.classList.remove('select-arrow-active');
      }
    });
  }

  // 点击页面其他地方关闭选择框
  document.addEventListener('click', function(e) {
    closeAllSelect(e.target);
  });

  // 评论功能相关代码
  let currentProblemId = null;
  let currentUserId = null;
  let currentUsername = null;
  let currentReceiveUserId = null; // 当前回复的目标用户ID

  // 初始化评论功能
  function initCommentSystem() {
    currentProblemId = document.getElementById('pid').textContent;
    currentUserId = localStorage.getItem('id');
    currentUsername = localStorage.getItem('name');
    
    if (!currentUserId || !currentUsername) {
      showToast('请先登录后再发表评论', 'error');
      return;
    }

    // 加载评论列表
    loadComments();
    
    // 绑定事件
    bindCommentEvents();
    
    // 初始化emoji选择器
    initEmojiPicker();
  }

  // 绑定评论相关事件
  function bindCommentEvents() {
    // 发表评论
    document.getElementById('submitComment').addEventListener('click', submitComment);
    
    // 使用事件委托处理回复和删除按钮
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('reply') || e.target.closest('.reply')) {
        e.preventDefault();
        const replyBtn = e.target.classList.contains('reply') ? e.target : e.target.closest('.reply');
        const commentId = replyBtn.dataset.commentId;
        currentReceiveUserId = replyBtn.dataset.receiveUserId; // 保存被回复用户的ID
        showReplyForm(commentId);
      } else if (e.target.classList.contains('delete') || e.target.closest('.delete')) {
        e.preventDefault();
        const deleteBtn = e.target.classList.contains('delete') ? e.target : e.target.closest('.delete');
        const commentId = deleteBtn.dataset.commentId;
        deleteComment(commentId);
      } else if (e.target.classList.contains('submit-reply')) {
        e.preventDefault();
        const commentId = e.target.dataset.commentId;
        submitReply(commentId);
      } else if (e.target.classList.contains('cancel-reply')) {
        e.preventDefault();
        const commentId = e.target.dataset.commentId;
        hideReplyForm(commentId);
      }
    });
  }

  // 加载评论列表
  async function loadComments() {
    try {
      const response = await fetch(`/comment/list?pid=${currentProblemId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();
      if (data.code === 200) {
        renderComments(data.data);
        updateCommentCount(data.data.length);
      } else {
        showToast('加载评论失败', 'error');
      }
    } catch (error) {
      console.error('加载评论失败:', error);
      showToast('网络连接异常，请检查网络后重试', 'error');
    }
  }

  // 渲染评论列表
  function renderComments(comments) {
    const commentList = document.getElementById('commentList');
    
    if (!comments || comments.length === 0) {
      commentList.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="fas fa-comment-slash fa-2x mb-2"></i>
          <p>暂无评论，快来发表第一条评论吧！</p>
        </div>
      `;
      return;
    }

    commentList.innerHTML = comments.map(comment => renderCommentItem(comment)).join('');
  }

  // 渲染单个评论项（顶级评论）
  function renderCommentItem(comment) {
    const isOwner = comment.userId == currentUserId;
    const avatarText = comment.username ? comment.username.charAt(0).toUpperCase() : 'U';
    
    // 渲染子评论
    let subcommentsHtml = '';
    if (comment.subcommentList && comment.subcommentList.length > 0) {
      subcommentsHtml = `
        <div class="subcomment-list">
          ${comment.subcommentList.map(subcomment => renderSubcommentItem(subcomment)).join('')}
        </div>
      `;
    }

    return `
      <div class="comment-item" data-comment-id="${comment.id}">
        <div class="comment-header">
          <div class="comment-author">
            <div class="avatar">${avatarText}</div>
            <span class="name">${comment.username || '匿名用户'}</span>
          </div>
          <div class="comment-time">${formatCommentTime(comment.createTime)}</div>
        </div>
        <div class="comment-content">${escapeHtml(comment.content)}</div>
        <div class="comment-actions">
          <button class="comment-action reply" data-comment-id="${comment.id}" data-receive-user-id="${comment.userId}">
            <i class="fas fa-reply me-1"></i>回复
          </button>
          ${isOwner ? `
            <button class="comment-action delete" data-comment-id="${comment.id}">
              <i class="fas fa-trash me-1"></i>删除
            </button>
          ` : ''}
        </div>
        <div class="reply-form" id="reply-form-${comment.id}">
          <textarea placeholder="回复 ${comment.username || '匿名用户'}..." rows="3"></textarea>
          <div class="reply-actions">
            <button class="reply-btn secondary cancel-reply" data-comment-id="${comment.id}">取消</button>
            <button class="reply-btn primary submit-reply" data-comment-id="${comment.id}">回复</button>
          </div>
        </div>
        ${subcommentsHtml}
      </div>
    `;
  }

  // 渲染子评论项
  function renderSubcommentItem(subcomment) {
    const isOwner = subcomment.userId == currentUserId;
    const avatarText = subcomment.username ? subcomment.username.charAt(0).toUpperCase() : 'U';
    const replyText = subcomment.receiveUserId && subcomment.receiveUsername ? 
      `回复 <span class="reply-target">@${subcomment.receiveUsername}</span>` : '';

    return `
      <div class="subcomment-item" data-comment-id="${subcomment.id}">
        <div class="comment-header">
          <div class="comment-author">
            <div class="avatar">${avatarText}</div>
            <span class="name">${subcomment.username || '匿名用户'}</span>
            ${replyText ? `<span class="reply-text">${replyText}</span>` : ''}
          </div>
          <div class="comment-time">${formatCommentTime(subcomment.createTime)}</div>
        </div>
        <div class="comment-content">${escapeHtml(subcomment.content)}</div>
        <div class="comment-actions">
          <button class="comment-action reply" data-comment-id="${subcomment.id}" data-receive-user-id="${subcomment.userId}">
            <i class="fas fa-reply me-1"></i>回复
          </button>
          ${isOwner ? `
            <button class="comment-action delete" data-comment-id="${subcomment.id}">
              <i class="fas fa-trash me-1"></i>删除
            </button>
          ` : ''}
        </div>
        <div class="reply-form" id="reply-form-${subcomment.id}">
          <textarea placeholder="回复 ${subcomment.username || '匿名用户'}..." rows="3"></textarea>
          <div class="reply-actions">
            <button class="reply-btn secondary cancel-reply" data-comment-id="${subcomment.id}">取消</button>
            <button class="reply-btn primary submit-reply" data-comment-id="${subcomment.id}">回复</button>
          </div>
        </div>
      </div>
    `;
  }

  // 发表评论
  async function submitComment() {
    const content = document.getElementById('commentContent').value.trim();
    
    if (!content) {
      showToast('请输入评论内容', 'error');
      return;
    }

    if (!currentUserId || !currentUsername) {
      showToast('请先登录后再发表评论', 'error');
      return;
    }

    try {
      const response = await fetch('/comment/publish', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          problemId: parseInt(currentProblemId),
          parentId: null,
          receiveUserId: null, // 顶级评论没有回复特定用户
          username: currentUsername,
          content: content,
          createTime: new Date().toISOString()
        })
      });

      const data = await response.json();
      if (data.code === 200) {
        showToast('评论发表成功', 'success');
        document.getElementById('commentContent').value = '';
        loadComments(); // 重新加载评论列表
      } else {
        showToast(data.msg || '评论发表失败', 'error');
      }
    } catch (error) {
      console.error('发表评论失败:', error);
      showToast('网络连接异常，请检查网络后重试', 'error');
    }
  }

  // 显示回复表单
  function showReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    if (replyForm) {
      replyForm.classList.add('show');
      replyForm.querySelector('textarea').focus();
    }
  }

  // 隐藏回复表单
  function hideReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    if (replyForm) {
      replyForm.classList.remove('show');
      replyForm.querySelector('textarea').value = '';
    }
  }

  // 提交回复
  async function submitReply(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    const content = replyForm.querySelector('textarea').value.trim();
    
    if (!content) {
      showToast('请输入回复内容', 'error');
      return;
    }

    try {
      const response = await fetch('/comment/publish', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          problemId: parseInt(currentProblemId),
          parentId: parseInt(commentId),
          receiveUserId: currentReceiveUserId ? parseInt(currentReceiveUserId) : null,
          username: currentUsername,
          content: content,
          createTime: new Date().toISOString()
        })
      });

      const data = await response.json();
      if (data.code === 200) {
        showToast('回复发表成功', 'success');
        hideReplyForm(commentId);
        loadComments(); // 重新加载评论列表
      } else {
        showToast(data.msg || '回复发表失败', 'error');
      }
    } catch (error) {
      console.error('发表回复失败:', error);
      showToast('网络连接异常，请检查网络后重试', 'error');
    }
  }

  // 删除评论
  async function deleteComment(commentId) {
    if (!confirm('确定要删除这条评论吗？')) {
      return;
    }

    try {
      const response = await fetch(`/comment/delete/${commentId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();
      if (data.code === 200) {
        showToast('评论删除成功', 'success');
        loadComments(); // 重新加载评论列表
      } else {
        showToast(data.msg || '评论删除失败', 'error');
      }
    } catch (error) {
      console.error('删除评论失败:', error);
      showToast('网络连接异常，请检查网络后重试', 'error');
    }
  }

  // 更新评论数量
  function updateCommentCount(count) {
    const commentCountElement = document.getElementById('commentCount');
    if (commentCountElement) {
      commentCountElement.textContent = count;
    }
  }

  // 格式化评论时间
  function formatCommentTime(timeString) {
    const time = new Date(timeString);
    const now = new Date();
    const diff = now - time;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) {
      return '刚刚';
    } else if (minutes < 60) {
      return `${minutes}分钟前`;
    } else if (hours < 24) {
      return `${hours}小时前`;
    } else if (days < 7) {
      return `${days}天前`;
    } else {
      return time.toLocaleDateString();
    }
  }

  // HTML转义函数
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // 初始化Emoji选择器
  function initEmojiPicker() {
    const emojiTrigger = document.getElementById('emojiTrigger');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');
    const commentContent = document.getElementById('commentContent');

    if (!emojiTrigger || !emojiPicker || !emojiGrid || !commentContent) return;

    // Emoji数据
    const emojis = {
      smileys: ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩', '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣', '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗', '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😬', '🙄', '😯', '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐', '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠', '😈', '👿', '👹', '👺', '🤡', '💩', '👻', '💀', '☠️', '👽', '👾', '🤖', '🎃', '😺', '😸', '😹', '😻', '😼', '😽', '🙀', '😿', '😾'],
      people: ['👋', '🤚', '🖐', '✋', '🖖', '👌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎', '👊', '✊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍️', '💅', '🤳', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠', '🦷', '🦴', '👀', '👁', '👅', '👄', '💋', '🩸'],
      animals: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐽', '🐸', '🐵', '🙈', '🙉', '🙊', '🐒', '🦍', '🦧', '🐕', '🐩', '🦮', '🐕‍🦺', '🐈', '🐓', '🦃', '🦚', '🦜', '🦢', '🦩', '🕊', '🐇', '🦝', '🦨', '🦡', '🦦', '🦥', '🐁', '🐀', '🐿', '🦔', '🐾', '🐉', '🐲', '🌵', '🎄', '🌲', '🌳', '🌴', '🌱', '🌿', '☘️', '🍀', '🎍', '🎋', '🍃', '🍂', '🍁', '🍄', '🐚', '🌾', '💐', '🌷', '🌹', '🥀', '🌺', '🌸', '🌼', '🌻', '🌞', '🌝', '🌛', '🌜', '🌚', '🌕', '🌖', '🌗', '🌘', '🌑', '🌒', '🌓', '🌔', '🌙', '⭐', '🌟', '💫', '✨', '☄️', '☀️', '🌤', '⛅', '🌥', '☁️', '🌦', '🌧', '⛈', '🌩', '🌨', '❄️', '☃️', '⛄', '🌬', '💨', '💧', '💦', '☔', '☂️', '🌊', '🌫'],
      food: ['🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶', '🫑', '🌽', '🥕', '🫒', '🧄', '🧅', '🥔', '🍠', '🥐', '🥖', '🍞', '🥨', '🥯', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭', '🍔', '🍟', '🍕', '🫓', '🥙', '🥘', '🌮', '🌯', '🫔', '🥗', '🥫', '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🦪', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯'],
      travel: ['🚗', '🚕', '🚙', '🚌', '🚎', '🏎', '🚓', '🚑', '🚒', '🚐', '🛻', '🚚', '🚛', '🚜', '🏍', '🛵', '🚲', '🛴', '🛹', '🛼', '🛺', '🚁', '✈️', '🛩', '🛫', '🛬', '🪂', '💺', '🚀', '🛸', '🚉', '🚞', '🚝', '🚄', '🚅', '🚈', '🚂', '🚆', '🚇', '🚊', '🚍', '🚘', '🚖', '🚡', '🚠', '🚟', '🎢', '🎡', '🎠', '⛵', '🛥', '🚤', '⛴', '🛳', '⛽', '🚧', '🚨', '🚥', '🚦', '🛑', '🚏', '💈', '♨️', '🎯', '🎪', '🎭', '🩰', '🎨', '🎬', '🎤', '🎧', '🎼', '🎵', '🎶', '🎹', '🥁', '🎷', '🎺', '🎸', '🪕', '🎻', '🎲', '♠️', '♥️', '♦️', '♣️', '♟', '🃏', '🀄', '🎴', '🎮', '🕹', '🎰', '🧩', '🎯', '🎳', '🎮', '🕹', '🎰', '🧩', '🎯', '🎳'],
      objects: ['📱', '📲', '☎️', '📞', '📟', '📠', '🔋', '🔌', '💻', '🖥', '🖨', '⌨️', '🖱', '🖲', '💽', '💾', '💿', '📀', '🧮', '🎥', '📷', '📸', '📹', '📼', '🔍', '🔎', '🕯', '💡', '🔦', '🏮', '🪔', '📔', '📕', '📖', '📗', '📘', '📙', '📚', '📓', '📒', '📃', '📜', '📄', '📰', '🗞', '📑', '🔖', '🏷', '💰', '💴', '💵', '💶', '💷', '💸', '💳', '💎', '⚖️', '🧰', '🔧', '🔨', '⚒', '🛠', '⛏', '🔩', '⚙️', '🧱', '⛓', '🧲', '🔫', '💣', '🧨', '🪓', '🔪', '🗡', '⚔️', '🛡', '🚬', '⚰️', '🪦', '⚱️', '🏺', '🔮', '📿', '🧿', '💈', '⚗️', '🔭', '🔬', '🕳', '🩹', '🩺', '💊', '💉', '🧬', '🦠', '🧫', '🧪', '🌡', '🧹', '🧺', '🧻', '🚽', '🚰', '🚿', '🛁', '🛀', '🧼', '🪒', '🧽', '🧴', '🛎', '🔑', '🗝', '🚪', '🪑', '🛏', '🛋', '🪞', '🪟', '🛍', '🛒', '🎁', '🎈', '🎉', '🎊', '🎀', '🎂', '🍰', '🧁', '🥧', '🍭', '🍬', '🍫', '🍩', '🍪', '🍯', '🍯', '🍯'],
      symbols: ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '☮️', '✝️', '☪️', '🕉', '☸️', '✡️', '🔯', '🕎', '☯️', '☦️', '🛐', '⛎', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓', '🆔', '⚛️', '🉑', '☢️', '☣️', '📴', '📳', '🈶', '🈚', '🈸', '🈺', '🈷️', '✴️', '🆚', '💮', '🉐', '㊙️', '㊗️', '🈴', '🈵', '🈹', '🈲', '🅰️', '🅱️', '🆎', '🆑', '🅾️', '🆘', '❌', '⭕', '🛑', '⛔', '📛', '🚫', '💯', '💢', '♨️', '🚷', '🚯', '🚳', '🚱', '🔞', '📵', '🚭', '❗', '❕', '❓', '❔', '‼️', '⁉️', '🔅', '🔆', '〽️', '⚠️', '🚸', '🔱', '⚜️', '🔰', '♻️', '✅', '🈯', '💹', '❇️', '✳️', '❎', '🌐', '💠', 'Ⓜ️', '🌀', '💤', '🏧', '🚾', '♿', '🅿️', '🈳', '🈂️', '🛂', '🛃', '🛄', '🛅', '🚹', '🚺', '🚼', '🚻', '🚮', '🎦', '📶', '🈁', '🔣', '🔤', '🔡', '🔠', '🆖', '🆗', '🆙', '🆒', '🆕', '🆓', '0️⃣', '1️⃣', '2️⃣', '3️⃣', '4️⃣', '5️⃣', '6️⃣', '7️⃣', '8️⃣', '9️⃣', '🔟']
    };

    // 生成Emoji网格
    function generateEmojiGrid(category) {
      emojiGrid.innerHTML = '';
      emojis[category].forEach(emoji => {
        const emojiBtn = document.createElement('button');
        emojiBtn.className = 'emoji-item';
        emojiBtn.textContent = emoji;
        emojiBtn.addEventListener('click', () => {
          commentContent.value += emoji;
          commentContent.focus();
        });
        emojiGrid.appendChild(emojiBtn);
      });
    }

    // 切换Emoji分类
    const categoryBtns = document.querySelectorAll('.emoji-category');
    categoryBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        categoryBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        generateEmojiGrid(btn.dataset.category);
      });
    });

    // 显示/隐藏Emoji选择器
    emojiTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      emojiPicker.classList.toggle('show');
    });

    // 点击外部关闭Emoji选择器
    document.addEventListener('click', (e) => {
      if (!emojiPicker.contains(e.target) && !emojiTrigger.contains(e.target)) {
        emojiPicker.classList.remove('show');
      }
    });

    // 初始化显示第一个分类
    generateEmojiGrid('smileys');
  }

  // 检查比赛状态并显示/隐藏评论区域
  async function checkCompetitionStatusAndShowComments() {
    try {
      const currentDate = new Date();
      const now = formatTime(currentDate);
      const id = cid;
      
      const response = await fetch('/competition/judgeIsEnd', {
        method: 'POST',
        body: JSON.stringify({now, id}),
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();
      const competitionNotice = document.getElementById('competitionNotice');
      const commentSection = document.getElementById('commentSection');
      
      if (data.code === 200) {
        // 比赛已结束，显示评论区域，隐藏比赛提示
        if (competitionNotice) {
          competitionNotice.style.display = 'none';
        }
        if (commentSection) {
          commentSection.style.display = 'block';
          // 初始化评论系统
          initCommentSystem();
        }
      } else {
        // 比赛未结束，显示比赛提示，隐藏评论区域
        if (competitionNotice) {
          competitionNotice.style.display = 'block';
        }
        if (commentSection) {
          commentSection.style.display = 'none';
        }
      }
    } catch (error) {
      console.error('检查比赛状态失败:', error);
      // 出错时默认显示比赛提示，隐藏评论区域
      const competitionNotice = document.getElementById('competitionNotice');
      const commentSection = document.getElementById('commentSection');
      
      if (competitionNotice) {
        competitionNotice.style.display = 'block';
      }
      if (commentSection) {
        commentSection.style.display = 'none';
      }
    }
  }

  // 获取题目标签
  async function fetchProblemTags(problemId, token) {
    return [];
  }

  // 辅助函数
  function saveDraft() {
    localStorage.setItem('codeDraft', editor.getValue());
    showToast('代码草稿已自动保存', 'info', 2000);
  }

  // 显示美化的提示框
  function showToast(message, type = 'info', duration = 3000) {
    // 移除已存在的toast
    const existingToast = document.querySelector('.status-toast');
    if (existingToast) {
      existingToast.remove();
    }

    // 创建新的toast
    const toast = document.createElement('div');
    toast.className = `status-toast status-${type}`;

    // 根据类型添加不同的图标
    let icon = '';
    if (type === 'success') {
      icon = '<i class="fas fa-check-circle"></i>';
    } else if (type === 'error') {
      icon = '<i class="fas fa-times-circle"></i>';
    } else {
      icon = '<i class="fas fa-info-circle"></i>';
    }

    toast.innerHTML = `${icon}<span>${message}</span>`;
    document.body.appendChild(toast);

    // 显示动画
    setTimeout(() => {
      toast.classList.add('show');
    }, 10);

    // 自动消失
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  function f(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
  }

  let cid = null;

  // 页面加载初始化
  window.addEventListener('DOMContentLoaded', async () => {
    if (!localStorage.getItem('token')) {
      showToast('请先登录！', 'error');
      setTimeout(() => {
        window.location.href = '/index.html';
      }, 1500);
      return;
    }

    const pathname = window.location.pathname;
    // 使用正则表达式匹配 cid
    const regex = /\/competition\/problem\/(\d+)\/\d+/;
    const match = pathname.match(regex);
    if (match) {
      cid = match[1];
    } else {
      console.log('未匹配到有效的 cid');
    }
    let ok;
    try {
      const currentDate = new Date();
      const now = f(currentDate);
      const id=cid;
      const response = await fetch('/competition/judgeIsOpen', {
        method: 'POST',
        body: JSON.stringify({now, id}),
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'  // 明确指定JSON格式
        }
      });
      const data = await response.json();
      ok=data.data;
      if (data.code !== 200 && data.msg !== "") {
        showToast(data.msg || '竞赛未开放', 'error');
        setTimeout(() => window.location.href = `/competition.html`, 1500);
        return;
      }
    } catch (error) {
      console.log(error);
      showToast('检查竞赛状态失败，请重试', 'error');
      return;
    }
    if (ok){
      const key = "competition-" + cid + "-" + localStorage.getItem('name');
      const before = localStorage.getItem(key);
      const now = Math.floor(Date.now() / 1000);

      if (before === null || now - parseInt(before) >= 86400 ) {
        showToast('无权限查看', 'error');
        setTimeout(() => {
          window.location.href = `/competition.html`;
        }, 1500);
      }
    }
    document.querySelector('.problem-container').classList.remove('hidden');

    // 初始化 Monaco Editor
    initMonacoEditor();
    
    // 初始化自定义选择框
    initCustomSelect();

    // 绑定事件监听器（立即绑定，不等待 Monaco Editor）
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('formatCode').addEventListener('click', formatCode);

    // 等待 Monaco Editor 加载完成
    setTimeout(() => {
      // 初始设置为C++17
      switchLanguage('cpp');
      
      // 检查比赛状态并显示/隐藏评论区域
      checkCompetitionStatusAndShowComments();
    }, 2000);

    if (typeof DOMPurify !== 'undefined') {
      renderMarkdownElements();
    }

    // 加载标签
    const problemId = document.getElementById('pid').textContent;
    const token = localStorage.getItem('token');
    const tagsContainer = document.getElementById('tagsContainer');

    if (problemId) {
      const tags = await fetchProblemTags(problemId, token);
      if (tags.length > 0) {
        tags.forEach(tag => {
          const tagElement = document.createElement('span');
          tagElement.className = 'tag';
          tagElement.textContent = tag.name || tag;
          tagsContainer.appendChild(tagElement);
        });
      } else {
        const noTags = document.createElement('span');
        noTags.className = 'text-muted';
        noTags.style.fontSize = '0.9rem';
        noTags.textContent = '无标签';
        tagsContainer.appendChild(noTags);
      }
    }
  });

  async function checkCompetitionEnd(cid, token) {
    try {
      const currentDate = new Date();
      const now = f(currentDate);
      const id=cid;
      const response = await fetch('/competition/judgeIsEnd', {
        method: 'POST',
        body: JSON.stringify({now, id}),
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'  // 明确指定JSON格式
        }
      });

      const data = await response.json();
      if (data.code !== 200 && data.msg !== "") {
        showToast(data.msg || '竞赛已结束', 'error');
        return false; // 竞赛已结束
      }
      return true; // 竞赛未结束
    } catch (error) {
      console.error('检查竞赛结束状态失败:', error);
      showToast('检查竞赛状态失败，请重试', 'error');
      return false;
    }
  }
  function formatTime(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
  }

  // 表单提交处理
  document.getElementById('submitForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const isCompetitionOpen = await checkCompetitionEnd(cid, localStorage.getItem('token'));
    if (!isCompetitionOpen) {
      return; // 阻止后续提交流程
    }

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const option = document.getElementById('languageSelectHidden').value;

    if (option === "java") {
      showToast("暂不支持用Java提交，请等待", 'error');
      return;
    }

    // 显示提交中的提示
    showToast('评测中，请稍候...', 'info', 10000);

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>提交中...';

    // 提取时间和内存限制
    const timeText = document.getElementById('time').textContent;
    const timeValue = timeText.split('：')[1].split(' ')[0];

    const memoryText = document.getElementById('memory').textContent;
    const memoryValue = memoryText.split('：')[1].split(' ')[0];

    try {
      const currentDate = new Date();
      const code = editor ? editor.getValue() : document.getElementById('codeEditorHidden').value;
      const pid = document.getElementById('pid').textContent;
      const uname = localStorage.getItem('name');
      const create_time = formatTime(currentDate);
      const time = timeValue;
      const memory = memoryValue;

      const response = await fetch('/judge/submit', {
        method: 'POST',
        body: JSON.stringify({ code, option, pid, uname, cid, create_time, time, memory }),
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      // 显示结果提示
      // 显示结果提示
      if (data.code === 200) {
        if(data.msg==="答案正确"){
          showToast(`${data.msg}！`, 'success', 5000);
        }
        else{
          showToast(`${data.msg}！`, 'error', 5000);
        }
      } else {
        showToast(`${data.msg}！`, 'error', 5000);
      }

    } catch (error) {
      showToast('网络连接异常，请检查网络后重试', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i> 提交代码';
    }
  });
</script>
</body>
</html>