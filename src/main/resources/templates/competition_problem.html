<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${competition_problem.id} + ' - ' + ${competition_problem.title}"></title>

  <!-- æ ¸å¿ƒæ ·å¼åº“ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Markdown ç›¸å…³èµ„æº -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.1/purify.min.js"></script>

  <!-- Monaco Editor æ ·å¼ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/editor/editor.main.css">

  <style>
    :root {
      --primary: #1a73e8;
      --secondary: #2f855a;
      --primary-color: #1a73e8;
      --secondary-color: #2f855a;
      --text: #2d3748;
      --neutral-dark: #2d3748;
      --neutral-medium: #4a5568;
      --neutral-light: #e2e8f0;
      --success: #2ea44f;
      --danger: #d73a49;
      --info: #0366d6;
      --bg-light: #f6f8fa;
      --border-radius: 6px;
      --border-color: #e1e4e8;
    }
    .hidden {
      display: none !important;
    }
    body {
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      line-height: 1.5;
      color: #24292e;
    }

    .problem-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .card {
      border-radius: var(--border-radius);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .card-header {
      background-color: var(--bg-light);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 16px;
    }

    .problem-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 30px;
    }

    .problem-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 2rem;
      color: var(--primary);
      font-weight: 600;
    }

    .problem-meta {
      display: flex;
      gap: 20px;
      font-size: 0.95rem;
      color: #586069;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .meta-item i {
      color: var(--primary);
      font-size: 1em;
    }

    .code-preview {
      background: var(--bg-light);
      border-radius: var(--border-radius);
      padding: 16px;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      line-height: 1.45;
      white-space: pre;
      overflow-x: auto;
      font-size: 85%;
      border: 1px solid var(--border-color);
    }

    .code-editor-container {
      background: white;
      border-radius: var(--border-radius);
      margin-top: 30px;
      padding: 20px;
      border: 1px solid var(--border-color);
    }

    /* Monaco Editor å®¹å™¨æ ·å¼ */
    .monaco-editor-container {
      position: relative;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      overflow: hidden;
      background: white;
    }

    .editor-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-bottom: 1px solid var(--border-color);
      font-size: 12px;
    }

    .editor-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .theme-toggle {
      background: transparent;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: #e9ecef;
    }

    .language-info {
      font-size: 12px;
      color: #6c757d;
      background: #e9ecef;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 500;
    }

    /* ç¾åŒ–åçš„ä¸‹æ‹‰æ¡†æ ·å¼ */
    .custom-select {
      position: relative;
      min-width: 180px;
      z-index: 1000;
    }

    .select-selected {
      background: linear-gradient(135deg, #e0f2fe, #bbdefb);
      color: var(--primary);
      padding: 0.75rem 1rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.1);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 2px solid transparent;
    }

    .select-selected:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
      border-color: rgba(26, 115, 232, 0.3);
    }

    .select-selected:after {
      content: "\f078";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      font-size: 0.8rem;
      transition: transform 0.3s ease;
    }

    .select-selected.select-arrow-active:after {
      transform: rotate(180deg);
    }

    .select-items {
      position: absolute;
      background-color: white;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 9999;
      border-radius: 12px;
      margin-top: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      max-height: 300px;
      overflow-y: auto;
      display: none;
      transform: translateY(-10px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(26, 115, 232, 0.1);
    }

    .select-items.active {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
      display: block;
    }

    .select-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .select-item:last-child {
      border-bottom: none;
    }

    .select-item:hover {
      background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
      color: var(--primary);
      transform: translateX(4px);
    }

    .select-item.selected {
      background: linear-gradient(135deg, #e0f2fe, #bbdefb);
      color: var(--primary);
      font-weight: 600;
    }

    .language-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .language-icon {
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
    }

    /* æ¯”èµ›æœŸé—´ä¸æ”¯æŒè¯„è®ºçš„æç¤ºæ ·å¼ */
    .competition-notice {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
    }

    .competition-notice i {
      color: #856404;
      font-size: 1.2rem;
    }

    .competition-notice .notice-text {
      color: #856404;
      font-weight: 500;
      margin: 0;
    }

    /* è¯„è®ºåŒºåŸŸæ ·å¼ */
    .comment-section {
      border: none;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
    }

    .comment-section .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px 12px 0 0;
      border: none;
    }

    .comment-section .card-header h4 {
      font-weight: 600;
    }

    .comment-form textarea {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      transition: all 0.3s ease;
      resize: vertical;
      min-height: 100px;
    }

    .comment-form textarea:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      outline: none;
    }

    /* Emojié€‰æ‹©å™¨æ ·å¼ */
    .comment-input-container {
      position: relative;
    }

    .emoji-picker-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .emoji-trigger {
      position: absolute;
      right: 15px;
      top: 15px;
      background: none;
      border: none;
      color: #6b7280;
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.2s;
    }

    .emoji-trigger:hover {
      color: #667eea;
    }

    .emoji-picker {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
      max-height: 300px;
      overflow: hidden;
    }

    .emoji-picker.show {
      display: block;
    }

    .emoji-categories {
      display: flex;
      padding: 10px;
      border-bottom: 1px solid #e2e8f0;
      gap: 5px;
      overflow-x: auto;
    }

    .emoji-category {
      background: none;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background-color 0.2s;
    }

    .emoji-category:hover {
      background: #f3f4f6;
    }

    .emoji-category.active {
      background: #667eea;
      color: white;
    }

    .emoji-grid {
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 5px;
    }

    .emoji-item {
      background: none;
      border: none;
      padding: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background-color 0.2s;
    }

    .emoji-item:hover {
      background: #f3f4f6;
    }

    .comment-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .comment-item {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      background: #f8fafc;
      transition: all 0.3s ease;
    }

    .comment-item:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .comment-author {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .name {
      font-weight: 600;
      color: #374151;
    }

    .comment-time {
      color: #6b7280;
      font-size: 0.875rem;
    }

    .comment-content {
      color: #374151;
      line-height: 1.6;
      margin-bottom: 1rem;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .comment-actions {
      display: flex;
      gap: 1rem;
    }

    .comment-action {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: all 0.2s;
      font-size: 0.875rem;
    }

    .comment-action:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .comment-action.reply:hover {
      color: #667eea;
    }

    .comment-action.delete:hover {
      color: #ef4444;
    }

    .reply-form {
      margin-top: 1rem;
      padding: 1rem;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      display: none;
    }

    .reply-form.show {
      display: block;
    }

    .reply-form textarea {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 0.75rem;
      resize: vertical;
      min-height: 80px;
      margin-bottom: 1rem;
    }

    .reply-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .reply-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .reply-btn.secondary {
      background: #f3f4f6;
      color: #6b7280;
    }

    .reply-btn.secondary:hover {
      background: #e5e7eb;
    }

    .reply-btn.primary {
      background: #667eea;
      color: white;
    }

    .reply-btn.primary:hover {
      background: #5a67d8;
    }

    /* å­è¯„è®ºæ ·å¼ */
    .subcomment-list {
      margin-top: 1rem;
      padding-left: 2rem;
      border-left: 2px solid #e2e8f0;
    }

    .subcomment-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }

    .subcomment-item:last-child {
      margin-bottom: 0;
    }

    /* ç©ºçŠ¶æ€æ ·å¼ */
    .comment-list .text-center {
      padding: 3rem 1rem;
    }

    .comment-list .text-center i {
      color: #cbd5e0;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .comment-item {
        padding: 1rem;
      }

      .comment-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .subcomment-list {
        padding-left: 1rem;
      }

      .comment-actions {
        flex-wrap: wrap;
      }
    }

    #codeEditor {
      height: 500px;
      width: 100%;
    }

    .submit-btn {
      background: var(--success);
      color: white;
      padding: 8px 24px;
      border-radius: var(--border-radius);
      font-weight: 600;
      transition: all 0.2s;
      border: none;
    }

    .submit-btn:hover {
      background: #2c974b;
      transform: translateY(-1px);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    /* GitHubé£æ ¼çš„Markdownæ ·å¼ */
    .markdown-content {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      line-height: 1.6;
      word-wrap: break-word;
      padding: 16px;
    }

    .markdown-content h1,
    .markdown-content h2 {
      padding-bottom: 0.3em;
      border-bottom: 1px solid var(--border-color);
      margin-top: 24px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .markdown-content h1 {
      font-size: 2em;
    }

    .markdown-content h2 {
      font-size: 1.5em;
    }

    .markdown-content h3 {
      font-size: 1.25em;
      font-weight: 600;
      margin-top: 24px;
      margin-bottom: 16px;
    }

    .markdown-content pre {
      background: var(--bg-light);
      padding: 16px;
      border-radius: var(--border-radius);
      overflow: auto;
      margin: 16px 0;
      border: 1px solid var(--border-color);
      line-height: 1.45;
    }

    .markdown-content code {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      background: rgba(27,31,35,0.05);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-size: 85%;
    }

    .markdown-content pre code {
      background: transparent;
      padding: 0;
      border-radius: 0;
    }

    .markdown-content img {
      max-width: 100%;
      box-sizing: content-box;
      background-color: #fff;
      margin: 16px 0;
    }

    .markdown-content table {
      border-spacing: 0;
      border-collapse: collapse;
      display: block;
      width: 100%;
      overflow: auto;
      margin: 16px 0;
    }

    .markdown-content th,
    .markdown-content td {
      padding: 6px 13px;
      border: 1px solid var(--border-color);
    }

    .markdown-content th {
      font-weight: 600;
      background: var(--bg-light);
    }

    .markdown-content tr {
      background-color: #fff;
      border-top: 1px solid var(--border-color);
    }

    .markdown-content tr:nth-child(2n) {
      background-color: var(--bg-light);
    }

    .markdown-content blockquote {
      padding: 0 1em;
      color: #6a737d;
      border-left: 0.25em solid var(--border-color);
      margin: 0 0 16px 0;
    }

    .markdown-content ul,
    .markdown-content ol {
      padding-left: 2em;
      margin-top: 0;
      margin-bottom: 16px;
    }

    .markdown-content li {
      word-wrap: break-word;
    }

    .markdown-content li > p {
      margin-top: 16px;
    }

    .markdown-content li + li {
      margin-top: 0.25em;
    }

    /* æ ‡ç­¾æ ·å¼ */
    .tag {
      display: inline-block;
      padding: 0 10px;
      font-size: 12px;
      font-weight: 500;
      line-height: 22px;
      color: #0366d6;
      background-color: #f1f8ff;
      border-radius: 2em;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    /* ç¾åŒ–çš„åˆ¤é¢˜ç»“æœå¼¹æ¡† */
    .status-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      font-size: 1.05rem;
      font-weight: 500;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 300px;
      max-width: 450px;
    }

    .status-toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .status-success {
      background: #f0fff4;
      color: #22543d;
      border-left: 4px solid #38a169;
    }

    .status-error {
      background: #fff5f5;
      color: #742a2a;
      border-left: 4px solid #e53e3e;
    }

    .status-info {
      background: #edf2ff;
      color: #2c5282;
      border-left: 4px solid #4299e1;
    }

    .status-toast i {
      font-size: 1.3em;
    }

    @media (max-width: 768px) {
      .problem-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .CodeMirror {
        height: 350px;
      }

      .status-toast {
        min-width: auto;
        max-width: calc(100% - 40px);
      }
    }
  </style>
</head>
<body>
<div class="problem-container hidden">
  <!-- é¢˜ç›®å¤´éƒ¨ -->
  <div class="card info-card">
    <div class="problem-header p-4">
      <div class="problem-title">
        <i class="fas fa-code text-primary"></i>
        <span th:text="${competition_problem.title}"></span>
      </div>
      <div class="problem-meta d-flex justify-content-between align-items-center">
        <div>
          <div class="meta-item">
            <i class="fas fa-clock"></i>
            <span id="time" th:text="'æ—¶é—´é™åˆ¶ï¼š' + ${competition_problem.timeLimit} + ' ms'"></span>
          </div>
          <div class="meta-item">
            <i class="fas fa-memory"></i>
            <span id="memory" th:text="'å†…å­˜é™åˆ¶ï¼š' + ${competition_problem.memoryLimit} + ' MB'"></span>
          </div>
          <!-- æ ‡ç­¾åŒºåŸŸ -->
          <div class="meta-item">
            <i class="fas fa-tags text-primary"></i>
            <div id="tagsContainer" class="d-flex align-items-center flex-wrap gap-1"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é¢˜ç›®æè¿° -->
  <div class="card info-card">
    <div class="card-header">
      <h4 class="mb-0">é¢˜ç›®æè¿°</h4>
    </div>
    <div class="markdown-content" th:text="${competition_problem.description}"></div>
  </div>

  <!-- è¾“å…¥æ ¼å¼ -->
  <div class="card info-card">
    <div class="card-header">
      <h4 class="mb-0">è¾“å…¥æ ¼å¼</h4>
    </div>
    <div class="markdown-content" th:text="${competition_problem.inputFormat}"></div>
  </div>

  <!-- è¾“å‡ºæ ¼å¼ -->
  <div class="card info-card">
    <div class="card-header">
      <h4 class="mb-0">è¾“å‡ºæ ¼å¼</h4>
    </div>
    <div class="markdown-content" th:text="${competition_problem.outputFormat}"></div>
  </div>

  <!-- è¾“å…¥è¾“å‡ºæ ·ä¾‹ -->
  <div class="row g-4 mt-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">è¾“å…¥æ ·ä¾‹</h5>
        </div>
        <div class="code-preview" th:utext="${competition_problem.inputExample}"></div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">è¾“å‡ºæ ·ä¾‹</h5>
        </div>
        <div class="code-preview" th:utext="${competition_problem.outputExample}"></div>
      </div>
    </div>
  </div>

  <!-- æç¤º -->
  <div class="card info-card mt-4">
    <div class="card-header">
      <h4 class="mb-0">æç¤º</h4>
    </div>
    <div class="markdown-content" th:text="${competition_problem.hint}"></div>
  </div>

  <!-- æ¯”èµ›æœŸé—´ä¸æ”¯æŒè¯„è®ºçš„æç¤º -->
  <div class="competition-notice" id="competitionNotice">
    <i class="fas fa-exclamation-triangle"></i>
    <p class="notice-text">æ¯”èµ›æœŸé—´ä¸æ”¯æŒè¯„è®ºåŠŸèƒ½ï¼Œè¯·ä¸“æ³¨äºè§£é¢˜ã€‚æ¯”èµ›ç»“æŸåå¯æ­£å¸¸ä½¿ç”¨è¯„è®ºåŠŸèƒ½ã€‚</p>
  </div>

  <!-- è¯„è®ºåŒºåŸŸ -->
  <div class="card comment-section mt-5" id="commentSection" style="display: none;">
    <div class="card-header">
      <h4 class="mb-0">
        <i class="fas fa-comments me-2"></i>è¯„è®ºè®¨è®º
        <span class="badge bg-primary ms-2" id="commentCount">0</span>
      </h4>
    </div>
    <div class="card-body">
      <!-- å‘è¡¨è¯„è®ºåŒºåŸŸ -->
      <div class="comment-form mb-4">
        <div class="mb-3">
          <label for="commentContent" class="form-label">å‘è¡¨è¯„è®º</label>
          <div class="comment-input-container">
            <textarea id="commentContent" class="form-control" rows="4" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•ã€è§£é¢˜æ€è·¯æˆ–é‡åˆ°çš„é—®é¢˜..."></textarea>
            <button type="button" class="emoji-trigger" id="emojiTrigger">
              <i class="fas fa-smile"></i>
            </button>
          </div>
          <div class="emoji-picker-container">
            <div class="emoji-picker" id="emojiPicker">
              <div class="emoji-categories">
                <button class="emoji-category active" data-category="smileys">ğŸ˜€</button>
                <button class="emoji-category" data-category="people">ğŸ‘‹</button>
                <button class="emoji-category" data-category="animals">ğŸ¶</button>
                <button class="emoji-category" data-category="food">ğŸ</button>
                <button class="emoji-category" data-category="travel">ğŸš—</button>
                <button class="emoji-category" data-category="objects">ğŸ“±</button>
                <button class="emoji-category" data-category="symbols">â¤ï¸</button>
              </div>
              <div class="emoji-grid" id="emojiGrid">
                <!-- Emojiåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-primary" id="submitComment">
            <i class="fas fa-paper-plane me-2"></i>å‘è¡¨è¯„è®º
          </button>
        </div>
      </div>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <div id="commentList" class="comment-list">
        <div class="text-center text-muted py-4">
          <i class="fas fa-comment-slash fa-2x mb-2"></i>
          <p>æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ä»£ç æäº¤åŒºåŸŸ -->
  <div class="card code-editor-container mt-5">
    <form id="submitForm">
      <span id="pid" style="display: none;" th:text="${competition_problem.id}"></span>
      <div class="mb-3">
        <label class="form-label">é€‰æ‹©ç¼–ç¨‹è¯­è¨€</label>
        <div class="custom-select" id="languageSelect">
          <div class="select-selected">C++17</div>
          <div class="select-items">
            <div class="select-item selected" data-value="cpp">
              <span class="language-option">
                <span class="language-icon"><i class="fab fa-cuttlefish"></i></span>
                <span>C++17</span>
              </span>
            </div>
            <div class="select-item" data-value="python">
              <span class="language-option">
                <span class="language-icon"><i class="fab fa-python"></i></span>
                <span>Python</span>
              </span>
            </div>
            <div class="select-item" data-value="java">
              <span class="language-option">
                <span class="language-icon"><i class="fab fa-java"></i></span>
                <span>Java</span>
              </span>
            </div>
          </div>
        </div>
        <input type="hidden" id="languageSelectHidden" name="language" value="cpp">
      </div>
      <div id="judgeStatus" class="mb-3">
        <div id="statusAlert" class="alert" style="display: none;"></div>
      </div>

      <div class="mb-4">
        <div class="monaco-editor-container">
          <div class="editor-toolbar">
            <div class="language-info" id="languageInfo">C++17</div>
            <div class="editor-actions">
              <button type="button" class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i> æš—è‰²ä¸»é¢˜
              </button>
              <button type="button" class="theme-toggle" id="formatCode">
                <i class="fas fa-magic"></i> æ ¼å¼åŒ–
              </button>
            </div>
          </div>
          <div id="codeEditor" class="monaco-editor"></div>
        </div>
        <textarea id="codeEditorHidden" name="code" style="display: none;"></textarea>
      </div>

      <div class="d-flex justify-content-end">
        <button type="submit" class="submit-btn">
          <i class="fas fa-paper-plane me-2"></i> æäº¤ä»£ç 
        </button>
      </div>
    </form>
  </div>
</div>

<script src="/libs/bootstrap/bootstrap.bundle.min.js"></script>

<!-- Monaco Editor è„šæœ¬ -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>

<script>
  // é…ç½®marked.jsä»¥ç¬¦åˆGitHubé£æ ¼
  marked.setOptions({
    gfm: true,
    breaks: true,
    pedantic: false,
    smartLists: true,
    smartypants: false,
    highlight: function(code, lang) {
      const validLang = hljs.getLanguage(lang) ? lang : 'plaintext';
      return hljs.highlight(code, { language: validLang }).value;
    },
    extensions: [
      {
        name: 'math',
        level: 'inline',
        start(src) { return src.indexOf('$'); },
        tokenizer(src, tokens) {
          const match = src.match(/^\$+([^$\n]+?)\$+/);
          if (match) {
            return {
              type: 'math',
              raw: match[0],
              text: match[1].trim()
            };
          }
        },
        renderer(token) {
          return `<span class="math">\\(${token.text}\\)</span>`;
        }
      }
    ]
  });

  // æ¸²æŸ“Markdownå†…å®¹
  function renderMarkdownElements() {
    document.querySelectorAll('.markdown-content').forEach(element => {
      const rawText = element.textContent;
      const parsedMarkdown = marked.parse(rawText);
      const safeHtml = DOMPurify.sanitize(parsedMarkdown, {
        ADD_TAGS: ['iframe'],
        ADD_ATTR: ['allow', 'allowfullscreen', 'frameborder', 'scrolling']
      });
      element.innerHTML = safeHtml;

      // æ¸²æŸ“æ•°å­¦å…¬å¼
      if (typeof MathJax !== 'undefined') {
        MathJax.typesetPromise();
      }

      // é«˜äº®ä»£ç å—
      element.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
    });
  }

  // Monaco Editor ç›¸å…³å˜é‡
  let editor = null;
  let currentLanguage = 'cpp';
  let currentTheme = 'vs';

  // è¯­è¨€é…ç½®
  const languageConfig = {
    cpp: {
      language: 'cpp',
      template: `#include <iostream>
#include <set>
using namespace std;

int main() {
    int a, b;
    cin >> a >> b;
    cout << a + b << endl;
    
    return 0;
}`
    },
    python: {
      language: 'python',
      template: `# è¯·åœ¨æ­¤å¤„ç¼–å†™ä½ çš„ä»£ç 
a, b = map(int, input().split())
print(a + b)`
    },
    java: {
      language: 'java',
      template: `import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);
        int a = scanner.nextInt();
        int b = scanner.nextInt();
        System.out.println(a + b);
    }
}`
    }
  };

  // åˆå§‹åŒ– Monaco Editor
  function initMonacoEditor() {
    // æ£€æŸ¥ DOM å…ƒç´ æ˜¯å¦å­˜åœ¨
    const editorElement = document.getElementById('codeEditor');
    if (!editorElement) {
      console.error('ç¼–è¾‘å™¨å®¹å™¨å…ƒç´ æœªæ‰¾åˆ°');
      return;
    }

    // é…ç½® Monaco Editor
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      // æ³¨å†Œè¯­è¨€
      monaco.languages.register({ id: 'cpp' });
      monaco.languages.setMonarchTokensProvider('cpp', {
        tokenizer: {
          root: [
            [/[a-zA-Z_$][a-zA-Z0-9_$]*/, 'identifier'],
            [/\d+/, 'number'],
            [/["'].*?["']/, 'string'],
            [/\/\/.*$/, 'comment'],
            [/\/\*[\s\S]*?\*\//, 'comment'],
            [/[{}()\[\]]/, 'delimiter'],
            [/[;,.]/, 'delimiter']
          ]
        }
      });

      monaco.languages.register({ id: 'python' });
      monaco.languages.setMonarchTokensProvider('python', {
        tokenizer: {
          root: [
            [/[a-zA-Z_$][a-zA-Z0-9_$]*/, 'identifier'],
            [/\d+/, 'number'],
            [/["'].*?["']/, 'string'],
            [/#.*$/, 'comment'],
            [/[{}()\[\]]/, 'delimiter'],
            [/[;,.]/, 'delimiter']
          ]
        }
      });

      monaco.languages.register({ id: 'java' });
      monaco.languages.setMonarchTokensProvider('java', {
        tokenizer: {
          root: [
            [/[a-zA-Z_$][a-zA-Z0-9_$]*/, 'identifier'],
            [/\d+/, 'number'],
            [/["'].*?["']/, 'string'],
            [/\/\/.*$/, 'comment'],
            [/\/\*[\s\S]*?\*\//, 'comment'],
            [/[{}()\[\]]/, 'delimiter'],
            [/[;,.]/, 'delimiter']
          ]
        }
      });

      // åˆ›å»ºç¼–è¾‘å™¨
      editor = monaco.editor.create(editorElement, {
        value: languageConfig.cpp.template,
        language: 'cpp',
        theme: currentTheme,
        automaticLayout: true,
        minimap: { enabled: false },
        fontSize: 14,
        lineNumbers: 'on',
        roundedSelection: false,
        scrollBeyondLastLine: false,
        readOnly: false,
        cursorStyle: 'line',
        wordWrap: 'on',
        formatOnPaste: true,
        formatOnType: false,
        insertSpaces: true,
        tabSize: 4,
        detectIndentation: false,
        suggest: {
          showKeywords: true,
          showSnippets: true,
          showFunctions: true
        },
        parameterHints: { enabled: true },
        hover: { enabled: true },
        glyphMargin: true,
        occurrencesHighlight: 'single',
        renderLineHighlight: 'line'
      });

      // ç›‘å¬å†…å®¹å˜åŒ–
      editor.onDidChangeModelContent(() => {
        const value = editor.getValue();
        document.getElementById('codeEditorHidden').value = value;
      });

      console.log('Monaco Editor åˆå§‹åŒ–æˆåŠŸ');
    });
  }

  // åˆ‡æ¢è¯­è¨€
  function switchLanguage(language) {
    if (!editor) return;

    currentLanguage = language;
    const config = languageConfig[language];
    if (config) {
      monaco.editor.setModelLanguage(editor.getModel(), config.language);
      editor.setValue(config.template);
      document.getElementById('languageInfo').textContent = 
        language === 'cpp' ? 'C++17' : 
        language === 'python' ? 'Python' : 'Java';
    }
  }

  // ä¸»é¢˜åˆ‡æ¢
  function toggleTheme() {
    if (!editor) {
      console.log('Editor not initialized yet');
      return;
    }

    currentTheme = currentTheme === 'vs' ? 'vs-dark' : 'vs';
    monaco.editor.setTheme(currentTheme);

    const themeToggle = document.getElementById('themeToggle');
    const icon = themeToggle.querySelector('i');

    if (currentTheme === 'vs-dark') {
      icon.className = 'fas fa-sun';
      themeToggle.innerHTML = '<i class="fas fa-sun"></i> äº®è‰²ä¸»é¢˜';
    } else {
      icon.className = 'fas fa-moon';
      themeToggle.innerHTML = '<i class="fas fa-moon"></i> æš—è‰²ä¸»é¢˜';
    }
  }

  // ä»£ç æ ¼å¼åŒ–åŠŸèƒ½
  function formatCode() {
    if (!editor) return;

    try {
      const model = editor.getModel();
      if (model) {
        const value = model.getValue();
        const formatted = formatCppCode(value);
        editor.setValue(formatted);
        showToast('ä»£ç å·²æ ¼å¼åŒ–', 'success', 2000);
      }
    } catch (error) {
      console.error('æ ¼å¼åŒ–å¤±è´¥:', error);
      showToast('æ ¼å¼åŒ–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è°ƒæ•´ä»£ç ', 'error', 3000);
    }
  }

  // ç®€å•çš„ C++ ä»£ç æ ¼å¼åŒ–å‡½æ•°
  function formatCppCode(code) {
    let lines = code.split('\n');
    let formatted = [];
    let indentLevel = 0;
    const indent = '    ';

    for (let i = 0; i < lines.length; i++) {
      let line = lines[i].trim();

      if (!line) {
        formatted.push('');
        continue;
      }

      if (line.startsWith('#include') || line.startsWith('using namespace')) {
        formatted.push(line);
        continue;
      }

      if (line.startsWith('}')) {
        indentLevel = Math.max(0, indentLevel - 1);
      }

      formatted.push(indent.repeat(indentLevel) + line);

      if (line.endsWith('{')) {
        indentLevel++;
      }
    }

    return formatted.join('\n');
  }

  // åˆå§‹åŒ–è‡ªå®šä¹‰é€‰æ‹©æ¡†
  function initCustomSelect() {
    const customSelect = document.getElementById('languageSelect');
    const selected = customSelect.querySelector('.select-selected');
    const itemsContainer = customSelect.querySelector('.select-items');
    const items = customSelect.querySelectorAll('.select-item');

    selected.addEventListener('click', function(e) {
      e.stopPropagation();
      closeAllSelect(this);
      itemsContainer.classList.toggle('active');
      this.classList.toggle('select-arrow-active');
      
      if (itemsContainer.classList.contains('active')) {
        itemsContainer.style.display = 'block';
      }
    });

    items.forEach(item => {
      item.addEventListener('click', function(e) {
        e.stopPropagation();
        
        items.forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');
        
        const text = this.querySelector('span:last-child').textContent;
        selected.textContent = text;
        
        const value = this.getAttribute('data-value');
        document.getElementById('languageSelectHidden').value = value;
        
        switchLanguage(value);
        
        itemsContainer.classList.remove('active');
        itemsContainer.style.display = 'none';
        selected.classList.remove('select-arrow-active');
      });
    });
  }

  // å…³é—­æ‰€æœ‰é€‰æ‹©æ¡†
  function closeAllSelect(elmnt) {
    const selectItems = document.querySelectorAll('.select-items');
    const selectSelected = document.querySelectorAll('.select-selected');

    selectItems.forEach(item => {
      if (elmnt && item !== elmnt.nextElementSibling && elmnt !== item) {
        item.classList.remove('active');
        item.style.display = 'none';
      }
    });

    selectSelected.forEach(selected => {
      if (elmnt && selected !== elmnt) {
        selected.classList.remove('select-arrow-active');
      }
    });
  }

  // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­é€‰æ‹©æ¡†
  document.addEventListener('click', function(e) {
    closeAllSelect(e.target);
  });

  // è¯„è®ºåŠŸèƒ½ç›¸å…³ä»£ç 
  let currentProblemId = null;
  let currentUserId = null;
  let currentUsername = null;
  let currentReceiveUserId = null; // å½“å‰å›å¤çš„ç›®æ ‡ç”¨æˆ·ID

  // åˆå§‹åŒ–è¯„è®ºåŠŸèƒ½
  function initCommentSystem() {
    currentProblemId = document.getElementById('pid').textContent;
    currentUserId = localStorage.getItem('id');
    currentUsername = localStorage.getItem('name');
    
    if (!currentUserId || !currentUsername) {
      showToast('è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º', 'error');
      return;
    }

    // åŠ è½½è¯„è®ºåˆ—è¡¨
    loadComments();
    
    // ç»‘å®šäº‹ä»¶
    bindCommentEvents();
    
    // åˆå§‹åŒ–emojié€‰æ‹©å™¨
    initEmojiPicker();
  }

  // ç»‘å®šè¯„è®ºç›¸å…³äº‹ä»¶
  function bindCommentEvents() {
    // å‘è¡¨è¯„è®º
    document.getElementById('submitComment').addEventListener('click', submitComment);
    
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†å›å¤å’Œåˆ é™¤æŒ‰é’®
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('reply') || e.target.closest('.reply')) {
        e.preventDefault();
        const replyBtn = e.target.classList.contains('reply') ? e.target : e.target.closest('.reply');
        const commentId = replyBtn.dataset.commentId;
        currentReceiveUserId = replyBtn.dataset.receiveUserId; // ä¿å­˜è¢«å›å¤ç”¨æˆ·çš„ID
        showReplyForm(commentId);
      } else if (e.target.classList.contains('delete') || e.target.closest('.delete')) {
        e.preventDefault();
        const deleteBtn = e.target.classList.contains('delete') ? e.target : e.target.closest('.delete');
        const commentId = deleteBtn.dataset.commentId;
        deleteComment(commentId);
      } else if (e.target.classList.contains('submit-reply')) {
        e.preventDefault();
        const commentId = e.target.dataset.commentId;
        submitReply(commentId);
      } else if (e.target.classList.contains('cancel-reply')) {
        e.preventDefault();
        const commentId = e.target.dataset.commentId;
        hideReplyForm(commentId);
      }
    });
  }

  // åŠ è½½è¯„è®ºåˆ—è¡¨
  async function loadComments() {
    try {
      const response = await fetch(`/comment/list?pid=${currentProblemId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();
      if (data.code === 200) {
        renderComments(data.data);
        updateCommentCount(data.data.length);
      } else {
        showToast('åŠ è½½è¯„è®ºå¤±è´¥', 'error');
      }
    } catch (error) {
      console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
      showToast('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
    }
  }

  // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
  function renderComments(comments) {
    const commentList = document.getElementById('commentList');
    
    if (!comments || comments.length === 0) {
      commentList.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="fas fa-comment-slash fa-2x mb-2"></i>
          <p>æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
        </div>
      `;
      return;
    }

    commentList.innerHTML = comments.map(comment => renderCommentItem(comment)).join('');
  }

  // æ¸²æŸ“å•ä¸ªè¯„è®ºé¡¹ï¼ˆé¡¶çº§è¯„è®ºï¼‰
  function renderCommentItem(comment) {
    const isOwner = comment.userId == currentUserId;
    const avatarText = comment.username ? comment.username.charAt(0).toUpperCase() : 'U';
    
    // æ¸²æŸ“å­è¯„è®º
    let subcommentsHtml = '';
    if (comment.subcommentList && comment.subcommentList.length > 0) {
      subcommentsHtml = `
        <div class="subcomment-list">
          ${comment.subcommentList.map(subcomment => renderSubcommentItem(subcomment)).join('')}
        </div>
      `;
    }

    return `
      <div class="comment-item" data-comment-id="${comment.id}">
        <div class="comment-header">
          <div class="comment-author">
            <div class="avatar">${avatarText}</div>
            <span class="name">${comment.username || 'åŒ¿åç”¨æˆ·'}</span>
          </div>
          <div class="comment-time">${formatCommentTime(comment.createTime)}</div>
        </div>
        <div class="comment-content">${escapeHtml(comment.content)}</div>
        <div class="comment-actions">
          <button class="comment-action reply" data-comment-id="${comment.id}" data-receive-user-id="${comment.userId}">
            <i class="fas fa-reply me-1"></i>å›å¤
          </button>
          ${isOwner ? `
            <button class="comment-action delete" data-comment-id="${comment.id}">
              <i class="fas fa-trash me-1"></i>åˆ é™¤
            </button>
          ` : ''}
        </div>
        <div class="reply-form" id="reply-form-${comment.id}">
          <textarea placeholder="å›å¤ ${comment.username || 'åŒ¿åç”¨æˆ·'}..." rows="3"></textarea>
          <div class="reply-actions">
            <button class="reply-btn secondary cancel-reply" data-comment-id="${comment.id}">å–æ¶ˆ</button>
            <button class="reply-btn primary submit-reply" data-comment-id="${comment.id}">å›å¤</button>
          </div>
        </div>
        ${subcommentsHtml}
      </div>
    `;
  }

  // æ¸²æŸ“å­è¯„è®ºé¡¹
  function renderSubcommentItem(subcomment) {
    const isOwner = subcomment.userId == currentUserId;
    const avatarText = subcomment.username ? subcomment.username.charAt(0).toUpperCase() : 'U';
    const replyText = subcomment.receiveUserId && subcomment.receiveUsername ? 
      `å›å¤ <span class="reply-target">@${subcomment.receiveUsername}</span>` : '';

    return `
      <div class="subcomment-item" data-comment-id="${subcomment.id}">
        <div class="comment-header">
          <div class="comment-author">
            <div class="avatar">${avatarText}</div>
            <span class="name">${subcomment.username || 'åŒ¿åç”¨æˆ·'}</span>
            ${replyText ? `<span class="reply-text">${replyText}</span>` : ''}
          </div>
          <div class="comment-time">${formatCommentTime(subcomment.createTime)}</div>
        </div>
        <div class="comment-content">${escapeHtml(subcomment.content)}</div>
        <div class="comment-actions">
          <button class="comment-action reply" data-comment-id="${subcomment.id}" data-receive-user-id="${subcomment.userId}">
            <i class="fas fa-reply me-1"></i>å›å¤
          </button>
          ${isOwner ? `
            <button class="comment-action delete" data-comment-id="${subcomment.id}">
              <i class="fas fa-trash me-1"></i>åˆ é™¤
            </button>
          ` : ''}
        </div>
        <div class="reply-form" id="reply-form-${subcomment.id}">
          <textarea placeholder="å›å¤ ${subcomment.username || 'åŒ¿åç”¨æˆ·'}..." rows="3"></textarea>
          <div class="reply-actions">
            <button class="reply-btn secondary cancel-reply" data-comment-id="${subcomment.id}">å–æ¶ˆ</button>
            <button class="reply-btn primary submit-reply" data-comment-id="${subcomment.id}">å›å¤</button>
          </div>
        </div>
      </div>
    `;
  }

  // å‘è¡¨è¯„è®º
  async function submitComment() {
    const content = document.getElementById('commentContent').value.trim();
    
    if (!content) {
      showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
      return;
    }

    if (!currentUserId || !currentUsername) {
      showToast('è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º', 'error');
      return;
    }

    try {
      const response = await fetch('/comment/publish', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          problemId: parseInt(currentProblemId),
          parentId: null,
          receiveUserId: null, // é¡¶çº§è¯„è®ºæ²¡æœ‰å›å¤ç‰¹å®šç”¨æˆ·
          username: currentUsername,
          content: content,
          createTime: new Date().toISOString()
        })
      });

      const data = await response.json();
      if (data.code === 200) {
        showToast('è¯„è®ºå‘è¡¨æˆåŠŸ', 'success');
        document.getElementById('commentContent').value = '';
        loadComments(); // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
      } else {
        showToast(data.msg || 'è¯„è®ºå‘è¡¨å¤±è´¥', 'error');
      }
    } catch (error) {
      console.error('å‘è¡¨è¯„è®ºå¤±è´¥:', error);
      showToast('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
    }
  }

  // æ˜¾ç¤ºå›å¤è¡¨å•
  function showReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    if (replyForm) {
      replyForm.classList.add('show');
      replyForm.querySelector('textarea').focus();
    }
  }

  // éšè—å›å¤è¡¨å•
  function hideReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    if (replyForm) {
      replyForm.classList.remove('show');
      replyForm.querySelector('textarea').value = '';
    }
  }

  // æäº¤å›å¤
  async function submitReply(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    const content = replyForm.querySelector('textarea').value.trim();
    
    if (!content) {
      showToast('è¯·è¾“å…¥å›å¤å†…å®¹', 'error');
      return;
    }

    try {
      const response = await fetch('/comment/publish', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          problemId: parseInt(currentProblemId),
          parentId: parseInt(commentId),
          receiveUserId: currentReceiveUserId ? parseInt(currentReceiveUserId) : null,
          username: currentUsername,
          content: content,
          createTime: new Date().toISOString()
        })
      });

      const data = await response.json();
      if (data.code === 200) {
        showToast('å›å¤å‘è¡¨æˆåŠŸ', 'success');
        hideReplyForm(commentId);
        loadComments(); // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
      } else {
        showToast(data.msg || 'å›å¤å‘è¡¨å¤±è´¥', 'error');
      }
    } catch (error) {
      console.error('å‘è¡¨å›å¤å¤±è´¥:', error);
      showToast('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
    }
  }

  // åˆ é™¤è¯„è®º
  async function deleteComment(commentId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await fetch(`/comment/delete/${commentId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();
      if (data.code === 200) {
        showToast('è¯„è®ºåˆ é™¤æˆåŠŸ', 'success');
        loadComments(); // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
      } else {
        showToast(data.msg || 'è¯„è®ºåˆ é™¤å¤±è´¥', 'error');
      }
    } catch (error) {
      console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
      showToast('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
    }
  }

  // æ›´æ–°è¯„è®ºæ•°é‡
  function updateCommentCount(count) {
    const commentCountElement = document.getElementById('commentCount');
    if (commentCountElement) {
      commentCountElement.textContent = count;
    }
  }

  // æ ¼å¼åŒ–è¯„è®ºæ—¶é—´
  function formatCommentTime(timeString) {
    const time = new Date(timeString);
    const now = new Date();
    const diff = now - time;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) {
      return 'åˆšåˆš';
    } else if (minutes < 60) {
      return `${minutes}åˆ†é’Ÿå‰`;
    } else if (hours < 24) {
      return `${hours}å°æ—¶å‰`;
    } else if (days < 7) {
      return `${days}å¤©å‰`;
    } else {
      return time.toLocaleDateString();
    }
  }

  // HTMLè½¬ä¹‰å‡½æ•°
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // åˆå§‹åŒ–Emojié€‰æ‹©å™¨
  function initEmojiPicker() {
    const emojiTrigger = document.getElementById('emojiTrigger');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');
    const commentContent = document.getElementById('commentContent');

    if (!emojiTrigger || !emojiPicker || !emojiGrid || !commentContent) return;

    // Emojiæ•°æ®
    const emojis = {
      smileys: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£', 'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤', 'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾'],
      people: ['ğŸ‘‹', 'ğŸ¤š', 'ğŸ–', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’…', 'ğŸ¤³', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹', 'ğŸ©¸'],
      animals: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’', 'ğŸ¦', 'ğŸ¦§', 'ğŸ•', 'ğŸ©', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸˆ', 'ğŸ“', 'ğŸ¦ƒ', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¦¢', 'ğŸ¦©', 'ğŸ•Š', 'ğŸ‡', 'ğŸ¦', 'ğŸ¦¨', 'ğŸ¦¡', 'ğŸ¦¦', 'ğŸ¦¥', 'ğŸ', 'ğŸ€', 'ğŸ¿', 'ğŸ¦”', 'ğŸ¾', 'ğŸ‰', 'ğŸ²', 'ğŸŒµ', 'ğŸ„', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒ±', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‹', 'ğŸƒ', 'ğŸ‚', 'ğŸ', 'ğŸ„', 'ğŸš', 'ğŸŒ¾', 'ğŸ’', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒº', 'ğŸŒ¸', 'ğŸŒ¼', 'ğŸŒ»', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ›', 'ğŸŒœ', 'ğŸŒš', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—', 'ğŸŒ˜', 'ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ™', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'âœ¨', 'â˜„ï¸', 'â˜€ï¸', 'ğŸŒ¤', 'â›…', 'ğŸŒ¥', 'â˜ï¸', 'ğŸŒ¦', 'ğŸŒ§', 'â›ˆ', 'ğŸŒ©', 'ğŸŒ¨', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸŒ¬', 'ğŸ’¨', 'ğŸ’§', 'ğŸ’¦', 'â˜”', 'â˜‚ï¸', 'ğŸŒŠ', 'ğŸŒ«'],
      food: ['ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸ«', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦', 'ğŸ¥¬', 'ğŸ¥’', 'ğŸŒ¶', 'ğŸ«‘', 'ğŸŒ½', 'ğŸ¥•', 'ğŸ«’', 'ğŸ§„', 'ğŸ§…', 'ğŸ¥”', 'ğŸ ', 'ğŸ¥', 'ğŸ¥–', 'ğŸ', 'ğŸ¥¨', 'ğŸ¥¯', 'ğŸ§€', 'ğŸ¥š', 'ğŸ³', 'ğŸ§ˆ', 'ğŸ¥', 'ğŸ§‡', 'ğŸ¥“', 'ğŸ¥©', 'ğŸ—', 'ğŸ–', 'ğŸ¦´', 'ğŸŒ­', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸ«“', 'ğŸ¥™', 'ğŸ¥˜', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ«”', 'ğŸ¥—', 'ğŸ¥«', 'ğŸ', 'ğŸœ', 'ğŸ²', 'ğŸ›', 'ğŸ£', 'ğŸ±', 'ğŸ¥Ÿ', 'ğŸ¦ª', 'ğŸ¤', 'ğŸ™', 'ğŸš', 'ğŸ˜', 'ğŸ¥', 'ğŸ¥ ', 'ğŸ¥®', 'ğŸ¢', 'ğŸ¡', 'ğŸ§', 'ğŸ¨', 'ğŸ¦', 'ğŸ¥§', 'ğŸ§', 'ğŸ°', 'ğŸ‚', 'ğŸ®', 'ğŸ­', 'ğŸ¬', 'ğŸ«', 'ğŸ¿', 'ğŸ©', 'ğŸª', 'ğŸŒ°', 'ğŸ¥œ', 'ğŸ¯'],
      travel: ['ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸ', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸ', 'ğŸ›µ', 'ğŸš²', 'ğŸ›´', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›º', 'ğŸš', 'âœˆï¸', 'ğŸ›©', 'ğŸ›«', 'ğŸ›¬', 'ğŸª‚', 'ğŸ’º', 'ğŸš€', 'ğŸ›¸', 'ğŸš‰', 'ğŸš', 'ğŸš', 'ğŸš„', 'ğŸš…', 'ğŸšˆ', 'ğŸš‚', 'ğŸš†', 'ğŸš‡', 'ğŸšŠ', 'ğŸš', 'ğŸš˜', 'ğŸš–', 'ğŸš¡', 'ğŸš ', 'ğŸšŸ', 'ğŸ¢', 'ğŸ¡', 'ğŸ ', 'â›µ', 'ğŸ›¥', 'ğŸš¤', 'â›´', 'ğŸ›³', 'â›½', 'ğŸš§', 'ğŸš¨', 'ğŸš¥', 'ğŸš¦', 'ğŸ›‘', 'ğŸš', 'ğŸ’ˆ', 'â™¨ï¸', 'ğŸ¯', 'ğŸª', 'ğŸ­', 'ğŸ©°', 'ğŸ¨', 'ğŸ¬', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸµ', 'ğŸ¶', 'ğŸ¹', 'ğŸ¥', 'ğŸ·', 'ğŸº', 'ğŸ¸', 'ğŸª•', 'ğŸ»', 'ğŸ²', 'â™ ï¸', 'â™¥ï¸', 'â™¦ï¸', 'â™£ï¸', 'â™Ÿ', 'ğŸƒ', 'ğŸ€„', 'ğŸ´', 'ğŸ®', 'ğŸ•¹', 'ğŸ°', 'ğŸ§©', 'ğŸ¯', 'ğŸ³', 'ğŸ®', 'ğŸ•¹', 'ğŸ°', 'ğŸ§©', 'ğŸ¯', 'ğŸ³'],
      objects: ['ğŸ“±', 'ğŸ“²', 'â˜ï¸', 'ğŸ“', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ’»', 'ğŸ–¥', 'ğŸ–¨', 'âŒ¨ï¸', 'ğŸ–±', 'ğŸ–²', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ§®', 'ğŸ¥', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ“¼', 'ğŸ”', 'ğŸ”', 'ğŸ•¯', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ®', 'ğŸª”', 'ğŸ“”', 'ğŸ“•', 'ğŸ“–', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“š', 'ğŸ““', 'ğŸ“’', 'ğŸ“ƒ', 'ğŸ“œ', 'ğŸ“„', 'ğŸ“°', 'ğŸ—', 'ğŸ“‘', 'ğŸ”–', 'ğŸ·', 'ğŸ’°', 'ğŸ’´', 'ğŸ’µ', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’³', 'ğŸ’', 'âš–ï¸', 'ğŸ§°', 'ğŸ”§', 'ğŸ”¨', 'âš’', 'ğŸ› ', 'â›', 'ğŸ”©', 'âš™ï¸', 'ğŸ§±', 'â›“', 'ğŸ§²', 'ğŸ”«', 'ğŸ’£', 'ğŸ§¨', 'ğŸª“', 'ğŸ”ª', 'ğŸ—¡', 'âš”ï¸', 'ğŸ›¡', 'ğŸš¬', 'âš°ï¸', 'ğŸª¦', 'âš±ï¸', 'ğŸº', 'ğŸ”®', 'ğŸ“¿', 'ğŸ§¿', 'ğŸ’ˆ', 'âš—ï¸', 'ğŸ”­', 'ğŸ”¬', 'ğŸ•³', 'ğŸ©¹', 'ğŸ©º', 'ğŸ’Š', 'ğŸ’‰', 'ğŸ§¬', 'ğŸ¦ ', 'ğŸ§«', 'ğŸ§ª', 'ğŸŒ¡', 'ğŸ§¹', 'ğŸ§º', 'ğŸ§»', 'ğŸš½', 'ğŸš°', 'ğŸš¿', 'ğŸ›', 'ğŸ›€', 'ğŸ§¼', 'ğŸª’', 'ğŸ§½', 'ğŸ§´', 'ğŸ›', 'ğŸ”‘', 'ğŸ—', 'ğŸšª', 'ğŸª‘', 'ğŸ›', 'ğŸ›‹', 'ğŸª', 'ğŸªŸ', 'ğŸ›', 'ğŸ›’', 'ğŸ', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ€', 'ğŸ‚', 'ğŸ°', 'ğŸ§', 'ğŸ¥§', 'ğŸ­', 'ğŸ¬', 'ğŸ«', 'ğŸ©', 'ğŸª', 'ğŸ¯', 'ğŸ¯', 'ğŸ¯'],
      symbols: ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›', 'â›', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘', 'â™’', 'â™“', 'ğŸ†”', 'âš›ï¸', 'ğŸ‰‘', 'â˜¢ï¸', 'â˜£ï¸', 'ğŸ“´', 'ğŸ“³', 'ğŸˆ¶', 'ğŸˆš', 'ğŸˆ¸', 'ğŸˆº', 'ğŸˆ·ï¸', 'âœ´ï¸', 'ğŸ†š', 'ğŸ’®', 'ğŸ‰', 'ãŠ™ï¸', 'ãŠ—ï¸', 'ğŸˆ´', 'ğŸˆµ', 'ğŸˆ¹', 'ğŸˆ²', 'ğŸ…°ï¸', 'ğŸ…±ï¸', 'ğŸ†', 'ğŸ†‘', 'ğŸ…¾ï¸', 'ğŸ†˜', 'âŒ', 'â­•', 'ğŸ›‘', 'â›”', 'ğŸ“›', 'ğŸš«', 'ğŸ’¯', 'ğŸ’¢', 'â™¨ï¸', 'ğŸš·', 'ğŸš¯', 'ğŸš³', 'ğŸš±', 'ğŸ”', 'ğŸ“µ', 'ğŸš­', 'â—', 'â•', 'â“', 'â”', 'â€¼ï¸', 'â‰ï¸', 'ğŸ”…', 'ğŸ”†', 'ã€½ï¸', 'âš ï¸', 'ğŸš¸', 'ğŸ”±', 'âšœï¸', 'ğŸ”°', 'â™»ï¸', 'âœ…', 'ğŸˆ¯', 'ğŸ’¹', 'â‡ï¸', 'âœ³ï¸', 'â', 'ğŸŒ', 'ğŸ’ ', 'â“‚ï¸', 'ğŸŒ€', 'ğŸ’¤', 'ğŸ§', 'ğŸš¾', 'â™¿', 'ğŸ…¿ï¸', 'ğŸˆ³', 'ğŸˆ‚ï¸', 'ğŸ›‚', 'ğŸ›ƒ', 'ğŸ›„', 'ğŸ›…', 'ğŸš¹', 'ğŸšº', 'ğŸš¼', 'ğŸš»', 'ğŸš®', 'ğŸ¦', 'ğŸ“¶', 'ğŸˆ', 'ğŸ”£', 'ğŸ”¤', 'ğŸ”¡', 'ğŸ” ', 'ğŸ†–', 'ğŸ†—', 'ğŸ†™', 'ğŸ†’', 'ğŸ†•', 'ğŸ†“', '0ï¸âƒ£', '1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ']
    };

    // ç”ŸæˆEmojiç½‘æ ¼
    function generateEmojiGrid(category) {
      emojiGrid.innerHTML = '';
      emojis[category].forEach(emoji => {
        const emojiBtn = document.createElement('button');
        emojiBtn.className = 'emoji-item';
        emojiBtn.textContent = emoji;
        emojiBtn.addEventListener('click', () => {
          commentContent.value += emoji;
          commentContent.focus();
        });
        emojiGrid.appendChild(emojiBtn);
      });
    }

    // åˆ‡æ¢Emojiåˆ†ç±»
    const categoryBtns = document.querySelectorAll('.emoji-category');
    categoryBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        categoryBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        generateEmojiGrid(btn.dataset.category);
      });
    });

    // æ˜¾ç¤º/éšè—Emojié€‰æ‹©å™¨
    emojiTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      emojiPicker.classList.toggle('show');
    });

    // ç‚¹å‡»å¤–éƒ¨å…³é—­Emojié€‰æ‹©å™¨
    document.addEventListener('click', (e) => {
      if (!emojiPicker.contains(e.target) && !emojiTrigger.contains(e.target)) {
        emojiPicker.classList.remove('show');
      }
    });

    // åˆå§‹åŒ–æ˜¾ç¤ºç¬¬ä¸€ä¸ªåˆ†ç±»
    generateEmojiGrid('smileys');
  }

  // æ£€æŸ¥æ¯”èµ›çŠ¶æ€å¹¶æ˜¾ç¤º/éšè—è¯„è®ºåŒºåŸŸ
  async function checkCompetitionStatusAndShowComments() {
    try {
      const currentDate = new Date();
      const now = formatTime(currentDate);
      const id = cid;
      
      const response = await fetch('/competition/judgeIsEnd', {
        method: 'POST',
        body: JSON.stringify({now, id}),
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();
      const competitionNotice = document.getElementById('competitionNotice');
      const commentSection = document.getElementById('commentSection');
      
      if (data.code === 200) {
        // æ¯”èµ›å·²ç»“æŸï¼Œæ˜¾ç¤ºè¯„è®ºåŒºåŸŸï¼Œéšè—æ¯”èµ›æç¤º
        if (competitionNotice) {
          competitionNotice.style.display = 'none';
        }
        if (commentSection) {
          commentSection.style.display = 'block';
          // åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ
          initCommentSystem();
        }
      } else {
        // æ¯”èµ›æœªç»“æŸï¼Œæ˜¾ç¤ºæ¯”èµ›æç¤ºï¼Œéšè—è¯„è®ºåŒºåŸŸ
        if (competitionNotice) {
          competitionNotice.style.display = 'block';
        }
        if (commentSection) {
          commentSection.style.display = 'none';
        }
      }
    } catch (error) {
      console.error('æ£€æŸ¥æ¯”èµ›çŠ¶æ€å¤±è´¥:', error);
      // å‡ºé”™æ—¶é»˜è®¤æ˜¾ç¤ºæ¯”èµ›æç¤ºï¼Œéšè—è¯„è®ºåŒºåŸŸ
      const competitionNotice = document.getElementById('competitionNotice');
      const commentSection = document.getElementById('commentSection');
      
      if (competitionNotice) {
        competitionNotice.style.display = 'block';
      }
      if (commentSection) {
        commentSection.style.display = 'none';
      }
    }
  }

  // è·å–é¢˜ç›®æ ‡ç­¾
  async function fetchProblemTags(problemId, token) {
    return [];
  }

  // è¾…åŠ©å‡½æ•°
  function saveDraft() {
    localStorage.setItem('codeDraft', editor.getValue());
    showToast('ä»£ç è‰ç¨¿å·²è‡ªåŠ¨ä¿å­˜', 'info', 2000);
  }

  // æ˜¾ç¤ºç¾åŒ–çš„æç¤ºæ¡†
  function showToast(message, type = 'info', duration = 3000) {
    // ç§»é™¤å·²å­˜åœ¨çš„toast
    const existingToast = document.querySelector('.status-toast');
    if (existingToast) {
      existingToast.remove();
    }

    // åˆ›å»ºæ–°çš„toast
    const toast = document.createElement('div');
    toast.className = `status-toast status-${type}`;

    // æ ¹æ®ç±»å‹æ·»åŠ ä¸åŒçš„å›¾æ ‡
    let icon = '';
    if (type === 'success') {
      icon = '<i class="fas fa-check-circle"></i>';
    } else if (type === 'error') {
      icon = '<i class="fas fa-times-circle"></i>';
    } else {
      icon = '<i class="fas fa-info-circle"></i>';
    }

    toast.innerHTML = `${icon}<span>${message}</span>`;
    document.body.appendChild(toast);

    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
      toast.classList.add('show');
    }, 10);

    // è‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  function f(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
  }

  let cid = null;

  // é¡µé¢åŠ è½½åˆå§‹åŒ–
  window.addEventListener('DOMContentLoaded', async () => {
    if (!localStorage.getItem('token')) {
      showToast('è¯·å…ˆç™»å½•ï¼', 'error');
      setTimeout(() => {
        window.location.href = '/index.html';
      }, 1500);
      return;
    }

    const pathname = window.location.pathname;
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… cid
    const regex = /\/competition\/problem\/(\d+)\/\d+/;
    const match = pathname.match(regex);
    if (match) {
      cid = match[1];
    } else {
      console.log('æœªåŒ¹é…åˆ°æœ‰æ•ˆçš„ cid');
    }
    let ok;
    try {
      const currentDate = new Date();
      const now = f(currentDate);
      const id=cid;
      const response = await fetch('/competition/judgeIsOpen', {
        method: 'POST',
        body: JSON.stringify({now, id}),
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'  // æ˜ç¡®æŒ‡å®šJSONæ ¼å¼
        }
      });
      const data = await response.json();
      ok=data.data;
      if (data.code !== 200 && data.msg !== "") {
        showToast(data.msg || 'ç«èµ›æœªå¼€æ”¾', 'error');
        setTimeout(() => window.location.href = `/competition.html`, 1500);
        return;
      }
    } catch (error) {
      console.log(error);
      showToast('æ£€æŸ¥ç«èµ›çŠ¶æ€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      return;
    }
    if (ok){
      const key = "competition-" + cid + "-" + localStorage.getItem('name');
      const before = localStorage.getItem(key);
      const now = Math.floor(Date.now() / 1000);

      if (before === null || now - parseInt(before) >= 86400 ) {
        showToast('æ— æƒé™æŸ¥çœ‹', 'error');
        setTimeout(() => {
          window.location.href = `/competition.html`;
        }, 1500);
      }
    }
    document.querySelector('.problem-container').classList.remove('hidden');

    // åˆå§‹åŒ– Monaco Editor
    initMonacoEditor();
    
    // åˆå§‹åŒ–è‡ªå®šä¹‰é€‰æ‹©æ¡†
    initCustomSelect();

    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ˆç«‹å³ç»‘å®šï¼Œä¸ç­‰å¾… Monaco Editorï¼‰
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('formatCode').addEventListener('click', formatCode);

    // ç­‰å¾… Monaco Editor åŠ è½½å®Œæˆ
    setTimeout(() => {
      // åˆå§‹è®¾ç½®ä¸ºC++17
      switchLanguage('cpp');
      
      // æ£€æŸ¥æ¯”èµ›çŠ¶æ€å¹¶æ˜¾ç¤º/éšè—è¯„è®ºåŒºåŸŸ
      checkCompetitionStatusAndShowComments();
    }, 2000);

    if (typeof DOMPurify !== 'undefined') {
      renderMarkdownElements();
    }

    // åŠ è½½æ ‡ç­¾
    const problemId = document.getElementById('pid').textContent;
    const token = localStorage.getItem('token');
    const tagsContainer = document.getElementById('tagsContainer');

    if (problemId) {
      const tags = await fetchProblemTags(problemId, token);
      if (tags.length > 0) {
        tags.forEach(tag => {
          const tagElement = document.createElement('span');
          tagElement.className = 'tag';
          tagElement.textContent = tag.name || tag;
          tagsContainer.appendChild(tagElement);
        });
      } else {
        const noTags = document.createElement('span');
        noTags.className = 'text-muted';
        noTags.style.fontSize = '0.9rem';
        noTags.textContent = 'æ— æ ‡ç­¾';
        tagsContainer.appendChild(noTags);
      }
    }
  });

  async function checkCompetitionEnd(cid, token) {
    try {
      const currentDate = new Date();
      const now = f(currentDate);
      const id=cid;
      const response = await fetch('/competition/judgeIsEnd', {
        method: 'POST',
        body: JSON.stringify({now, id}),
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'  // æ˜ç¡®æŒ‡å®šJSONæ ¼å¼
        }
      });

      const data = await response.json();
      if (data.code !== 200 && data.msg !== "") {
        showToast(data.msg || 'ç«èµ›å·²ç»“æŸ', 'error');
        return false; // ç«èµ›å·²ç»“æŸ
      }
      return true; // ç«èµ›æœªç»“æŸ
    } catch (error) {
      console.error('æ£€æŸ¥ç«èµ›ç»“æŸçŠ¶æ€å¤±è´¥:', error);
      showToast('æ£€æŸ¥ç«èµ›çŠ¶æ€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      return false;
    }
  }
  function formatTime(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
  }

  // è¡¨å•æäº¤å¤„ç†
  document.getElementById('submitForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const isCompetitionOpen = await checkCompetitionEnd(cid, localStorage.getItem('token'));
    if (!isCompetitionOpen) {
      return; // é˜»æ­¢åç»­æäº¤æµç¨‹
    }

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const option = document.getElementById('languageSelectHidden').value;

    if (option === "java") {
      showToast("æš‚ä¸æ”¯æŒç”¨Javaæäº¤ï¼Œè¯·ç­‰å¾…", 'error');
      return;
    }

    // æ˜¾ç¤ºæäº¤ä¸­çš„æç¤º
    showToast('è¯„æµ‹ä¸­ï¼Œè¯·ç¨å€™...', 'info', 10000);

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>æäº¤ä¸­...';

    // æå–æ—¶é—´å’Œå†…å­˜é™åˆ¶
    const timeText = document.getElementById('time').textContent;
    const timeValue = timeText.split('ï¼š')[1].split(' ')[0];

    const memoryText = document.getElementById('memory').textContent;
    const memoryValue = memoryText.split('ï¼š')[1].split(' ')[0];

    try {
      const currentDate = new Date();
      const code = editor ? editor.getValue() : document.getElementById('codeEditorHidden').value;
      const pid = document.getElementById('pid').textContent;
      const uname = localStorage.getItem('name');
      const create_time = formatTime(currentDate);
      const time = timeValue;
      const memory = memoryValue;

      const response = await fetch('/judge/submit', {
        method: 'POST',
        body: JSON.stringify({ code, option, pid, uname, cid, create_time, time, memory }),
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      // æ˜¾ç¤ºç»“æœæç¤º
      // æ˜¾ç¤ºç»“æœæç¤º
      if (data.code === 200) {
        if(data.msg==="ç­”æ¡ˆæ­£ç¡®"){
          showToast(`${data.msg}ï¼`, 'success', 5000);
        }
        else{
          showToast(`${data.msg}ï¼`, 'error', 5000);
        }
      } else {
        showToast(`${data.msg}ï¼`, 'error', 5000);
      }

    } catch (error) {
      showToast('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i> æäº¤ä»£ç ';
    }
  });
</script>
</body>
</html>