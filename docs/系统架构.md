# Vnollx Online Judge 系统架构文档

## 1. 系统概述

Vnollx Online Judge 是一个现代化的在线编程评测系统，支持多种编程语言的代码提交、自动评测、比赛管理、练习管理等功能。系统采用前后端分离架构，具备高可用、高性能、易扩展的特点。

## 2. 技术栈总览

### 2.1 后端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Java | 21 | 编程语言，支持虚拟线程 |
| Spring Boot | 3.2.5 | 核心框架 |
| Spring Data JPA | - | ORM框架 |
| MyBatis-Plus | 3.5.5 | 增强型MyBatis |
| MySQL | 8.0 | 主数据库（主从复制） |
| Redis | Latest | 缓存与会话管理 |
| RabbitMQ | Latest | 消息队列 |
| MinIO | Latest | 对象存储 |
| Go-Judge | Latest | 代码评测沙箱 |
| JWT | 0.12.5 | 身份认证 |
| LangChain4j | 0.31.0 | AI集成 |

### 2.2 前端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| React | 19.2.0 | UI框架 |
| TypeScript | 5.9.3 | 类型安全 |
| Vite | 7.2.4 | 构建工具 |
| Ant Design | 5.21.0 | UI组件库 |
| TailwindCSS | 3.4.17 | CSS框架 |
| Monaco Editor | 0.55.1 | 代码编辑器 |
| React Router | 6.26.0 | 路由管理 |
| Axios | 1.7.7 | HTTP客户端 |

## 3. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              客户端层                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                      │
│  │   浏览器     │  │   移动端     │  │   API调用   │                      │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                      │
└─────────┼────────────────┼────────────────┼─────────────────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              网关层                                       │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     Nginx / 负载均衡                              │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              应用层                                       │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                   Spring Boot 应用 (端口 8080)                    │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐        │    │
│  │  │ Controller│ │  Service  │ │  Mapper   │ │   Filter  │        │    │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘        │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐        │    │
│  │  │    AOP    │ │ WebSocket │ │  Consumer │ │  Producer │        │    │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘        │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              中间件层                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                   │
│  │    Redis     │  │  RabbitMQ    │  │    MinIO     │                   │
│  │   缓存/会话   │  │   消息队列    │  │   对象存储    │                   │
│  │  端口: 6379  │  │ 端口: 5672   │  │ 端口: 9000   │                   │
│  └──────────────┘  └──────────────┘  └──────────────┘                   │
└─────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              数据层                                       │
│  ┌────────────────────────────┐  ┌────────────────────────────┐         │
│  │      MySQL Master          │  │      MySQL Slave            │         │
│  │      主库 (读写)            │  │      从库 (只读)            │         │
│  │      端口: 3308            │  │      端口: 3309             │         │
│  └────────────────────────────┘  └────────────────────────────┘         │
└─────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              评测层                                       │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                      Go-Judge 沙箱                                │    │
│  │                      端口: 5050                                   │    │
│  │   支持语言: C, C++, Java, Python, JavaScript, Go 等               │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

## 4. 核心架构设计

### 4.1 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Controller 层                             │
│         处理HTTP请求，参数校验，权限检查                        │
├─────────────────────────────────────────────────────────────┤
│                    Service 层                                │
│         业务逻辑处理，事务管理，缓存操作                        │
├─────────────────────────────────────────────────────────────┤
│                    Mapper/Repository 层                      │
│         数据访问，SQL执行，ORM映射                             │
├─────────────────────────────────────────────────────────────┤
│                    Entity 层                                 │
│         数据实体，数据库表映射                                 │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 数据库主从复制架构

```
                    ┌─────────────────┐
                    │   Application   │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
              ▼                             ▼
    ┌─────────────────┐           ┌─────────────────┐
    │  MySQL Master   │ ────────▶ │  MySQL Slave    │
    │   (写操作)       │  binlog   │   (读操作)       │
    │   端口: 3308    │  复制     │   端口: 3309     │
    └─────────────────┘           └─────────────────┘
```

- **主库 (Master)**：处理所有写操作（INSERT, UPDATE, DELETE）
- **从库 (Slave)**：处理读操作（SELECT），通过binlog同步主库数据
- **动态数据源**：使用 `@DS("master")` 和 `@DS("slave")` 注解切换数据源

### 4.3 消息队列架构

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Producer   │────▶│  RabbitMQ   │────▶│  Consumer   │
│  提交代码    │     │   Queue     │     │  评测处理    │
└─────────────┘     └─────────────┘     └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │  Go-Judge   │
                    │  代码评测    │
                    └─────────────┘
```

- **judge.queue**：评测任务队列
- **异步处理**：代码提交后立即返回，后台异步评测
- **结果推送**：通过 WebSocket 实时推送评测结果

### 4.4 缓存架构

```
┌─────────────────────────────────────────────────────────────┐
│                       Redis 缓存                             │
├─────────────────────────────────────────────────────────────┤
│  user:permissions:{userId}  │  用户权限缓存                   │
│  user:roles:{userId}        │  用户角色缓存                   │
│  email:code:{email}         │  邮箱验证码                     │
│  testcase:{problemId}       │  测试用例缓存                   │
│  token:{userId}             │  用户Token                     │
└─────────────────────────────────────────────────────────────┘
```

## 5. 安全架构

### 5.1 认证流程

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────┐
│  客户端  │────▶│ TokenFilter │────▶│ JWT验证     │────▶│ Controller│
└─────────┘     └─────────────┘     └─────────────┘     └─────────┘
                      │
                      ▼
              ┌───────────────┐
              │ UserContext   │
              │ 设置用户信息   │
              └───────────────┘
```

### 5.2 权限控制

```
┌─────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ @RequirePermission│     PermissionAspect     PermissionService│
│   注解标记   │────▶│   AOP切面拦截   │────▶│  权限检查        │
└─────────────┘     └─────────────────┘     └─────────────────┘
                                                   │
                                    ┌──────────────┴──────────────┐
                                    ▼                             ▼
                            ┌─────────────┐               ┌─────────────┐
                            │ Redis缓存   │               │  数据库      │
                            └─────────────┘               └─────────────┘
```

## 6. 项目目录结构

```
VnollxOnlineJudge/
├── src/main/java/com/example/vnollxonlinejudge/
│   ├── annotation/          # 自定义注解
│   ├── aop/                  # AOP切面
│   ├── aspect/               # 切面实现
│   ├── config/               # 配置类
│   ├── consumer/             # 消息消费者
│   ├── controller/           # 控制器
│   ├── convert/              # 对象转换器
│   ├── exception/            # 异常处理
│   ├── filter/               # 过滤器
│   ├── judge/                # 评测相关
│   ├── listener/             # 事件监听
│   ├── mapper/               # MyBatis映射
│   ├── model/                # 数据模型
│   │   ├── base/             # 基础类
│   │   ├── dto/              # 数据传输对象
│   │   ├── entity/           # 实体类
│   │   ├── query/            # 查询对象
│   │   ├── result/           # 响应结果
│   │   └── vo/               # 视图对象
│   ├── producer/             # 消息生产者
│   ├── service/              # 服务层
│   ├── utils/                # 工具类
│   └── websocket/            # WebSocket
├── src/main/resources/
│   ├── application.yml       # 主配置文件
│   ├── mapper/               # MyBatis XML
│   ├── sql/                  # SQL脚本
│   └── templates/            # 模板文件
├── frontend/                 # 前端项目
│   ├── src/
│   │   ├── components/       # 组件
│   │   ├── pages/            # 页面
│   │   ├── hooks/            # 自定义Hook
│   │   ├── utils/            # 工具函数
│   │   └── types/            # 类型定义
│   └── package.json
├── docs/                     # 文档目录
├── docker-compose.yml        # Docker编排
├── Dockerfile                # Docker构建
└── pom.xml                   # Maven配置
```

## 7. 性能优化策略

### 7.1 数据库优化
- 主从分离，读写分离
- 连接池（Druid）管理
- MyBatis批量执行模式

### 7.2 缓存优化
- Redis缓存热点数据
- Caffeine本地缓存
- 权限数据预加载

### 7.3 异步处理
- RabbitMQ异步评测
- 虚拟线程支持
- WebSocket实时推送

### 7.4 前端优化
- 代码分割
- 懒加载
- Monaco Editor预加载

## 8. 扩展性设计

### 8.1 水平扩展
- 应用层无状态设计
- 数据库主从复制
- Redis集群支持

### 8.2 垂直扩展
- 模块化设计
- 插件化评测语言
- AI服务独立配置
