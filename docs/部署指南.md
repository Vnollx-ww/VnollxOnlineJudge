# Vnollx Online Judge 部署指南

## 1. 环境要求

### 1.1 服务器要求

| 配置项 | 最低要求 | 推荐配置 |
|--------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 硬盘 | 50GB | 100GB+ SSD |
| 操作系统 | Linux (Ubuntu 20.04+) | Ubuntu 22.04 LTS |

### 1.2 软件依赖

| 软件 | 版本要求 | 说明 |
|------|----------|------|
| Docker | 20.10+ | 容器运行时 |
| Docker Compose | 2.0+ | 容器编排 |
| JDK | 21+ | Java运行环境（本地开发）|
| Node.js | 18+ | 前端构建（本地开发）|
| Maven | 3.8+ | Java构建工具（本地开发）|

## 2. Docker部署（推荐）

### 2.1 获取代码

```bash
git clone https://github.com/your-repo/VnollxOnlineJudge.git
cd VnollxOnlineJudge
```

### 2.2 配置文件

#### docker-compose.yml

```yaml
services:
  # 应用服务
  vnollx:
    image: vnollx/vnollx:latest
    container_name: vnollx
    ports:
      - "8080:8080"
    networks:
      - app-network
    depends_on:
      - mysql-master
      - mysql-slave
      - redis
      - rabbitmq
    environment:
      - SPRING_PROFILES_ACTIVE=prod

  # MySQL主库
  mysql-master:
    image: mysql:8.0
    container_name: mysql-master
    ports:
      - "3308:3308"
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: vnollxonlinejudge
    volumes:
      - mysql-master-data:/var/lib/mysql
    command:
      - --port=3308
      - --server-id=1
      - --log-bin=mysql-bin
      - --binlog-format=ROW
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
    networks:
      - app-network

  # MySQL从库
  mysql-slave:
    image: mysql:8.0
    container_name: mysql-slave
    ports:
      - "3309:3309"
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: vnollxonlinejudge
    volumes:
      - mysql-slave-data:/var/lib/mysql
    command:
      - --port=3309
      - --server-id=2
      - --read-only=1
    depends_on:
      - mysql-master
    networks:
      - app-network

  # Redis缓存
  redis:
    image: redis:latest
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - app-network

  # RabbitMQ消息队列
  rabbitmq:
    image: rabbitmq:management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - app-network

  # MinIO对象存储
  minio:
    image: bitnami/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    networks:
      - app-network

  # Go-Judge评测沙箱
  go-judge:
    image: criyle/go-judge:latest
    container_name: go-judge
    ports:
      - "5050:5050"
    privileged: true
    networks:
      - app-network

volumes:
  mysql-master-data:
  mysql-slave-data:
  minio-data:
  rabbitmq-data:

networks:
  app-network:
    driver: bridge
```

### 2.3 启动服务

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f vnollx
```

### 2.4 初始化数据库

```bash
# 进入MySQL容器
docker exec -it mysql-master mysql -uroot -prootpassword

# 执行初始化SQL
source /path/to/permission_init.sql
```

## 3. 手动部署

### 3.1 安装MySQL

```bash
# Ubuntu
sudo apt update
sudo apt install mysql-server

# 创建数据库
mysql -u root -p
CREATE DATABASE vnollxonlinejudge CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 3.2 安装Redis

```bash
sudo apt install redis-server
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

### 3.3 安装RabbitMQ

```bash
# 安装Erlang
sudo apt install erlang

# 安装RabbitMQ
sudo apt install rabbitmq-server
sudo systemctl enable rabbitmq-server
sudo systemctl start rabbitmq-server

# 启用管理插件
sudo rabbitmq-plugins enable rabbitmq_management

# 创建用户
sudo rabbitmqctl add_user admin admin
sudo rabbitmqctl set_user_tags admin administrator
sudo rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"
```

### 3.4 安装MinIO

```bash
# 下载MinIO
wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio

# 启动MinIO
MINIO_ROOT_USER=minioadmin MINIO_ROOT_PASSWORD=minioadmin ./minio server /data --console-address ":9001"
```

### 3.5 安装Go-Judge

```bash
# 使用Docker运行
docker run -d --name go-judge \
  -p 5050:5050 \
  --privileged \
  criyle/go-judge:latest
```

### 3.6 构建后端

```bash
# 进入项目目录
cd VnollxOnlineJudge

# 修改配置文件
vim src/main/resources/application.yml

# 构建
mvn clean package -DskipTests

# 运行
java -jar target/VnollxOnlineJudge-0.0.1-SNAPSHOT.jar
```

### 3.7 构建前端

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 部署到Nginx
cp -r dist/* /var/www/html/
```

## 4. Nginx配置

### 4.1 安装Nginx

```bash
sudo apt install nginx
```

### 4.2 配置文件

```nginx
# /etc/nginx/sites-available/vnollx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket代理
    location /ws {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
```

### 4.3 启用站点

```bash
sudo ln -s /etc/nginx/sites-available/vnollx /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 5. SSL配置

### 5.1 使用Let's Encrypt

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
0 12 * * * /usr/bin/certbot renew --quiet
```

## 6. 配置说明

### 6.1 application.yml关键配置

```yaml
spring:
  # 数据源配置
  datasource:
    dynamic:
      primary: master
      datasource:
        master:
          url: jdbc:mysql://mysql-master:3308/vnollxonlinejudge
          username: root
          password: rootpassword
        slave:
          url: jdbc:mysql://mysql-slave:3309/vnollxonlinejudge
          username: root
          password: rootpassword

  # Redis配置
  data:
    redis:
      host: redis
      port: 6379

  # RabbitMQ配置
  rabbitmq:
    host: rabbitmq
    port: 5672
    username: admin
    password: admin

# 服务端口
server:
  port: 8080

# AI配置
openai:
  model: "qwen3-max"
  api-key: "your-api-key"
```

### 6.2 环境变量

| 变量名 | 说明 | 示例 |
|--------|------|------|
| MYSQL_HOST | MySQL主机 | localhost |
| MYSQL_PASSWORD | MySQL密码 | rootpassword |
| REDIS_HOST | Redis主机 | localhost |
| RABBITMQ_HOST | RabbitMQ主机 | localhost |
| MINIO_ENDPOINT | MinIO地址 | http://localhost:9000 |
| OPENAI_API_KEY | AI API密钥 | sk-xxx |

## 7. 运维管理

### 7.1 日志管理

```bash
# 查看应用日志
docker logs -f vnollx

# 查看MySQL日志
docker logs -f mysql-master

# 日志位置（非Docker）
/var/log/vnollx/application.log
```

### 7.2 备份策略

```bash
# 数据库备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d)
docker exec mysql-master mysqldump -uroot -prootpassword vnollxonlinejudge > backup_$DATE.sql

# MinIO数据备份
docker run --rm -v minio-data:/data -v $(pwd):/backup alpine tar czf /backup/minio_$DATE.tar.gz /data
```

### 7.3 监控

系统内置 Actuator 端点：

| 端点 | 说明 |
|------|------|
| `/actuator/health` | 健康检查 |
| `/actuator/metrics` | 性能指标 |
| `/actuator/prometheus` | Prometheus格式指标 |

### 7.4 常见问题

**Q: MySQL主从复制不工作**
```bash
# 检查从库状态
docker exec mysql-slave mysql -uroot -prootpassword -e "SHOW SLAVE STATUS\G"
```

**Q: RabbitMQ连接失败**
```bash
# 检查用户权限
docker exec rabbitmq rabbitmqctl list_users
docker exec rabbitmq rabbitmqctl list_permissions
```

**Q: 评测超时**
- 检查 Go-Judge 容器是否正常运行
- 增加评测超时时间配置

## 8. 性能调优

### 8.1 JVM参数

```bash
java -Xms2g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -jar VnollxOnlineJudge.jar
```

### 8.2 MySQL调优

```ini
[mysqld]
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
max_connections = 500
```

### 8.3 Redis调优

```conf
maxmemory 1gb
maxmemory-policy allkeys-lru
```

## 9. 更新升级

### 9.1 Docker更新

```bash
# 拉取最新镜像
docker-compose pull

# 重启服务
docker-compose up -d

# 清理旧镜像
docker image prune -f
```

### 9.2 手动更新

```bash
# 拉取代码
git pull origin main

# 重新构建
mvn clean package -DskipTests

# 重启服务
sudo systemctl restart vnollx
```

## 10. 安全建议

1. **修改默认密码**：MySQL、Redis、RabbitMQ、MinIO
2. **配置防火墙**：只开放必要端口（80/443）
3. **使用HTTPS**：配置SSL证书
4. **定期备份**：数据库和文件存储
5. **日志审计**：记录操作日志
6. **更新依赖**：定期更新安全补丁
