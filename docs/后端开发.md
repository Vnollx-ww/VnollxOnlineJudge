# Vnollx Online Judge 后端开发文档

## 1. 技术栈详解

### 1.1 核心框架
- **Spring Boot 3.2.5**：基于 Java 21，支持虚拟线程
- **Spring Data JPA**：ORM框架，简化数据库操作
- **MyBatis-Plus 3.5.5**：增强型 MyBatis，提供 CRUD 简化

### 1.2 数据库
- **MySQL 8.0**：主数据库，支持主从复制
- **Druid**：数据库连接池
- **Dynamic Datasource**：动态数据源切换

### 1.3 中间件
- **Redis**：缓存、会话管理、分布式锁
- **RabbitMQ**：消息队列，异步评测
- **MinIO**：对象存储，存储测试用例和文件

### 1.4 其他
- **JWT**：身份认证
- **LangChain4j**：AI 集成
- **WebSocket**：实时通信

## 2. 项目结构

```
src/main/java/com/example/vnollxonlinejudge/
├── VnollxOnlineJudgeApplication.java   # 启动类
├── annotation/                          # 自定义注解
│   ├── RequirePermission.java          # 权限注解
│   ├── RequireRole.java                # 角色注解
│   └── RateLimiter.java                # 限流注解
├── aop/                                 # AOP相关
│   ├── DataSourceAspect.java           # 数据源切换
│   ├── LogAspect.java                  # 日志切面
│   ├── RateLimiterAspect.java          # 限流切面
│   └── TransactionAspect.java          # 事务切面
├── aspect/                              # 切面实现
│   └── PermissionAspect.java           # 权限检查切面
├── config/                              # 配置类
│   ├── AiConfig.java                   # AI配置
│   ├── DynamicAiConfig.java            # 动态AI配置
│   ├── EmailConfig.java                # 邮件配置
│   ├── FilterConfig.java               # 过滤器配置
│   ├── GlobalCorsConfig.java           # 跨域配置
│   ├── GoJudgeConfig.java              # 评测配置
│   ├── HttpClientConfig.java           # HTTP客户端
│   ├── JacksonConfig.java              # JSON序列化
│   ├── MinioConfig.java                # MinIO配置
│   ├── MyBatisPlusConfig.java          # MyBatis配置
│   ├── RabbitMQConfig.java             # 消息队列配置
│   ├── RedisConfig.java                # Redis配置
│   ├── WebConfig.java                  # Web配置
│   └── WebSocketConfig.java            # WebSocket配置
├── consumer/                            # 消息消费者
│   ├── JudgeConsumer.java              # 评测消费者
│   └── NotificationConsumer.java       # 通知消费者
├── controller/                          # 控制器层
├── convert/                             # 对象转换器
├── exception/                           # 异常处理
│   ├── BusinessException.java          # 业务异常
│   ├── GlobalExceptionHandler.java     # 全局异常处理
│   ├── PermissionException.java        # 权限异常
│   └── ValidationException.java        # 验证异常
├── filter/                              # 过滤器
│   ├── CorsFilter.java                 # 跨域过滤器
│   ├── RequestLoggingFilter.java       # 请求日志
│   ├── TokenFilter.java                # Token验证
│   └── XssFilter.java                  # XSS防护
├── judge/                               # 评测相关
│   ├── GoJudgeClient.java              # 评测客户端
│   ├── JudgeResult.java                # 评测结果
│   ├── JudgeTask.java                  # 评测任务
│   ├── LanguageConfig.java             # 语言配置
│   └── TestCaseLoader.java             # 测试用例加载
├── mapper/                              # MyBatis映射接口
├── model/                               # 数据模型
├── producer/                            # 消息生产者
│   ├── JudgeProducer.java              # 评测生产者
│   └── NotificationProducer.java       # 通知生产者
├── service/                             # 服务层
├── utils/                               # 工具类
│   ├── JwtToken.java                   # JWT工具
│   ├── PasswordUtil.java               # 密码工具
│   ├── RedisUtil.java                  # Redis工具
│   ├── UserContextHolder.java          # 用户上下文
│   └── ...
└── websocket/                           # WebSocket
    ├── JudgeWebSocketHandler.java      # 评测WebSocket
    ├── MessageWebSocketHandler.java    # 消息WebSocket
    └── WebSocketSessionManager.java    # 会话管理
```

## 3. 控制器层

### 3.1 控制器列表

| 控制器 | 路径前缀 | 说明 |
|--------|----------|------|
| UserController | `/user` | 用户管理 |
| ProblemController | `/problem` | 题目查看 |
| SubmissionController | `/submission` | 提交管理 |
| CompetitionController | `/competition` | 比赛查看 |
| PracticeController | `/practice` | 练习查看 |
| SolveController | `/solve` | 题解管理 |
| CommentController | `/comment` | 评论管理 |
| FriendController | `/friend` | 好友功能 |
| NotificationController | `/notification` | 通知管理 |
| TagController | `/tag` | 标签查看 |
| JudgeController | `/judge` | 评测接口 |
| AiController | `/ai` | AI对话 |
| EmailController | `/email` | 邮件服务 |

### 3.2 管理员控制器

| 控制器 | 路径前缀 | 说明 |
|--------|----------|------|
| AdminUserController | `/admin/user` | 用户管理 |
| AdminProblemController | `/admin/problem` | 题目管理 |
| AdminCompetitionController | `/admin/competition` | 比赛管理 |
| AdminPracticeController | `/admin/practice` | 练习管理 |
| AdminSolveController | `/admin/solve` | 题解管理 |
| AdminNotificationController | `/admin/notification` | 通知管理 |
| AdminTagController | `/admin/tag` | 标签管理 |
| AdminPermissionController | `/admin/permission` | 权限管理 |
| AdminAiConfigController | `/admin/ai` | AI配置 |

## 4. 数据模型

### 4.1 核心实体

```java
// 用户实体
@Entity
@Table(name = "user")
public class User {
    private Long id;
    private String name;
    private String email;
    private String password;
    private String identity;      // USER, ADMIN, SUPER_ADMIN
    private Integer submitCount;
    private Integer passCount;
    private LocalDateTime createTime;
    private LocalDateTime lastLoginTime;
}

// 题目实体
@Entity
@Table(name = "problem")
public class Problem {
    private Long id;
    private String title;
    private String description;
    private String inputFormat;
    private String outputFormat;
    private String sampleInput;
    private String sampleOutput;
    private Integer difficulty;   // 1-5
    private Integer timeLimit;    // ms
    private Integer memoryLimit;  // MB
    private Integer submitCount;
    private Integer acceptCount;
}

// 提交实体
@Entity
@Table(name = "submission")
public class Submission {
    private Long id;
    private Long userId;
    private Long problemId;
    private String code;
    private String language;
    private String status;        // Pending, Accepted, WrongAnswer...
    private Integer timeUsed;
    private Integer memoryUsed;
    private LocalDateTime submitTime;
}

// 比赛实体
@Entity
@Table(name = "competition")
public class Competition {
    private Long id;
    private String title;
    private String description;
    private LocalDateTime startTime;
    private LocalDateTime endTime;
    private String password;
    private Integer status;       // 0-未开始, 1-进行中, 2-已结束
}
```

### 4.2 权限相关实体

```java
// 角色
public class Role {
    private Long id;
    private String code;          // USER, ADMIN, SUPER_ADMIN
    private String name;
    private String description;
}

// 权限
public class Permission {
    private Long id;
    private String code;          // problem:view, user:manage
    private String name;
    private String description;
    private String module;
}

// 用户-角色关联
public class UserRole {
    private Long id;
    private Long userId;
    private Long roleId;
}

// 角色-权限关联
public class RolePermission {
    private Long id;
    private Long roleId;
    private Long permissionId;
}
```

## 5. 服务层

### 5.1 核心服务

```java
// 用户服务
public interface UserService {
    User login(String email, String password);
    void register(RegisterDTO dto);
    User getUserById(Long id);
    void updateProfile(Long userId, UpdateProfileDTO dto);
    void changePassword(Long userId, String oldPwd, String newPwd);
}

// 题目服务
public interface ProblemService {
    Problem getProblemById(Long id);
    List<ProblemVo> getProblemList(ProblemQuery query);
    void createProblem(CreateProblemDTO dto);
    void updateProblem(Long id, UpdateProblemDTO dto);
}

// 评测服务
public interface JudgeService {
    void submitCode(SubmitDTO dto);
    JudgeResult getResult(Long submissionId);
}

// 权限服务
public interface PermissionService {
    Set<String> getUserPermissionCodes(Long userId);
    boolean hasPermission(Long userId, String permissionCode);
    void assignRoleToUser(Long userId, Long roleId);
    void refreshUserPermissionCache(Long userId);
}
```

## 6. 权限系统

### 6.1 权限注解

```java
// 要求特定权限
@RequirePermission("problem:create")
@PostMapping("/create")
public Result<Void> createProblem(@RequestBody CreateProblemDTO dto) {
    // ...
}

// 要求特定角色
@RequireRole("ADMIN")
@DeleteMapping("/delete/{id}")
public Result<Void> deleteProblem(@PathVariable Long id) {
    // ...
}

// 多权限（任一）
@RequirePermission(value = {"problem:update", "problem:manage"}, logical = Logical.OR)
@PutMapping("/update")
public Result<Void> updateProblem(@RequestBody UpdateProblemDTO dto) {
    // ...
}
```

### 6.2 权限检查流程

```
请求 → TokenFilter → 解析JWT → 设置UserContext
                          ↓
Controller方法 → @RequirePermission注解
                          ↓
PermissionAspect (AOP) → 拦截方法调用
                          ↓
PermissionService.hasPermission() → 检查Redis缓存
                          ↓
              缓存命中？→ 是 → 返回结果
                   ↓ 否
              查询数据库 → 写入缓存 → 返回结果
                          ↓
              有权限？→ 是 → 执行方法
                   ↓ 否
              抛出 PermissionException
```

## 7. 消息队列

### 7.1 评测队列

```java
// 生产者 - 发送评测任务
@Component
public class JudgeProducer {
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void sendJudgeTask(JudgeTask task) {
        rabbitTemplate.convertAndSend("judge.exchange", "judge.routing", task);
    }
}

// 消费者 - 处理评测任务
@Component
public class JudgeConsumer {
    @RabbitListener(queues = "judge.queue")
    public void handleJudgeTask(JudgeTask task) {
        // 1. 加载测试用例
        // 2. 调用 Go-Judge 评测
        // 3. 保存评测结果
        // 4. 通过 WebSocket 推送结果
    }
}
```

### 7.2 RabbitMQ 配置

```java
@Configuration
public class RabbitMQConfig {
    @Bean
    public Queue judgeQueue() {
        return new Queue("judge.queue", true);
    }
    
    @Bean
    public DirectExchange judgeExchange() {
        return new DirectExchange("judge.exchange");
    }
    
    @Bean
    public Binding judgeBinding() {
        return BindingBuilder.bind(judgeQueue())
            .to(judgeExchange())
            .with("judge.routing");
    }
}
```

## 8. 缓存策略

### 8.1 Redis 使用

```java
@Service
public class RedisService {
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // 设置缓存
    public void set(String key, String value, long timeout, TimeUnit unit) {
        redisTemplate.opsForValue().set(key, value, timeout, unit);
    }
    
    // 获取缓存
    public String get(String key) {
        return redisTemplate.opsForValue().get(key);
    }
    
    // 删除缓存
    public void delete(String key) {
        redisTemplate.delete(key);
    }
}
```

### 8.2 缓存Key规范

| Key模式 | 说明 | 过期时间 |
|---------|------|----------|
| `user:permissions:{userId}` | 用户权限 | 30分钟 |
| `user:roles:{userId}` | 用户角色 | 30分钟 |
| `email:code:{email}` | 邮箱验证码 | 5分钟 |
| `testcase:{problemId}` | 测试用例 | 1小时 |
| `token:blacklist:{token}` | Token黑名单 | 24小时 |

## 9. 异常处理

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        return Result.Error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(PermissionException.class)
    public Result<Void> handlePermissionException(PermissionException e) {
        return Result.Error(403, "权限不足");
    }
    
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("系统异常", e);
        return Result.Error(500, "系统内部错误");
    }
}
```

## 10. 开发规范

### 10.1 命名规范
- Controller：`XxxController`
- Service接口：`XxxService`
- Service实现：`XxxServiceImpl`
- Mapper：`XxxMapper`
- Entity：`Xxx`
- DTO：`XxxDTO`
- VO：`XxxVo`

### 10.2 API响应格式

```java
public class Result<T> {
    private Integer code;    // 状态码：200成功，其他失败
    private String msg;      // 消息
    private T data;          // 数据
    
    public static <T> Result<T> Success(T data) {
        return new Result<>(200, "success", data);
    }
    
    public static <T> Result<T> Error(int code, String msg) {
        return new Result<>(code, msg, null);
    }
}
```

### 10.3 日志规范

```java
@Slf4j
@Service
public class XxxServiceImpl implements XxxService {
    
    public void doSomething() {
        log.info("开始处理...");
        try {
            // 业务逻辑
            log.debug("处理详情: {}", detail);
        } catch (Exception e) {
            log.error("处理失败", e);
            throw new BusinessException("处理失败");
        }
    }
}
```
