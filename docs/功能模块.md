# Vnollx Online Judge 功能模块文档

## 1. 模块总览

| 模块 | 说明 | 核心功能 |
|------|------|----------|
| 用户模块 | 用户管理 | 注册、登录、个人资料、权限 |
| 题目模块 | 题目管理 | 题目CRUD、标签、难度分类 |
| 评测模块 | 代码评测 | 代码提交、沙箱评测、结果反馈 |
| 比赛模块 | 比赛管理 | 创建比赛、排名、题目绑定 |
| 练习模块 | 练习管理 | 练习集、题目组织 |
| 题解模块 | 题解分享 | 题解发布、评论、点赞 |
| 社交模块 | 社交功能 | 好友、私信、评论 |
| 通知模块 | 消息通知 | 系统通知、个人消息 |
| AI模块 | 智能助手 | AI对话、代码分析 |
| 权限模块 | 权限控制 | RBAC、角色管理 |

## 2. 用户模块

### 2.1 功能列表

| 功能 | 接口 | 说明 |
|------|------|------|
| 用户注册 | POST `/user/register` | 邮箱注册，验证码验证 |
| 用户登录 | POST `/user/login` | 邮箱+密码登录 |
| 获取个人资料 | GET `/user/profile` | 获取当前用户信息 |
| 更新资料 | PUT `/user/profile` | 修改用户名、头像等 |
| 修改密码 | PUT `/user/password` | 修改登录密码 |
| 忘记密码 | POST `/user/forgot-password` | 邮箱重置密码 |
| 用户排行 | GET `/user/ranklist` | 按通过题数排名 |
| 查看用户 | GET `/user/{id}` | 查看其他用户资料 |

### 2.2 用户身份

| 身份 | 说明 | 权限范围 |
|------|------|----------|
| USER | 普通用户 | 查看题目、提交代码、参加比赛 |
| ADMIN | 管理员 | 管理题目、比赛、用户 |
| SUPER_ADMIN | 超级管理员 | 所有权限，系统配置 |

### 2.3 数据模型

```
User
├── id: Long              # 用户ID
├── name: String          # 用户名
├── email: String         # 邮箱（唯一）
├── password: String      # 密码（BCrypt加密）
├── identity: String      # 身份标识
├── avatar: String        # 头像URL
├── submitCount: Integer  # 提交次数
├── passCount: Integer    # 通过数
├── createTime: DateTime  # 注册时间
└── lastLoginTime: DateTime # 最后登录时间
```

## 3. 题目模块

### 3.1 功能列表

| 功能 | 接口 | 说明 |
|------|------|------|
| 题目列表 | GET `/problem/list` | 分页、筛选、搜索 |
| 题目详情 | GET `/problem/{id}` | 获取题目完整信息 |
| 创建题目 | POST `/admin/problem/create` | 管理员创建 |
| 更新题目 | PUT `/admin/problem/update` | 管理员修改 |
| 删除题目 | DELETE `/admin/problem/{id}` | 管理员删除 |
| 上传测试用例 | POST `/admin/problem/testcase` | 上传测试数据 |

### 3.2 题目难度

| 等级 | 值 | 说明 |
|------|-----|------|
| 入门 | 1 | 基础语法题 |
| 简单 | 2 | 简单算法题 |
| 中等 | 3 | 常规算法题 |
| 困难 | 4 | 复杂算法题 |
| 专家 | 5 | 竞赛级难题 |

### 3.3 数据模型

```
Problem
├── id: Long              # 题目ID
├── title: String         # 标题
├── description: String   # 题目描述（Markdown）
├── inputFormat: String   # 输入格式
├── outputFormat: String  # 输出格式
├── sampleInput: String   # 样例输入
├── sampleOutput: String  # 样例输出
├── hint: String          # 提示
├── difficulty: Integer   # 难度 1-5
├── timeLimit: Integer    # 时间限制（ms）
├── memoryLimit: Integer  # 内存限制（MB）
├── submitCount: Integer  # 提交次数
├── acceptCount: Integer  # 通过次数
└── createTime: DateTime  # 创建时间

ProblemTag（题目-标签关联）
├── problemId: Long       # 题目ID
└── tagId: Long           # 标签ID
```

## 4. 评测模块

### 4.1 功能列表

| 功能 | 接口 | 说明 |
|------|------|------|
| 提交代码 | POST `/judge/submit` | 提交代码评测 |
| 提交记录 | GET `/submission/list` | 查看提交历史 |
| 提交详情 | GET `/submission/{id}` | 查看详细结果 |
| 重新评测 | POST `/admin/submission/rejudge` | 管理员重测 |

### 4.2 评测状态

| 状态 | 说明 |
|------|------|
| Pending | 等待评测 |
| Judging | 评测中 |
| Accepted (AC) | 通过 |
| Wrong Answer (WA) | 答案错误 |
| Time Limit Exceeded (TLE) | 超时 |
| Memory Limit Exceeded (MLE) | 内存超限 |
| Runtime Error (RE) | 运行错误 |
| Compile Error (CE) | 编译错误 |
| System Error (SE) | 系统错误 |

### 4.3 支持语言

| 语言 | 编译/运行命令 | 文件扩展名 |
|------|---------------|------------|
| C | gcc -O2 -o main main.c | .c |
| C++ | g++ -O2 -std=c++17 -o main main.cpp | .cpp |
| Java | javac Main.java && java Main | .java |
| Python | python3 main.py | .py |
| JavaScript | node main.js | .js |
| Go | go run main.go | .go |

### 4.4 评测流程

```
1. 用户提交代码
       ↓
2. 创建 Submission 记录（状态：Pending）
       ↓
3. 发送评测任务到 RabbitMQ
       ↓
4. JudgeConsumer 消费任务
       ↓
5. 从 MinIO 加载测试用例
       ↓
6. 调用 Go-Judge API 执行评测
       ↓
7. 收集评测结果（时间、内存、输出）
       ↓
8. 比对输出，判定结果
       ↓
9. 更新 Submission 状态
       ↓
10. 通过 WebSocket 推送结果
```

### 4.5 数据模型

```
Submission
├── id: Long              # 提交ID
├── userId: Long          # 用户ID
├── problemId: Long       # 题目ID
├── competitionId: Long   # 比赛ID（可选）
├── code: Text            # 源代码
├── language: String      # 编程语言
├── status: String        # 评测状态
├── timeUsed: Integer     # 运行时间（ms）
├── memoryUsed: Integer   # 使用内存（KB）
├── errorInfo: Text       # 错误信息
└── submitTime: DateTime  # 提交时间

JudgeInfo
├── testcaseId: Integer   # 测试点编号
├── status: String        # 测试点状态
├── timeUsed: Integer     # 运行时间
├── memoryUsed: Integer   # 使用内存
└── output: Text          # 程序输出
```

## 5. 比赛模块

### 5.1 功能列表

| 功能 | 接口 | 说明 |
|------|------|------|
| 比赛列表 | GET `/competition/list` | 查看所有比赛 |
| 比赛详情 | GET `/competition/{id}` | 获取比赛信息 |
| 创建比赛 | POST `/admin/competition/create` | 管理员创建 |
| 更新比赛 | PUT `/admin/competition/update` | 修改比赛信息 |
| 添加题目 | POST `/admin/competition/problem` | 绑定题目 |
| 比赛排名 | GET `/competition/{id}/ranklist` | 实时排名 |
| 加入比赛 | POST `/competition/{id}/join` | 报名参赛 |

### 5.2 比赛状态

| 状态 | 值 | 说明 |
|------|-----|------|
| 未开始 | 0 | 当前时间 < 开始时间 |
| 进行中 | 1 | 开始时间 ≤ 当前时间 < 结束时间 |
| 已结束 | 2 | 当前时间 ≥ 结束时间 |

### 5.3 排名规则

- 按通过题目数量降序排列
- 题目数量相同时，按罚时升序排列
- 罚时 = 首次通过时间 + (错误提交次数 × 20分钟)

### 5.4 数据模型

```
Competition
├── id: Long              # 比赛ID
├── title: String         # 比赛标题
├── description: Text     # 比赛描述
├── startTime: DateTime   # 开始时间
├── endTime: DateTime     # 结束时间
├── password: String      # 比赛密码（可选）
├── status: Integer       # 比赛状态
└── createTime: DateTime  # 创建时间

CompetitionProblem（比赛-题目关联）
├── competitionId: Long   # 比赛ID
├── problemId: Long       # 题目ID
└── problemOrder: String  # 题目序号（A, B, C...）

CompetitionUser（比赛-用户关联）
├── competitionId: Long   # 比赛ID
├── userId: Long          # 用户ID
└── joinTime: DateTime    # 加入时间
```

## 6. 练习模块

### 6.1 功能列表

| 功能 | 接口 | 说明 |
|------|------|------|
| 练习列表 | GET `/practice/list` | 查看所有练习 |
| 练习详情 | GET `/practice/{id}` | 获取练习信息 |
| 创建练习 | POST `/admin/practice/create` | 管理员创建 |
| 添加题目 | POST `/admin/practice/problem` | 绑定题目 |

### 6.2 数据模型

```
Practice
├── id: Long              # 练习ID
├── title: String         # 练习标题
├── description: Text     # 练习描述
└── createTime: DateTime  # 创建时间

PracticeProblem（练习-题目关联）
├── practiceId: Long      # 练习ID
├── problemId: Long       # 题目ID
└── problemOrder: Integer # 题目序号
```

## 7. 题解模块

### 7.1 功能列表

| 功能 | 接口 | 说明 |
|------|------|------|
| 题解列表 | GET `/solve/list` | 查看题解列表 |
| 题解详情 | GET `/solve/{id}` | 查看题解内容 |
| 发布题解 | POST `/solve/create` | 发布新题解 |
| 更新题解 | PUT `/solve/update` | 修改题解 |
| 删除题解 | DELETE `/solve/{id}` | 删除题解 |
| 点赞题解 | POST `/solve/{id}/like` | 点赞/取消点赞 |

### 7.2 数据模型

```
Solve
├── id: Long              # 题解ID
├── userId: Long          # 作者ID
├── problemId: Long       # 题目ID
├── title: String         # 题解标题
├── content: Text         # 题解内容（Markdown）
├── likeCount: Integer    # 点赞数
├── viewCount: Integer    # 浏览量
└── createTime: DateTime  # 发布时间
```

## 8. 社交模块

### 8.1 好友功能

| 功能 | 接口 | 说明 |
|------|------|------|
| 搜索用户 | GET `/friend/search` | 搜索添加好友 |
| 发送好友请求 | POST `/friend/request` | 发起好友申请 |
| 处理好友请求 | PUT `/friend/request/{id}` | 接受/拒绝 |
| 好友列表 | GET `/friend/list` | 我的好友 |
| 删除好友 | DELETE `/friend/{id}` | 解除好友关系 |

### 8.2 私信功能

| 功能 | 接口 | 说明 |
|------|------|------|
| 发送私信 | POST `/friend/message` | 发送消息 |
| 消息列表 | GET `/friend/messages` | 获取聊天记录 |
| 会话列表 | GET `/friend/conversations` | 获取会话列表 |

### 8.3 评论功能

| 功能 | 接口 | 说明 |
|------|------|------|
| 发布评论 | POST `/comment/publish` | 发表评论 |
| 评论列表 | GET `/comment/list` | 获取评论列表 |
| 删除评论 | DELETE `/comment/{id}` | 删除评论 |

### 8.4 数据模型

```
Friend
├── id: Long              # 记录ID
├── userId: Long          # 用户ID
├── friendId: Long        # 好友ID
├── status: Integer       # 状态：0-待确认，1-已同意
└── createTime: DateTime  # 创建时间

PrivateMessage
├── id: Long              # 消息ID
├── senderId: Long        # 发送者ID
├── receiverId: Long      # 接收者ID
├── content: Text         # 消息内容
├── isRead: Boolean       # 是否已读
└── createTime: DateTime  # 发送时间

Comment
├── id: Long              # 评论ID
├── userId: Long          # 评论者ID
├── targetType: String    # 目标类型（solve, problem...）
├── targetId: Long        # 目标ID
├── content: Text         # 评论内容
├── parentId: Long        # 父评论ID（可选）
└── createTime: DateTime  # 评论时间
```

## 9. 通知模块

### 9.1 功能列表

| 功能 | 接口 | 说明 |
|------|------|------|
| 通知列表 | GET `/notification/list` | 我的通知 |
| 通知详情 | GET `/notification/{id}` | 通知内容 |
| 标记已读 | PUT `/notification/{id}/read` | 标记为已读 |
| 删除通知 | DELETE `/notification/{id}` | 删除通知 |
| 未读数量 | GET `/notification/count` | 未读通知数 |

### 9.2 通知类型

| 类型 | 说明 |
|------|------|
| SYSTEM | 系统通知 |
| FRIEND_REQUEST | 好友请求 |
| FRIEND_ACCEPT | 好友接受 |
| COMMENT | 评论通知 |
| LIKE | 点赞通知 |
| COMPETITION | 比赛通知 |

### 9.3 数据模型

```
Notification
├── id: Long              # 通知ID
├── userId: Long          # 接收者ID
├── type: String          # 通知类型
├── title: String         # 通知标题
├── content: Text         # 通知内容
├── isRead: Boolean       # 是否已读
└── createTime: DateTime  # 创建时间
```

## 10. AI模块

### 10.1 功能列表

| 功能 | 接口 | 说明 |
|------|------|------|
| AI对话 | POST `/ai/chat` | 与AI助手对话 |
| 代码分析 | POST `/ai/analyze` | 分析代码问题 |
| AI配置 | GET `/admin/ai/config` | 获取AI配置 |
| 更新配置 | PUT `/admin/ai/config` | 修改AI配置 |

### 10.2 支持的AI模型

| 模型 | 说明 |
|------|------|
| qwen3-max | 通义千问 |
| gpt-4 | OpenAI GPT-4 |
| gemini-pro | Google Gemini |

### 10.3 AI功能场景

- **代码解释**：解释代码逻辑
- **错误分析**：分析编译/运行错误
- **算法提示**：给出解题思路
- **代码优化**：建议优化方案

## 11. 权限模块

### 11.1 RBAC模型

```
用户 (User) ─── 拥有 ──→ 角色 (Role) ─── 包含 ──→ 权限 (Permission)
     │                      │                         │
     └── user_role表 ───────┘                         │
                            └─── role_permission表 ───┘
```

### 11.2 角色定义

| 角色 | 代码 | 说明 |
|------|------|------|
| 访客 | GUEST | 未登录用户 |
| 普通用户 | USER | 已注册用户 |
| 管理员 | ADMIN | 系统管理员 |
| 超级管理员 | SUPER_ADMIN | 最高权限 |

### 11.3 权限列表

| 模块 | 权限码 | 说明 |
|------|--------|------|
| 题目 | problem:view | 查看题目 |
| 题目 | problem:create | 创建题目 |
| 题目 | problem:update | 修改题目 |
| 题目 | problem:delete | 删除题目 |
| 用户 | user:view | 查看用户 |
| 用户 | user:manage | 管理用户 |
| 比赛 | competition:view | 查看比赛 |
| 比赛 | competition:create | 创建比赛 |
| 提交 | submission:view | 查看提交 |
| 提交 | submission:submit | 提交代码 |
| 权限 | permission:assign | 分配权限 |
| 系统 | system:settings | 系统设置 |

### 11.4 权限管理接口

| 功能 | 接口 | 说明 |
|------|------|------|
| 角色列表 | GET `/admin/permission/roles` | 获取所有角色 |
| 权限列表 | GET `/admin/permission/permissions` | 获取所有权限 |
| 用户角色 | GET `/admin/permission/user/{id}/roles` | 用户的角色 |
| 分配角色 | POST `/admin/permission/user/{id}/role/{roleId}` | 给用户分配角色 |
| 移除角色 | DELETE `/admin/permission/user/{id}/role/{roleId}` | 移除用户角色 |
| 刷新缓存 | POST `/admin/permission/user/{id}/refresh` | 刷新用户权限缓存 |
